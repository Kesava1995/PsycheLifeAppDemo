<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prescription</title>
    <style>
        :root {
            --primary-blue: #A5DCFE;
            --primary-dark: #7ab8e0;
            --text-color: #333;
            --border-color: #e0e0e0;
            --bg-color: #f4f8fb;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        /* Layout for Screen */
        .action-bar { max-width: 210mm; margin: 20px auto; display: flex; justify-content: space-between; }
        .btn {
            padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;
            text-decoration: none; display: inline-block; font-size: 14px; transition: 0.2s;
        }
        .btn-primary { background: var(--primary-dark); color: white; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        
        /* A4 Paper Styling */
        /* A4 Paper Styling */
        .prescription-paper {
            background: white; width: 210mm; min-height: 297mm; margin: 0 auto;
            padding: 15mm; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .rx-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 20px; }
        .hospital-info h1 { font-size: 22pt; margin: 0; color: var(--primary-dark); text-transform: uppercase; }
        .hospital-info p { margin: 4px 0; font-size: 10pt; color: #555; }
        .doctor-info { text-align: right; font-size: 10pt; }
        
        /* Patient Box */
        .patient-info-box {
            display: flex; border: 1px solid #000; padding: 10px; margin-bottom: 20px; font-size: 11pt;
        }
        .info-left { flex: 1.5; border-right: 1px solid #000; padding-right: 15px; }
        .info-right { flex: 1; padding-left: 15px; }
        .info-row { margin-bottom: 5px; }
        
        /* Clinical Details Section (CC, SE, MSE) */
        .clinical-section { margin-bottom: 20px; font-size: 10pt; border-bottom: 1px dashed #ddd; padding-bottom: 10px; }
        .clinical-row { display: flex; margin-bottom: 8px; }
        .clinical-label { font-weight: bold; width: 140px; flex-shrink: 0; }
        .clinical-data { flex: 1; }
        .mse-group { display: inline-block; margin-right: 15px; }
        .mse-group span { font-weight: 600; text-decoration: underline; font-size: 10pt; }

        /* Rx Table */
        .rx-table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-bottom: 20px; }
        .rx-table th { border-bottom: 2px solid #000; padding: 8px; text-align: left; background: #f9f9f9; }
        .rx-table td { border-bottom: 1px solid #ddd; padding: 12px 8px; vertical-align: top; }
        .rx-table tr {
            page-break-inside: avoid;
        }
        
        /* Footer */
        .rx-footer {
            margin-top: auto;
            display: flex; justify-content: space-between; align-items: flex-end;
            font-size: 9pt; border-top: 1px solid #000; padding-top: 10px;
            page-break-inside: avoid;
        }
        
        /* Print Rules */
        @media print {
            /* 1. Set margin to 0 to completely erase the browser Date, Time, and URLs */
            @page {
                size: A4;
                margin: 0mm; 
            }
            
            /* 2. Add the margin back to the body so the text doesn't touch the physical edge of the paper */
            body { 
                background: white; 
                margin: 15mm; /* Safe printing margin */
            }
            
            .action-bar { display: none; }
            
            .prescription-paper { 
                box-shadow: none; 
                margin: 0; 
                width: 100%; 
                min-height: auto; 
                padding: 0; 
                display: flex; 
                flex-direction: column;
            }

            .rx-table tr {
                page-break-inside: avoid;
            }

            .rx-footer {
                page-break-inside: avoid;
                break-inside: avoid;
                margin-top: auto; /* Keeps it neatly at the bottom */
            }
        }
    </style>
</head>
<body>

    <div class="action-bar">
        <a href="{{ url_for('first_visit') }}" class="btn btn-secondary">‚Üê Back to First Visit</a>
        <button onclick="window.print()" class="btn btn-primary">üñ® Print / Save as PDF</button>
    </div>

    <div class="prescription-paper">
        <div class="rx-header">
            <div class="hospital-info">
                <h1>{{ guest_doctor.clinic if guest else (patient.doctor.clinic_name or "") }}</h1>
                <p>{{ guest_doctor.address if guest else (patient.doctor.address_text or "") }}</p>
                <p>{{ guest_doctor.phone if guest else (patient.doctor.phone or "") }}</p>
            </div>
            <div class="doctor-info">
                <p><strong>Dr. {{ guest_doctor.name if guest else (patient.doctor.full_name or session.get('username')|title) }}</strong></p>
                <p>{{ guest_doctor.qualification if guest else "MBBS, MD (Psychiatry)" }}</p>
                <p>Reg: {{ guest_doctor.registration if guest else (patient.doctor.kmc_code or "") }}</p>
            </div>
        </div>

        <div class="patient-info-box">
            <div class="info-left">
                <div class="info-row"><strong>Name:</strong> {{ guest_patient.name if guest else patient.name }}</div>
                <div class="info-row"><strong>Age/Sex:</strong> {{ guest_patient.age if guest else patient.age }} / {{ guest_patient.sex if guest else patient.sex }}</div>
                <div class="info-row"><strong>Address:</strong> {{ guest_patient.address if guest else patient.address }}</div>
            </div>
            <div class="info-right">
                <div class="info-row"><strong>Date:</strong> {{ visit.date.strftime('%d-%m-%Y') if visit.date else "" }}</div>
                <div class="info-row"><strong>Visit ID:</strong> #{{ visit.id if not guest else "" }}</div>
                
                {% if visit.next_visit_date %}
                <div class="info-row" style="margin-top: 5px; color: #d9534f;">
                    <strong>Next Follow-up:</strong> {{ visit.next_visit_date.strftime('%d-%m-%Y') }}
                </div>
                {% endif %}
            </div>
        </div>

        {% if visit.symptom_entries or visit.side_effect_entries or visit.mse_entries %}
        <div class="clinical-section">
            
            {% if visit.symptom_entries %}
            <div class="clinical-row">
                <div class="clinical-label">Chief Complaints:</div>
                <div class="clinical-data">
                    {% for s in visit.symptom_entries %}
                        {{ s.symptom_name }}{% if s.duration_text %} x {{ s.duration_text }}{% endif %}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if visit.side_effect_entries %}
            <div class="clinical-row">
                <div class="clinical-label">Side Effects:</div>
                <div class="clinical-data">
                    {% for s in visit.side_effect_entries %}
                        {{ s.side_effect_name }}{% if s.duration_text %} x {{ s.duration_text }}{% endif %}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if visit.mse_entries %}
                {# Filter MSE entries manually using Jinja #}
                {% set thoughts = [] %}
                {% set perceptions = [] %}
                {% set affects = [] %}

                {% for m in visit.mse_entries %}
                    {% if m.category == 'Thought' %}{% set _ = thoughts.append(m.finding_name) %}{% endif %}
                    {% if m.category == 'Perception' %}{% set _ = perceptions.append(m.finding_name) %}{% endif %}
                    {% if m.category == 'Affect' %}{% set _ = affects.append(m.finding_name) %}{% endif %}
                {% endfor %}

                {% if thoughts or perceptions or affects %}
                <div class="clinical-row">
                    <div class="clinical-label">MSE Findings:</div>
                    <div class="clinical-data">
                        {% if thoughts %}
                            <div class="mse-group"><span>Thought:</span> {{ thoughts|join(', ') }}</div>
                        {% endif %}
                        {% if perceptions %}
                            <div class="mse-group"><span>Perception:</span> {{ perceptions|join(', ') }}</div>
                        {% endif %}
                        {% if affects %}
                            <div class="mse-group"><span>Affect:</span> {{ affects|join(', ') }}</div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% endif %}

        </div>
        {% endif %}
        {% if visit.safety_profile and (visit.safety_profile.drug_allergies or visit.safety_profile.medical_comorbidities or visit.safety_profile.non_psychiatric_meds) %}
        <div class="clinical-row" style="flex-direction: column;">
            <div class="clinical-label" style="width: 100%; ">Safety & Medical Profile:</div>
            <div class="clinical-data" style="padding-left: 10px;">
                {% if visit.safety_profile.drug_allergies %}
                    <div class="mse-group"><span>Allergies:</span> {{ visit.safety_profile.drug_allergies }}</div>
                {% endif %}
                {% if visit.safety_profile.medical_comorbidities %}
                    <div class="mse-group"><span>Comorbidities:</span> {{ visit.safety_profile.medical_comorbidities }}</div>
                {% endif %}
                {% if visit.safety_profile.non_psychiatric_meds %}
                    <div class="mse-group"><span>Non-Psych Meds:</span> {{ visit.safety_profile.non_psychiatric_meds }}</div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% if visit.provisional_diagnosis %}
        <div style="margin-bottom: 20px; font-weight: bold;">
            <span style="font-size: 12pt;">Dx:</span> 
            <span style="font-size: 11pt; margin-left: 10px;">{{ visit.provisional_diagnosis }}</span>
        </div>
        {% endif %}

        <table class="rx-table">
            <thead>
                <tr>
                    <th style="width: 5%;">S.No</th>
                    <th style="width: 40%;">Medicine</th>
                    <th style="width: 35%;">Frequency & Instructions</th>
                    <th style="width: 20%;">Duration</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in visit.medication_entries %}
                {% if entry.is_tapering and entry.taper_plan %}
                    {% set plan = entry.taper_plan|from_json %}
                    {% set plan_length = plan|length %}
                    {% set outer_index = loop.index %}
                    
                    {% for step in plan %}
                    <tr>
                        {% if loop.first %}
                        <td rowspan="{{ plan_length + 1 }}" style="vertical-align: top;">{{ outer_index }}</td>
                        <td rowspan="{{ plan_length + 1 }}" style="vertical-align: top;">
                            <div style="font-size: 12pt;">
                                <!--{% if entry.drug_type == 'Gen' or entry.drug_type == 'Generic' %}<span style="font-weight: bold; font-size: 7pt;">[Generic]</span> {% endif %}-->
							{% if entry.form_type %}
                            <div style="font-weight: bold; font-size: 8pt; color: #555; margin-top: 4px;">{{ entry.form_type }} <span style="font-weight: normal; font-size: 12pt;">{{ entry.drug_name }}</span></div>
							{% else %}
							<div style="font-weight: bold; font-size: 12pt; color: #555; margin-top: 4px;">{{ entry.drug_name }}</div>
                            {% endif %}
                            </div>
							<!--
                            {% if entry.form_type %}
                            <div style="font-weight: bold; font-size: 8pt; color: #555; margin-top: 4px;">({{ entry.form_type }})</div>
                            {% endif %}-->
                        </td>
                        {% endif %}
                        
                        <td style="vertical-align: top; {% if not loop.last %}border-bottom: 1px dashed #e0e0e0;{% endif %}">
                            <div style="font-size: 9.5pt;">
                                Take {% if step.dose_mg %}{{ step.dose_mg }} {{ entry.form_type }} - {% endif %}{{ format_frequency(step.frequency) }}{% if loop.last %},{% endif %}
                            </div>
                            {% if step.note %}
                            <div style="font-style: italic; font-size: 10pt; margin-top: 2px;">({{ step.note }})</div>
                            {% endif %}
                        </td>
                        
                        <td style="vertical-align: top; {% if not loop.last %}border-bottom: 1px dashed #e0e0e0;{% endif %}">
                            <div style="font-size: 9.5pt;">{{ step.duration_text }}</div>
                        </td>
                    </tr>
                    {% endfor %}
                    
                    <tr>
                        <td style="vertical-align: top; padding-top: 4px;">
                            <div style="font-size: 9.5pt;">then stop / review.</div>
                        </td>
                        <td style="vertical-align: top;"></td>
                    </tr>

                {% else %}
                    <tr>
                        <td style="vertical-align: top;">{{ loop.index }}</td>
                        <td style="vertical-align: top;">
                            <div style="font-weight: bold; font-size: 8pt;">
                                {% if entry.drug_type == 'Gen' or entry.drug_type == 'Generic' %}[Generic] {% endif %}{{ entry.drug_name }}
                            </div>
                            {% if entry.form_type %}
                            <div style="font-weight: bold; font-size: 7pt; color: #555; margin-top: 2px;">({{ entry.form_type }})</div>
                            {% endif %}
                        
                        </td>
                        <td style="vertical-align: top;">
                            <div style="font-size: 11pt;">
                                Take {% if entry.dose_mg %}{{ entry.dose_mg }} {{ entry.form_type }} - {% endif %}{{ format_frequency(entry.frequency) }}
                            </div>
                            {% if entry.note %}
                            <div style="font-style: italic; font-size: 10pt; margin-top: 2px;">({{ entry.note }})</div>
                            {% endif %}
                        </td>
                        <td style="vertical-align: top;">{{ entry.duration_text }}</td>
                    </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>

        {% if visit.note %}
        <div style="margin-top: 15px; margin-bottom: 20px; font-size: 10.5pt; padding: 10px; background-color: #fcfcfc; border-left: 3px solid #7ab8e0; border-radius: 4px;">
            <strong>General Visit Note:</strong> {{ visit.note }}
        </div>
        {% endif %}
        <div class="rx-footer">
            <div style="font-size: 8pt; color: #777;">
                <!--Generated by Continuum Psychiatry<br>
                Valid for 3 months unless specified-->
            </div>
            <div style="text-align: right;">
                {% if guest and guest_signature_b64 %}
                    <img src="data:image/png;base64,{{ guest_signature_b64 }}" style="max-height: 50px; display: block; margin-left: auto;">
                {% elif not guest and patient.doctor.signature_filename %}
                    <img src="{{ url_for('static', filename='signatures/' + patient.doctor.signature_filename) }}" style="max-height: 60px; display: block; margin-left: auto;">
                {% else %}
                    <div style="height: 50px;"></div>
                {% endif %}
                <div style="border-top: 1px solid #000; padding-top: 5px; margin-top: 5px; display: inline-block;">
                    <strong>Dr. {{ guest_doctor.name if guest else (patient.doctor.full_name or session.get('username')|title) }}</strong>
                </div>
            </div>
        </div>
    </div>

</body>
</html>