<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>First Visit - Continuum Psychiatry</title>
    <style>
        :root { --primary-blue: #A5DCFE; --primary-dark: #7ab8e0; --bg-color: #f4f8fb; --sidebar-width: 280px; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-color); height: 100vh; overflow: hidden; display: flex; }
        .app-container { display: flex; width: 100%; height: 100%; } 
        .sidebar { width: var(--sidebar-width); background: #fff; border-right: 1px solid #eaecf0; padding: 32px 24px; display: flex; flex-direction: column; flex-shrink: 0; }
        .main-content { flex: 1; overflow-y: auto; padding: 30px; background: var(--primary-blue); }
        .visit-card { background: white; border-radius: 12px; padding: 25px; width: 95%; max-width: 1400px; margin: 0 auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .section-header { display: flex; align-items: center; gap: 15px; margin-top: 25px; margin-bottom: 15px; border-bottom: 2px solid var(--bg-color); padding-bottom: 8px; }
        .section-title { font-size: 1.1rem; font-weight: 600; color: #555; }
        .add-btn { background: var(--primary-dark); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .subsection-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; margin-top: 15px; }
        .subsection-title { font-size: 0.9rem; font-weight: 700; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .entry-wrapper { border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 8px; background: #fafafa; position: relative; }
        /* Update this class in first_visit.html, add_visit.html, and edit_visit.html */
        .row-flex {
            display: flex; 
            gap: 15px; 
            align-items: center; 
            flex-wrap: wrap; /* This enables the wrapping */
        }
        
        /* Slider CSS */
        .sliders-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; flex: 2.5; }
        .slider-group { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .slider-group label { font-size: 10px; color: #666; margin-bottom: 4px; text-transform: uppercase; white-space: nowrap; }
        .slider-wrapper { display: flex; align-items: center; gap: 8px; width: 100%; padding: 0 5px; }
        input[type=range] { -webkit-appearance: none; width: 100%; height: 5px; cursor: pointer; margin: 0; padding: 0; background: #ddd; border-radius: 3px; flex: 1; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--primary-dark); cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .slider-val { font-size: 11px; font-weight: bold; color: #555; width: 20px; text-align: right; }
        
        .note-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #999; }
        .note-input { display: none; width: 100%; margin-top: 8px; padding: 8px; border: 1px dashed #ccc; background-color: #fffdf0; }
        .remove-btn { color: #ff6b6b; background: none; border: none; font-weight: bold; cursor: pointer; font-size: 14px; margin-left: 5px; }
        .btn { padding: 15px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; font-size: 16px; margin-top: 10px; }
        
        .patient-grid { display: grid; gap: 15px; background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px solid #eee; }
        .row-3-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .row-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; }
        
        /* NEW STYLES FOR PHASE 2 */
        .click-trigger-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .click-trigger { 
            flex: 1; 
            padding: 12px; 
            border: 1px dashed #7ab8e0; 
            border-radius: 6px; 
            color: #555; 
            cursor: pointer; 
            background: #fdfdfd; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .click-trigger:hover { background: #f0f8ff; border-color: #4facfe; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 10% auto; padding: 20px; width: 400px; border-radius: 8px; }
        .checklist-group label { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer; }
        .checklist-group input[type="checkbox"] { width: auto; margin: 0; }

        /* Major Events modal: position + checkbox alignment */
        #majorEventsModal .modal-content {
            margin-top: 5% !important;
        }
        .major-event-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        .major-event-group label input[type="checkbox"] {
            margin: 0;
        }
        /* Grid modals (Bootstrap-like row/col) */
        .container-fluid.px-0 { padding-left: 0; padding-right: 0; }
        .row { display: flex; flex-wrap: wrap; margin-left: -6px; margin-right: -6px; }
        .row.align-items-center { align-items: center; }
        .row.border-bottom { border-bottom: 1px solid #e0e0e0; }
        .row.font-weight-bold { font-weight: 700; }
        .col-3, .col-4, .col-5 { padding-left: 6px; padding-right: 6px; box-sizing: border-box; }
        .col-3 { flex: 0 0 25%; max-width: 25%; }
        .col-4 { flex: 0 0 33.333%; max-width: 33.333%; }
        .col-5 { flex: 0 0 41.666%; max-width: 41.666%; }
        .mb-2 { margin-bottom: 8px; }
        .form-check { display: flex; align-items: center; }
        .form-check-input { margin-top: 0; }
        .form-check-label.ml-2 { margin-left: 8px; cursor: pointer; margin-bottom: 0; }
        .form-control, .form-control-sm { width: 100%; padding: 6px 8px; border: 1px solid #e0e0e0; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div style="font-weight:bold; margin-bottom:20px;">Dr. {{ doctor.full_name if doctor and doctor.full_name else 'Doctor' }}</div>
			<div style="display: flex; gap: 15px; margin-bottom: 20px;">
				<a href="{{ url_for('profile') }}" style="text-decoration:none; color:#333; margin-bottom:8px; margin-right:10px;">üë§ Profile</a>
				<a href="{{ url_for('dashboard') }}" style="text-decoration:none; color:#333; margin-bottom:8px;">üè† Dashboard</a>
			</div>
            <input type="text" id="search" placeholder="Search Patients..." onkeyup="filterPatients()" style="width:100%; padding:8px; margin-bottom:10px;">
            <div id="patientList" style="flex:1; overflow-y:auto;">
                {% for p in patients %}
                <a href="{{ url_for('patient_detail', patient_id=p.id) }}" class="patient-item" style="display:block; padding:10px; border-bottom:1px solid #eee; text-decoration:none; color:#333;">
                    <b>{{ p.name }}</b><br><span style="font-size:12px; color:#666;">{{ p.sex }}, {{ p.age }}y</span>
                </a>
                {% endfor %}
            </div>
            <a href="{{ url_for('logout') }}" style="color:red; margin-top:20px; display:block;">Log Out</a>
        </aside>

        <main class="main-content">
            <div class="visit-card">
                <form method="POST" id="visitForm" enctype="multipart/form-data" action="{{ url_for('first_visit') }}">
                    <h2 style="margin-bottom: 20px;">New Registration</h2>
                    <div class="section-header" style="margin-top: 0;"><span class="section-title">Socio-Demographic details</span></div>
                    
                    <div class="patient-grid">
                        <div class="row-2-col">
                            <div><label>Patient Name *</label><input type="text" name="patient_name" required></div>
                            <div><label>Phone</label><input type="text" name="phone"></div>
                        </div>
                        <div class="row-2-col">
                            <div><label>Age *</label><input type="number" name="age" required></div>
                            <div><label>Sex *</label><select name="sex"><option>Male</option><option>Female</option><option>Other</option></select></div>
                        </div>
                        <div><label>Address</label><textarea name="address" rows="1" style="resize: none;"></textarea></div>
                        
                        <div class="row-3-col">
                            <div><label>Attender Name</label><input type="text" name="attender_name"></div>
                            <div>
                                <label>Relation</label>
                                <input type="text" name="attender_relation" id="attender_relation" list="relation-options" oninput="toggleRelationOther(this)" onchange="validateRelation(this)" placeholder="Select or type..." autocomplete="off">
                                <datalist id="relation-options">
                                    <option value="Mother"></option>
                                    <option value="Father"></option>
                                    <option value="Sister"></option>
                                    <option value="Brother"></option>
                                    <option value="Uncle"></option>
                                    <option value="Aunt"></option>
                                    <option value="Friend"></option>
                                    <option value="Brother-in-law"></option>
                                    <option value="Sister-in-law"></option>
                                    <option value="Father-in-law"></option>
                                    <option value="Mother-in-law"></option>
                                    <option value="Others"></option>
                                </datalist>
                                <input type="text" name="attender_relation_other" id="attender_relation_other" style="display:none; margin-top:5px;" placeholder="Specify other relation">
                            </div>
                            <div><label>Reliability</label><select name="attender_reliability"><option>Yes</option><option>No</option></select></div>
                        </div>
                        
                        <div><label>Identification Notes (Doctor Only)</label><textarea name="personal_notes" rows="1" style="resize: none;"></textarea></div>
                        <input type="hidden" name="visit_date" value="{{ today.strftime('%Y-%m-%d') }}">
                    </div>

                    <div class="section-header"><span class="section-title">Background Factors</span></div>
                    <div class="click-trigger-row">
                        <div class="click-trigger" onclick="openModal('stressorsModal')">
                            <span>‚ö†Ô∏è Stressors</span><span>‚ñº</span>
                        </div>
                        <div class="click-trigger" onclick="document.getElementById('modalPers').style.display='block'">
                            <span>üß† Personality</span><span>‚ñº</span>
                        </div>
                        <div class="click-trigger" onclick="openModal('majorEventsModal')">
                            <span>üìå Major Events</span><span>‚ñº</span>
                        </div>
                    </div>
                    <input type="hidden" name="stressors_data" id="stressors_data" value="">
                    <input type="hidden" name="major_events_data" id="major_events_data" value="">

                    <div class="section-header"><span class="section-title">Psychiatric Scales</span></div>
                    <div class="click-trigger-row" style="margin-bottom: 20px;">
                        <div class="click-trigger" onclick="openScalesModal()" style="border-color: #9966FF; background: #fdfdfd;">
                            <span>üìã Select &amp; Mark Scales</span><span id="scales-count-badge" style="background: #9966FF; color: white; border-radius: 10px; padding: 2px 8px; font-size: 12px; display: none;">0 Applied</span><span>‚ñº</span>
                        </div>
                    </div>
                    <input type="hidden" name="scales_data" id="scales_data" value="">

                    <div class="section-header">
                    <span class="section-title">Chief Complaints</span>
                    <button type="button" class="add-btn" onclick="addSymptom()" style="margin-left: 10px;">+</button>
					<button type="button" class="btn" onclick="openTemplatesModal()" style="padding: 5px 15px; font-size: 12px; margin-left: 15px; background: #666; width: auto; line-height: 1;">üìã Templates</button>
            
                </div>
                    <div id="symptoms-container"></div>

                    <div class="section-header">
                        <span class="section-title">Substance Use History</span>
                        <button type="button" class="add-btn" onclick="addSubstance()">+</button>
                    </div>
                    <div id="substances-container">
                        {% if visit and visit.substance_use_entries %}
                            {% for su in visit.substance_use_entries %}
                                <script>window.addEventListener('load', () => addSubstance("{{ su.substance_name }}", "{{ su.pattern }}", "{{ su.start_date.strftime('%Y-%m-%d') if su.start_date else '' }}", "{{ su.end_date.strftime('%Y-%m-%d') if su.end_date else '' }}", "{{ su.note | e }}");</script>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div class="section-header"><span class="section-title">MSE Findings</span></div>
                    <div class="subsection-header"><span class="subsection-title">Thought</span><button type="button" class="add-btn" onclick="addMSE('Thought')">+</button></div>
                    <div id="mse-thought-container"></div>
                    
                    <div class="subsection-header"><span class="subsection-title">Perception</span><button type="button" class="add-btn" onclick="addMSE('Perception')">+</button></div>
                    <div id="mse-perception-container"></div>
                    
                    <div class="subsection-header"><span class="subsection-title">Affect</span><button type="button" class="add-btn" onclick="addMSE('Affect')">+</button></div>
                    <div id="mse-affect-container"></div>

                    <div class="section-header"><span class="section-title">Safety and Medical Profile</span></div>
                    <div class="patient-grid" style="margin-bottom: 20px;">
                        <div class="row-3-col">
                            <div>
                                <label>Drug Allergies/ hypersensitivities</label>
                                <textarea name="drug_allergies" rows="2" style="resize:none;">{{ last_visit.safety_profile.drug_allergies if last_visit and last_visit.safety_profile else (visit.safety_profile.drug_allergies if visit and visit.safety_profile else '') }}</textarea>
                            </div>
                            <div>
                                <label>Medical Comorbidities</label>
                                <textarea name="medical_comorbidities" rows="2" style="resize:none;">{{ last_visit.safety_profile.medical_comorbidities if last_visit and last_visit.safety_profile else (visit.safety_profile.medical_comorbidities if visit and visit.safety_profile else '') }}</textarea>
                            </div>
                            <div>
                                <label>Current Non-Psychiatric Medication</label>
                                <textarea name="non_psychiatric_meds" rows="2" style="resize:none;">{{ last_visit.safety_profile.non_psychiatric_meds if last_visit and last_visit.safety_profile else (visit.safety_profile.non_psychiatric_meds if visit and visit.safety_profile else '') }}</textarea>
                            </div>
                        </div>
                    </div>

                    <div class="section-header"><span class="section-title">Side Effects</span><button type="button" class="add-btn" onclick="addSideEffect()">+</button></div>
                    <div id="side-effects-container"></div>

                    <div style="text-align:center; margin: 30px 0;">
                        {% if is_guest %}
                            <button type="submit" formaction="{{ url_for('guest_lifechart_proxy') }}" class="btn" style="background:var(--primary-dark); width:auto; padding:10px 40px;">üîÑ Update Life Chart (Guest)</button>
                        {% else %}
                            <button type="submit" name="submit_action" value="lifechart" class="btn" style="background:var(--primary-dark); width:auto; padding:10px 40px;">üîÑ Update Life Chart</button>
                        {% endif %}
                    </div>

                    <div class="section-header"><span class="section-title">Diagnosis</span></div>

                    <div style="margin-top:20px; background:#fff; padding:15px; border:1px solid #eee; border-radius:8px;">
                        <div class="row-2-col">
                            <div>
                                <label>Provisional Diagnosis</label>
                                <textarea name="provisional_diagnosis" rows="2"></textarea>
                                <div style="margin-top: 5px; display: flex; gap: 10px;">
                                    <button type="button" class="btn" onclick="showCriteria('ICD')" style="background: #e0e0e0; color: #333; font-size: 11px; padding: 4px 10px; width: auto; border: 1px solid #ccc;">
                                        Show ICD-10
                                    </button>
                                    <button type="button" class="btn" onclick="showCriteria('DSM')" style="background: #e0e0e0; color: #333; font-size: 11px; padding: 4px 10px; width: auto; border: 1px solid #ccc;">
                                        Show DSM-5
                                    </button>
                                </div>
                            </div>
                            <div><label>Differential Diagnosis</label><textarea name="differential_diagnosis" rows="2"></textarea></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <h4 style="margin:0 0 10px 0; color:#555;">Current Clinical State</h4>
                        <button type="button" class="btn" style="margin-top:0; padding:8px 14px; font-size:12px; background:#666; color:#fff;" onclick="openClinicalStateRangesModal()">Manage Clinical State Ranges (dates)</button>
                        <input type="hidden" name="clinical_state_data" id="clinical_state_data" value="">
                    </div>
					
					<div class="section-header" style="flex-wrap: wrap;">
					<span class="section-title">Medications</span>
					<button type="button" class="add-btn" onclick="addMedication()">+</button>
					<button type="button" class="btn" onclick="document.getElementById('modalEqDose').style.display='block'" style="padding: 5px 15px; font-size: 12px; margin-left: 10px; background: #666; color: #fff; width: auto; line-height: 1; flex-shrink: 0; white-space: nowrap;">‚öñÔ∏è Equivalent Dose</button>
				</div>
                <div style="margin-bottom: 15px; display: flex; align-items: center;">
                    <label style="font-size: 13px; font-weight: 600; color: #555; margin-right: 10px; margin-bottom: 0;">Medication Adherence:</label>
                    <button type="button" class="btn" style="margin-left:0; padding:6px 12px; font-size:12px; background:#666; color:#fff; margin-top:0;" onclick="openAdherenceRangesModal()">Manage Adherence Ranges (dates)</button>
                    <input type="hidden" name="adherence_data" id="adherence_data" value="">
                </div>
                    <div id="meds-container"></div>
                    
                    <div style="margin-top: 20px; background:#f9fafb; padding:15px; border-radius:8px; display:flex; gap:20px; align-items:center;">
                        <div>
                            <label>Next Follow-up Date</label>
                            <input type="date" name="next_visit_date" id="nextVisitDate">
                        </div>
                        <div style="flex:1;">
                            <label>General Visit Note</label>
                            <input type="text" name="visit_note" placeholder="Summary...">
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        {% if is_guest %}
                            <button type="button" onclick="openGuestDoctorModal('{{ url_for('guest_prescription') }}')" class="btn" style="flex:1; background:#7BC4F0; color:#000;">üíä Prescription (Guest)</button>
                            <button type="button" onclick="openGuestDoctorModal('{{ url_for('guest_both') }}')" class="btn" style="flex:1; background:#4facfe; color:#fff;">Generate Both (Guest)</button>
                        {% else %}
                            <button type="submit" name="submit_action" value="prescription" class="btn" style="flex:1; background:#7BC4F0; color:#000;">üíä Prescription</button>
                            <button type="submit" name="submit_action" value="both" class="btn" style="flex:1; background:#4facfe; color:#fff;">Generate Both</button>
                        {% endif %}
                    </div>

                    <div id="guestDoctorModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
                        <div style="background:white; padding:30px; border-radius:12px; width:500px; max-height:90vh; overflow-y:auto; text-align:left; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                            <h3 style="margin-top:0; color:#7ab8e0; border-bottom:1px solid #eee; padding-bottom:10px;">Doctor Profile Details</h3>
                            <p style="font-size:12px; color:#666; margin-bottom:20px;">These details are required to generate your prescription header.</p>
                            
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div>
                                    <label style="font-size: 12px; font-weight: bold;">Full Name (as on Prescription) *</label>
                                    <input type="text" name="doc_name" value="{% if guest_doctor %}{{ guest_doctor.name }}{% endif %}" class="form-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px; font-weight: bold;">Qualification *</label>
                                        <input type="text" name="doc_qual" value="{% if guest_doctor %}{{ guest_doctor.qualification }}{% endif %}" class="form-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                                    </div>
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px; font-weight: bold;">Registration Number *</label>
                                        <input type="text" name="doc_reg" value="{% if guest_doctor %}{{ guest_doctor.registration }}{% endif %}" class="form-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; font-weight: bold;">Clinic / Hospital Name</label>
                                    <input type="text" name="doc_clinic" value="{% if guest_doctor %}{{ guest_doctor.clinic }}{% endif %}" class="form-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; font-weight: bold;">Full Clinic Address</label>
                                    <textarea name="doc_address" class="form-input" rows="2" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">{% if guest_doctor %}{{ guest_doctor.address }}{% endif %}</textarea>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px; font-weight: bold;">Phone Number (For Patients)</label>
                                        <input type="text" name="doc_phone" value="{% if guest_doctor %}{{ guest_doctor.phone }}{% endif %}" class="form-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                                    </div>
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px; font-weight: bold;">Email Address</label>
                                        <input type="email" name="doc_email" value="{% if guest_doctor %}{{ guest_doctor.email }}{% endif %}" class="form-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; font-weight: bold;">Social Media Handle (Optional)</label>
                                    <input type="text" name="doc_social" value="{% if guest_doctor %}{{ guest_doctor.social }}{% endif %}" class="form-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                                </div>
                                <div style="margin-top:5px;">
                                    <label style="font-size: 12px; font-weight: bold; color:#d9534f;">Digital Signature (Image) *</label>
                                    {% if guest_signature_b64 %}
                                        <p style="font-size: 11px; color: #2ecc71; margin-bottom: 5px; font-weight: bold;">‚úì Signature already uploaded</p>
                                        <input type="file" name="doc_signature" accept="image/*" style="display:block; font-size:12px;">
                                    {% else %}
                                        <input type="file" name="doc_signature" accept="image/*" style="display:block; margin-top:5px; font-size:12px;">
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div style="display:flex; gap:10px; margin-top:25px;">
                                <button type="button" onclick="closeGuestDoctorModal()" class="btn" style="flex:1; background:#eee; color:#333; font-weight:bold;">Cancel</button>
                                <button type="submit" id="guestModalSubmitBtn" class="btn" style="flex:1; background:#7ab8e0; color:#fff; font-weight:bold;">Proceed</button>
                            </div>
                        </div>
                    </div>

                    <script>
                        function openGuestDoctorModal(actionUrl) {
                            document.getElementById('guestModalSubmitBtn').setAttribute('formaction', actionUrl);
                            document.querySelector('input[name="doc_name"]').required = true;
                            document.querySelector('input[name="doc_qual"]').required = true;
                            document.querySelector('input[name="doc_reg"]').required = true;
                            var sigInput = document.querySelector('input[name="doc_signature"]');
                            var isUploaded = document.querySelector('p[style*="#2ecc71"]');
                            if (sigInput && !isUploaded) sigInput.required = true;
                            document.getElementById('guestDoctorModal').style.display = 'flex';
                        }
                        function closeGuestDoctorModal() {
                            document.querySelector('input[name="doc_name"]').required = false;
                            document.querySelector('input[name="doc_qual"]').required = false;
                            document.querySelector('input[name="doc_reg"]').required = false;
                            var sigInput = document.querySelector('input[name="doc_signature"]');
                            if (sigInput) sigInput.required = false;
                            document.getElementById('guestDoctorModal').style.display = 'none';
                        }
                    </script>

                    <div id="stressorsModal" class="modal" onclick="if(event.target === this) closeModal('stressorsModal')">
                        <div class="modal-content" style="width: 480px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; margin-top: 5vh;">
                            <h4 style="margin-top: 0;">Select Stressors</h4>
                            <div style="overflow-y: auto; flex-grow: 1; padding-right: 10px;">
                                <div class="checklist-group">
                                    <label><input type="checkbox" class="stressor-checkbox" value="Familial or Relationship issues"> Familial or Relationship issues</label>
                                    <label><input type="checkbox" class="stressor-checkbox" value="Loss, Bereavement"> Loss, Bereavement</label>
                                    <label><input type="checkbox" class="stressor-checkbox" value="Divorce / Separation"> Divorce / Separation</label>
                                    <label><input type="checkbox" class="stressor-checkbox" value="Academic/ occupational Stress"> Academic/ occupational Stress</label>
                                    <label><input type="checkbox" class="stressor-checkbox" value="Financial/ Legal"> Financial/ Legal</label>
                                    <label><input type="checkbox" class="stressor-checkbox" value="Medical/ Biological"> Medical/ Biological</label>
                                    <label><input type="checkbox" class="stressor-checkbox" value="Physical or Sexual Violence"> Physical or Sexual Violence</label>
                                    <label><input type="checkbox" class="stressor-checkbox" value="Others ‚Äì Specify"> Others ‚Äì Specify</label>
                                </div>
                                <div id="stressors-inputs-container" style="margin-top:12px;"></div>
                            </div>
                            <div style="margin-top:15px; padding-top:15px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                                <button type="button" class="btn" style="margin-top:0; background:#7ab8e0; color:#fff;" onclick="saveStressors()">Save Stressors</button>
                                <button type="button" class="btn" style="margin-top:0; background:#888; color:#fff;" onclick="closeModal('stressorsModal')">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div id="majorEventsModal" class="modal" onclick="if(event.target === this) closeModal('majorEventsModal')">
                        <div class="modal-content" style="width: 480px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; margin-top: 5vh;">
                            <h4 style="margin-top: 0;">Select Major Events</h4>
                            <div style="overflow-y: auto; flex-grow: 1; padding-right: 10px;">
                                <div class="checklist-group">
                                    <label><input type="checkbox" class="major-event-checkbox" value="Hospitalization"> Hospitalization</label>
                                    <label><input type="checkbox" class="major-event-checkbox" value="Suicide"> Suicide</label>
                                    <label><input type="checkbox" class="major-event-checkbox" value="Major Medication Change"> Major Medication Change</label>
                                    <label><input type="checkbox" class="major-event-checkbox" value="Stoppage of medications"> Stoppage of medications</label>
                                    <label><input type="checkbox" class="major-event-checkbox" value="Marriage"> Marriage</label>
                                    <label><input type="checkbox" class="major-event-checkbox" value="Menarche/ Menopause"> Menarche/ Menopause</label>
                                    <label><input type="checkbox" class="major-event-checkbox" value="ECT or any Intervention given"> ECT or any Intervention given</label>
                                    <label><input type="checkbox" class="major-event-checkbox" value="Major Medical event"> Major Medical event</label>
                                    <label><input type="checkbox" class="major-event-checkbox" value="Legal issues"> Legal issues</label>
                                </div>
                                <div id="major-events-inputs-container" style="margin-top:12px;"></div>
                            </div>
                            <div style="margin-top:15px; padding-top:15px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                                <button type="button" class="btn" style="margin-top:0; background:#7ab8e0; color:#fff;" onclick="saveMajorEvents()">Save Events</button>
                                <button type="button" class="btn" style="margin-top:0; background:#888; color:#fff;" onclick="closeModal('majorEventsModal')">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div id="scalesModal" class="modal" onclick="if(event.target === this) closeModal('scalesModal')">
                        <div class="modal-content" style="width: 600px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; margin-top: 5vh;">
                            <div id="scales-list-view" style="display: flex; flex-direction: column; height: 100%;">
                                <h4 style="margin-top: 0; margin-bottom: 15px;">Psychiatric Scales</h4>
                                <input type="text" id="scale-search" placeholder="Search scales by name..." class="form-control mb-2" onkeyup="filterScales()">
                                <select id="scale-recommended" class="form-control mb-2" onchange="filterScales(this.value)">
                                    <option value="">-- All Recommended Scales --</option>
                                    <option value="CIWA-Ar">Alcohol Withdrawal (CIWA-Ar)</option>
                                    <option value="Y-BOCS">OCD (Y-BOCS)</option>
                                </select>
                                <div id="available-scales-list" style="overflow-y: auto; max-height: 50vh; border: 1px solid #eee; padding: 10px; border-radius: 6px; margin-top: 10px;"></div>
                                <div style="margin-top:15px; padding-top:15px; border-top: 1px solid #eee; text-align: right;">
                                    <button type="button" class="btn" style="margin-top:0; background:#888; color:#fff;" onclick="closeModal('scalesModal')">Done</button>
                                </div>
                            </div>
                            <div id="scale-assessment-view" style="display: none; flex-direction: column; height: 100%;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                                    <button type="button" class="btn" onclick="showScalesList()" style="background: #eee; color: #333; margin: 0; padding: 5px 10px; font-size: 12px;">‚¨Ö Back</button>
                                    <h4 id="active-scale-title" style="margin: 0; color: #4facfe;"></h4>
                                </div>
                                <div id="active-scale-form" style="overflow-y: auto; max-height: 50vh; padding-right: 10px; font-size: 14px; border-bottom: 1px solid #eee;"></div>
                                <div style="margin-top:15px; padding:15px; background: #f0f8ff; border-radius: 6px; text-align: center; border: 1px dashed #7ab8e0;">
                                    <strong style="font-size: 1.2rem; color: #333;">Total Score: <span id="scale-live-score" style="color: #e6194b;">0</span></strong><br>
                                    <span id="scale-live-severity" style="color: #666; font-weight: bold; font-size: 1.1rem;">-</span>
                                </div>
                                <div style="margin-top:15px; padding-top:15px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                                    <button type="button" class="btn" style="margin-top:0; flex: 1; background:#7BC4F0; color:#000;" onclick="saveActiveScale()">Save &amp; Apply to Patient</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="adherenceRangesModal" class="modal" onclick="if(event.target === this) closeAdherenceRangesModal()">
                        <div class="modal-content" style="width: 480px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; margin-top: 5vh;">
                            <h4 style="margin-top: 0;">Adherence Ranges (with dates)</h4>
                            <div style="overflow-y: auto; flex-grow: 1; padding-right: 10px;">
                                <div class="checklist-group">
                                    <label><input type="checkbox" class="adherence-checkbox" value="Complete"> Complete</label>
                                    <label><input type="checkbox" class="adherence-checkbox" value="Partial"> Partial</label>
                                    <label><input type="checkbox" class="adherence-checkbox" value="No Adherence"> No Adherence</label>
                                </div>
                                <div id="adherence-ranges-container" style="margin-top:12px;"></div>
                            </div>
                            <div style="margin-top:15px; padding-top:15px; border-top: 1px solid #eee;">
                                <button type="button" class="btn" style="margin-top:0; background:#888; color:#fff;" onclick="closeAdherenceRangesModal()">Done</button>
                            </div>
                        </div>
                    </div>

                    <div id="clinicalStateRangesModal" class="modal" onclick="if(event.target === this) closeClinicalStateRangesModal()">
                        <div class="modal-content" style="width: 520px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; margin-top: 5vh;">
                            <h4 style="margin-top: 0; color: #333;">Clinical State Ranges</h4>
                            
                            <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                                <strong style="font-size: 13px; color: #555; display:block; margin-bottom: 5px;">Select Diagnoses:</strong>
                                <div class="checklist-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; font-size:12px;" id="diagnosis-checkboxes">
                                    <label><input type="checkbox" value="Bipolar Disorder" onchange="renderClinicalStates()"> Bipolar Disorder (I & II)</label>
                                    <label><input type="checkbox" value="Major Depressive Disorder" onchange="renderClinicalStates()"> Major Depressive Disorder</label>
                                    <label><input type="checkbox" value="Schizophrenia Spectrum" onchange="renderClinicalStates()"> Schizophrenia Spectrum</label>
                                    <label><input type="checkbox" value="Obsessive Compulsive Disorder" onchange="renderClinicalStates()"> Obsessive Compulsive Disorder</label>
                                    <label><input type="checkbox" value="Anxiety Disorders" onchange="renderClinicalStates()"> Anxiety Disorders</label>
                                </div>
                            </div>

                            <div style="overflow-y: auto; flex-grow: 1; padding-right: 10px;">
                                <strong style="font-size: 13px; color: #555; display:block; margin-bottom: 5px;">States:</strong>
                                <div class="checklist-group" id="dynamic-states-container"></div>
                                
                                <div style="margin-top: 10px; display:flex; gap:5px;">
                                    <input type="text" id="customStateInput" placeholder="Custom state..." style="flex:1; padding: 6px; font-size: 12px; border: 1px solid #ccc; border-radius:4px;">
                                    <button type="button" class="btn" style="padding:6px 15px; font-size:12px; margin:0;" onclick="addCustomState()">[+] Add State</button>
                                </div>

                                <div id="clinical-state-ranges-container" style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;"></div>
                            </div>
                            
                            <div style="margin-top:15px; padding-top:15px; border-top: 1px solid #eee;">
                                <button type="button" class="btn" style="margin-top:0; background:#888; color:#fff;" onclick="closeClinicalStateRangesModal()">Done</button>
                            </div>
                        </div>
                    </div>

                    <div id="modalPers" class="modal" onclick="if(event.target == this) this.style.display='none'">
                        <div class="modal-content">
                            <h3>Premorbid Personality</h3>
                            <div class="checklist-group" style="height:200px; overflow-y:auto;">
                                <label><input type="checkbox" name="personality[]" value="Paranoid"> Paranoid</label>
                                <label><input type="checkbox" name="personality[]" value="Schizoid"> Schizoid</label>
                                <label><input type="checkbox" name="personality[]" value="Schizotypal"> Schizotypal</label>
                                <label><input type="checkbox" name="personality[]" value="Antisocial"> Antisocial</label>
                                <label><input type="checkbox" name="personality[]" value="Borderline"> Borderline</label>
                                <label><input type="checkbox" name="personality[]" value="Histrionic"> Histrionic</label>
                                <label><input type="checkbox" name="personality[]" value="Narcissistic"> Narcissistic</label>
                                <label><input type="checkbox" name="personality[]" value="Avoidant"> Avoidant</label>
                                <label><input type="checkbox" name="personality[]" value="Dependent"> Dependent</label>
                                <label><input type="checkbox" name="personality[]" value="Anankastic"> Anankastic</label>
								<label><input type="checkbox" name="personality[]" value="Neuroticism" > Neuroticism</label>
								<label><input type="checkbox" name="personality[]" value="Low Conscientiousness" > Low Conscientiousness</label>
								<label><input type="checkbox" name="personality[]" value="Low Agreeableness" > Low Agreeableness</label>
								<label><input type="checkbox" name="personality[]" value="High Extraversion" > High Extraversion</label>
								<label><input type="checkbox" name="personality[]" value="Low Openness" > Low Openness</label>
								<label><input type="checkbox" name="personality[]" value="High Introversion" > High Introversion</label>
								<label><input type="checkbox" name="personality[]" value="Others" > Others</label>
                            </div>
                            <textarea name="personality_note" placeholder="History Notes on personality..." rows="2" style="margin-top:10px;"></textarea>
                            <button type="button" class="btn" style="margin-top:15px; background-color:#a5dcfe; color:#333;" onclick="document.getElementById('modalPers').style.display='none'">Done</button>
                        </div>
                    </div>

                </form>
            </div>
        </main>
    </div>

    <datalist id="duration-options-list"></datalist>
    <datalist id="freq-options-list">
        <option value="1-0-0">Morning</option>
        <option value="1-0-1">Morning & Night</option>
        <option value="0-0-1">Night</option>
        <option value="1-1-1">Morning, Afternoon & Night</option>
        <option value="0-1-0">Afternoon</option>
        <option value="SOS">As Needed</option>
    </datalist>

    <script>
        function toggleNote(btn) {
            const el = btn.closest('.entry-wrapper').querySelector('.note-input');
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }
        function updVal(slider) { slider.nextElementSibling.innerText = slider.value; }

        function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; if (modalId === 'majorEventsModal') restoreMajorEventsFromHidden(); if (modalId === 'stressorsModal') restoreStressorsFromHidden(); }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        // --- STRESSORS LOGIC (checklist + inputs below, like Clinical State) ---
        document.querySelectorAll('.stressor-checkbox').forEach(function(box) {
            box.addEventListener('change', function() {
                var container = document.getElementById('stressors-inputs-container');
                var safeId = 'st-input-' + this.value.replace(/[^a-zA-Z0-9]/g, '');
                if (this.checked) {
                    var html = '<div id="' + safeId + '" style="background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;">' +
                        '<strong style="font-size: 13px; color: #333;">' + this.value.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</strong>' +
                        '<div style="display: flex; gap: 10px; margin-top: 5px;">' +
                        '<div style="flex: 1;"><input type="text" class="form-control form-control-sm st-duration" placeholder="Duration" list="duration-options-list" oninput="updateDurationOptions(this)"></div>' +
                        '<div style="flex: 2;"><input type="text" class="form-control form-control-sm st-note" placeholder="Note / Details"></div>' +
                        '</div></div>';
                    container.insertAdjacentHTML('beforeend', html);
                } else {
                    var el = document.getElementById(safeId);
                    if (el) el.remove();
                }
            });
        });
        function saveStressors() {
            var data = [];
            document.querySelectorAll('.stressor-checkbox:checked').forEach(function(box) {
                var safeId = 'st-input-' + box.value.replace(/[^a-zA-Z0-9]/g, '');
                var row = document.getElementById(safeId);
                if (row) {
                    data.push({
                        stressor_type: box.value,
                        duration: row.querySelector('.st-duration').value,
                        note: row.querySelector('.st-note').value
                    });
                }
            });
            document.getElementById('stressors_data').value = JSON.stringify(data);
            closeModal('stressorsModal');
        }
        function restoreStressorsFromHidden() {
            document.querySelectorAll('.stressor-checkbox').forEach(function(cb) { cb.checked = false; });
            document.getElementById('stressors-inputs-container').innerHTML = '';
            try {
                var v = document.getElementById('stressors_data').value;
                if (!v) return;
                var list = JSON.parse(v);
                list.forEach(function(st) {
                    var type = st.stressor_type || st;
                    document.querySelectorAll('.stressor-checkbox').forEach(function(cb) {
                        if (cb.value === type) {
                            cb.checked = true;
                            var safeId = 'st-input-' + cb.value.replace(/[^a-zA-Z0-9]/g, '');
                            var container = document.getElementById('stressors-inputs-container');
                            var html = '<div id="' + safeId + '" style="background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;">' +
                                '<strong style="font-size: 13px; color: #333;"></strong>' +
                                '<div style="display: flex; gap: 10px; margin-top: 5px;">' +
                                '<div style="flex: 1;"><input type="text" class="form-control form-control-sm st-duration" placeholder="Duration" list="duration-options-list" oninput="updateDurationOptions(this)"></div>' +
                                '<div style="flex: 2;"><input type="text" class="form-control form-control-sm st-note" placeholder="Note / Details"></div>' +
                                '</div></div>';
                            container.insertAdjacentHTML('beforeend', html);
                            var row = document.getElementById(safeId);
                            row.querySelector('strong').textContent = cb.value;
                            row.querySelector('.st-duration').value = st.duration || '';
                            row.querySelector('.st-note').value = st.note || '';
                        }
                    });
                });
            } catch (e) {}
        }

        // --- MAJOR EVENTS LOGIC (checklist + inputs below) ---
        document.querySelectorAll('.major-event-checkbox').forEach(function(box) {
            box.addEventListener('change', function() {
                var container = document.getElementById('major-events-inputs-container');
                var safeId = 'evt-input-' + this.value.replace(/[^a-zA-Z0-9]/g, '');
                if (this.checked) {
                    var html = '<div id="' + safeId + '" style="background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;">' +
                        '<strong style="font-size: 13px; color: #333;">' + this.value.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</strong>' +
                        '<div style="display: flex; gap: 10px; margin-top: 5px;">' +
                        '<div style="flex: 1;"><input type="text" class="form-control form-control-sm evt-duration" placeholder="Duration" list="duration-options-list" oninput="updateDurationOptions(this)"></div>' +
                        '<div style="flex: 2;"><input type="text" class="form-control form-control-sm evt-note" placeholder="Note"></div>' +
                        '</div></div>';
                    container.insertAdjacentHTML('beforeend', html);
                } else {
                    var el = document.getElementById(safeId);
                    if (el) el.remove();
                }
            });
        });
        function saveMajorEvents() {
            var data = [];
            document.querySelectorAll('.major-event-checkbox:checked').forEach(function(box) {
                var safeId = 'evt-input-' + box.value.replace(/[^a-zA-Z0-9]/g, '');
                var row = document.getElementById(safeId);
                if (row) {
                    data.push({
                        event_type: box.value,
                        duration: row.querySelector('.evt-duration').value,
                        note: row.querySelector('.evt-note').value
                    });
                }
            });
            document.getElementById('major_events_data').value = JSON.stringify(data);
            closeModal('majorEventsModal');
        }
        function restoreMajorEventsFromHidden() {
            document.querySelectorAll('.major-event-checkbox').forEach(function(cb) { cb.checked = false; });
            document.getElementById('major-events-inputs-container').innerHTML = '';
            try {
                var v = document.getElementById('major_events_data').value;
                if (!v) return;
                var list = JSON.parse(v);
                list.forEach(function(evt) {
                    var type = evt.event_type || evt;
                    document.querySelectorAll('.major-event-checkbox').forEach(function(cb) {
                        if (cb.value === type) {
                            cb.checked = true;
                            var safeId = 'evt-input-' + cb.value.replace(/[^a-zA-Z0-9]/g, '');
                            var container = document.getElementById('major-events-inputs-container');
                            var html = '<div id="' + safeId + '" style="background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;">' +
                                '<strong style="font-size: 13px; color: #333;"></strong>' +
                                '<div style="display: flex; gap: 10px; margin-top: 5px;">' +
                                '<div style="flex: 1;"><input type="text" class="form-control form-control-sm evt-duration" placeholder="Duration" list="duration-options-list" oninput="updateDurationOptions(this)"></div>' +
                                '<div style="flex: 2;"><input type="text" class="form-control form-control-sm evt-note" placeholder="Note"></div>' +
                                '</div></div>';
                            container.insertAdjacentHTML('beforeend', html);
                            var row = document.getElementById(safeId);
                            row.querySelector('strong').textContent = cb.value;
                            row.querySelector('.evt-duration').value = evt.duration || '';
                            row.querySelector('.evt-note').value = evt.note || '';
                        }
                    });
                });
            } catch (e) {}
        }
        function bindAdherenceCheckboxes() { document.querySelectorAll('.adherence-checkbox').forEach(cb => { cb.addEventListener('change', function() { const c = document.getElementById('adherence-ranges-container'); const id = 'adherence-range-' + this.value.replace(/\s+/g, '_'); if (this.checked) c.insertAdjacentHTML('beforeend', '<div class="range-group" id="' + id + '" data-status="' + this.value + '"><div class="range-row"><label>Start: <input type="date" class="range-start"></label> <label>End: <input type="date" class="range-end"></label></div><button type="button" class="btn" style="margin-top:6px; padding:4px 10px; font-size:11px; background:#7ab8e0; color:#fff;" onclick="addExtraRange(this)">+ Add another range</button></div>'); else { const g = document.getElementById(id); if (g) g.remove(); } }); }); }
        function addExtraRange(btn) { const group = btn.closest('.range-group'); const row = document.createElement('div'); row.className = 'range-row'; row.innerHTML = '<label>Start: <input type="date" class="range-start"></label> <label>End: <input type="date" class="range-end"></label>'; group.insertBefore(row, btn); }
        function closeAdherenceRangesModal() { const data = []; document.querySelectorAll('#adherence-ranges-container .range-group').forEach(group => { const status = group.getAttribute('data-status'); group.querySelectorAll('.range-row').forEach(row => { const s = row.querySelector('.range-start'), e = row.querySelector('.range-end'); if (s && e) data.push({ status: status, start: s.value || null, end: e.value || null }); }); }); document.getElementById('adherence_data').value = JSON.stringify(data); closeModal('adherenceRangesModal'); }
        function openAdherenceRangesModal() { document.getElementById('adherenceRangesModal').style.display = 'block'; }
        function closeClinicalStateRangesModal() {
            const data = [];
            document.querySelectorAll('#clinical-state-ranges-container > div[id^="csr-input-"]').forEach(div => {
                const strong = div.querySelector('strong');
                const s = div.querySelector('.range-start');
                const e = div.querySelector('.range-end');
                if (strong && s && e) data.push({ state: strong.innerText, start: s.value || null, end: e.value || null });
            });
            document.getElementById('clinical_state_data').value = JSON.stringify(data);
            closeModal('clinicalStateRangesModal');
        }
        function openClinicalStateRangesModal() { document.getElementById('clinicalStateRangesModal').style.display = 'block'; renderClinicalStates(); }

        const stateDB = {
            "Bipolar Disorder": ["Recovery", "Remission", "Partial Remission", "Depressive Episode", "Manic Episode", "Hypomanic Episode", "Mixed Episode", "Relapse", "Loss of Follow-up"],
            "Major Depressive Disorder": ["Recovery", "Remission", "Partial Remission", "Mild Depressive Episode", "Moderate Depressive Episode", "Severe Depressive Episode", "Relapse", "Loss of Follow-up"],
            "Schizophrenia Spectrum": ["Recovery", "Remission", "Partial Remission", "Stable Phase", "Acute Psychotic Episode", "Residual Phase", "Relapse", "Loss of Follow-up"],
            "Obsessive Compulsive Disorder": ["Recovery", "Remission", "Partial Remission", "Active OCD", "Severe OCD", "Treatment Resistant Phase", "Relapse", "Loss of Follow-up"],
            "Anxiety Disorders": ["Recovery", "Remission", "Partial Remission", "Active Anxiety", "Acute Panic Phase", "Relapse", "Loss of Follow-up"]
        };
        let customStates = [];
        function renderClinicalStates() {
            const selectedDiags = Array.from(document.querySelectorAll('#diagnosis-checkboxes input:checked')).map(cb => cb.value);
            let statesToShow = new Set();
            if (selectedDiags.length === 0) {
                ["Recovery", "Remission", "Partial Remission", "Relapse", "Loss of Follow-up"].forEach(s => statesToShow.add(s));
            } else {
                selectedDiags.forEach(d => { if (stateDB[d]) stateDB[d].forEach(s => statesToShow.add(s)); });
            }
            customStates.forEach(s => statesToShow.add(s));
            const container = document.getElementById('dynamic-states-container');
            container.innerHTML = '';
            Array.from(statesToShow).sort().forEach(state => {
                let isCustom = customStates.includes(state);
                let remBtn = isCustom ? '<button type="button" onclick="removeCustomState(\'' + state.replace(/'/g, "\\'") + '\')" style="background:none; border:none; color:red; cursor:pointer; font-weight:bold; margin-left:auto;">[-]</button>' : '';
                let html = '<label style="display:flex; width:100%;"><input type="checkbox" class="clinical-state-checkbox" value="' + state.replace(/"/g, '&quot;') + '" onchange="handleStateCheckboxChange(this)"> <span style="flex:1;">' + state.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span> ' + remBtn + '</label>';
                container.insertAdjacentHTML('beforeend', html);
            });
            let activeStates = Array.from(document.querySelectorAll('#clinical-state-ranges-container div[id^="csr-input-"]')).map(div => { const s = div.querySelector('strong'); return s ? s.innerText : ''; }).filter(Boolean);
            document.querySelectorAll('.clinical-state-checkbox').forEach(cb => { if (activeStates.includes(cb.value)) cb.checked = true; });
        }
        function addCustomState() {
            let val = document.getElementById('customStateInput').value.trim();
            if (val && !customStates.includes(val)) { customStates.push(val); document.getElementById('customStateInput').value = ''; renderClinicalStates(); }
        }
        function removeCustomState(val) { customStates = customStates.filter(s => s !== val); renderClinicalStates(); }
        function handleStateCheckboxChange(cb) {
            var container = document.getElementById('clinical-state-ranges-container');
            var safeId = 'csr-input-' + cb.value.replace(/[^a-zA-Z0-9]/g, '');
            if (cb.checked) {
                var html = '<div id="' + safeId + '" style="background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;"><strong style="font-size: 13px; color: #333;">' + cb.value.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</strong><div style="display: flex; gap: 10px; margin-top: 5px; align-items:center;"><label>Start: <input type="date" class="range-start"></label><label>End: <input type="date" class="range-end"></label></div></div>';
                container.insertAdjacentHTML('beforeend', html);
            } else { var el = document.getElementById(safeId); if (el) el.remove(); }
        }
        function addSubstance(sub, pat, start, end, note) {
            sub = sub || ''; pat = pat || 'Occasional'; start = start || ''; end = end || ''; note = note || '';
            const html = '<div class="entry-wrapper"><div class="row-flex" style="align-items:center; flex-wrap:wrap; gap:10px;">' +
                '<select name="substance_name[]" style="flex:1; min-width:120px; padding:6px; border-radius:4px; border:1px solid #ccc;">' +
                '<option value="Alcohol"' + (sub==='Alcohol'?' selected':'') + '>Alcohol</option>' +
                '<option value="Tobacco (Smoked)"' + (sub==='Tobacco (Smoked)'?' selected':'') + '>Tobacco (Smoked)</option>' +
                '<option value="Smokeless Tobacco"' + (sub==='Smokeless Tobacco'?' selected':'') + '>Smokeless Tobacco</option>' +
                '<option value="Cannabis"' + (sub==='Cannabis'?' selected':'') + '>Cannabis</option>' +
                '<option value="Opioids"' + (sub==='Opioids'?' selected':'') + '>Opioids</option>' +
                '<option value="Stimulants"' + (sub==='Stimulants'?' selected':'') + '>Stimulants</option></select>' +
                '<select name="substance_pattern[]" style="flex:1; min-width:120px; padding:6px; border-radius:4px; border:1px solid #ccc;">' +
                '<option value="Occasional"' + (pat==='Occasional'?' selected':'') + '>Occasional</option>' +
                '<option value="Weekends"' + (pat==='Weekends'?' selected':'') + '>Weekends</option>' +
                '<option value="Daily"' + (pat==='Daily'?' selected':'') + '>Daily</option>' +
                '<option value="Severe/Early morning intake"' + (pat==='Severe/Early morning intake'?' selected':'') + '>Severe/Early morning intake</option></select>' +
                '<label style="display:flex; align-items:center; gap:5px; font-size:12px;">Start: <input type="date" name="substance_start[]" value="' + start + '" style="width:auto; padding:4px; border:1px solid #ccc;"></label>' +
                '<label style="display:flex; align-items:center; gap:5px; font-size:12px;">End: <input type="date" name="substance_end[]" value="' + end + '" style="width:auto; padding:4px; border:1px solid #ccc;"></label>' +
                '<button type="button" class="note-btn" onclick="toggleNote(this)">üìù</button>' +
                '<button type="button" class="remove-btn" onclick="this.closest(\'.entry-wrapper\').remove()">‚úï</button></div>' +
                '<input type="text" class="note-input" name="substance_note[]" value="' + (note || '').replace(/"/g, '&quot;') + '" placeholder="Note..."></div>';
            document.getElementById('substances-container').insertAdjacentHTML('beforeend', html);
        }

        window.addEventListener('load', () => {
            const d = new Date(); d.setDate(d.getDate() + 30);
            document.getElementById('nextVisitDate').value = d.toISOString().split('T')[0];
            addSymptom(); addMedication(); addSideEffect(); addSubstance();
            bindAdherenceCheckboxes();
            renderClinicalStates();
            addMSE('Thought'); addMSE('Perception'); addMSE('Affect');
        });

        // --- SMART DROPDOWN LOGIC ---
        function updateDurationOptions(input) {
            const val = input.value.trim();
            const list = document.getElementById('duration-options-list');
            const num = parseFloat(val);
            if (!isNaN(num) && num > 0) {
                list.innerHTML = '';
                ['days', 'weeks', 'months', 'years'].forEach(unit => {
                    const opt = document.createElement('option');
                    opt.value = `${num} ${unit}`;
                    list.appendChild(opt);
                });
            }
        }

        // --- SMART DOSE DROPDOWN ---
        function updateDoseOptions(input) {
            const val = input.value.trim();
            const match = val.match(/[\d\.]+/);
            if (!match) return;
            const num = match[0];
            const listId = input.getAttribute('list');
            const list = document.getElementById(listId);
            if (!list) return;
            list.innerHTML = '';
            ['mg', 'g', 'Œºg', 'ml', 'IU', 'Tablet'].forEach(unit => {
                const opt = document.createElement('option');
                opt.value = `${num} ${unit}`;
                list.appendChild(opt);
            });
        }

        function toggleRelationOther(inputElement) {
            var otherInput = inputElement.parentElement.querySelector('#attender_relation_other');
            if (inputElement.value === 'Others') {
                otherInput.style.display = 'block';
                otherInput.focus();
            } else {
                otherInput.style.display = 'none';
                otherInput.value = '';
            }
        }
        function validateRelation(inputElement) {
            var listId = inputElement.getAttribute('list');
            var datalist = document.getElementById(listId);
            var options = Array.from(datalist.options).map(function(opt) { return opt.value; });
            options.push('');
            if (!options.includes(inputElement.value)) {
                alert("Please select a relation from the list. If not listed, select 'Others'.");
                inputElement.value = '';
                toggleRelationOther(inputElement);
            }
        }

        function duplicateTaperRow(btn) {
            var currentRow = btn.closest('.entry-wrapper');
            var newRow = currentRow.cloneNode(true);
            var uniqueId = Date.now() + Math.random().toString().slice(2, 6);
            var inputs = newRow.querySelectorAll('input, select, textarea');
            inputs.forEach(function(input) {
                var name = input.getAttribute('name');
                if (name === 'drug_name[]' || name === 'drug_type[]' || name === 'med_form[]') {
                    if (name === 'drug_name[]') {
                        input.readOnly = true;
                        input.style.backgroundColor = '#f0f8ff';
                        input.style.border = '1px dashed #7ab8e0';
                    }
                } else if (name === 'frequency[]') {
                    input.value = '1-0-1';
                } else if (name === 'dose_full[]') {
                    input.value = '';
                    input.setAttribute('list', 'dose-list-' + uniqueId);
                } else {
                    if (input.type === 'text' || input.type === 'hidden' || input.tagName === 'TEXTAREA') input.value = '';
                }
            });
            var datalist = newRow.querySelector('datalist[id^="dose-list-"]');
            if (datalist) {
                datalist.id = 'dose-list-' + uniqueId;
                datalist.innerHTML = '';
            }
            var freqContainer = newRow.querySelector('.freq-container');
            if (freqContainer) {
                freqContainer.innerHTML = '<input type="text" class="freq-box" value="1" style="width:25px; text-align:center; padding:5px 2px;" oninput="handleFreqInput(this)"><span style="margin:0 2px">-</span><input type="text" class="freq-box" value="0" style="width:25px; text-align:center; padding:5px 2px;" oninput="handleFreqInput(this)"><span style="margin:0 2px">-</span><input type="text" class="freq-box" value="1" style="width:25px; text-align:center; padding:5px 2px;" oninput="handleFreqInput(this)">';
            }
            currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
        }

        // --- DYNAMIC FREQUENCY BOXES ---
        function handleFreqInput(input) {
            let val = input.value;
            if (val.toLowerCase() === 'h') {
                input.value = '¬Ω';
            } else if (val.toLowerCase() === 'f') {
                input.value = '¬º';
            } else if (val.length > 1) {
                input.value = val.slice(-1);
                if (input.value.toLowerCase() === 'h') input.value = '¬Ω';
				if (input.value.toLowerCase() === 'f') input.value = '¬º';
            }
            const container = input.closest('.freq-container');
            updateHiddenFreq(container);
            const boxes = Array.from(container.querySelectorAll('.freq-box'));
            const currentIndex = boxes.indexOf(input);
            if (input.value !== '' && currentIndex < boxes.length - 1) {
                boxes[currentIndex + 1].focus();
            }
            if (input === boxes[boxes.length - 1] && input.value !== '') {
                addFreqBox(container.nextElementSibling.querySelector('.add-freq-btn'));
                setTimeout(() => {
                    const newBoxes = container.querySelectorAll('.freq-box');
                    newBoxes[newBoxes.length - 1].focus();
                }, 10);
            }
        }
        function addFreqBox(btn) {
            const wrapper = btn.closest('.entry-wrapper').querySelector('.freq-container');
            const sep = document.createElement('span');
            sep.innerText = '-';
            sep.style.margin = '0 2px';
            wrapper.appendChild(sep);
            const inp = document.createElement('input');
            inp.type = 'text';
            inp.className = 'freq-box';
            inp.style = "width:25px; text-align:center; padding:5px 2px;";
            inp.oninput = function() { handleFreqInput(this); };
            wrapper.appendChild(inp);
            updateHiddenFreq(wrapper);
        }
        function removeFreqBox(btn) {
            const wrapper = btn.closest('.entry-wrapper').querySelector('.freq-container');
            const boxes = wrapper.querySelectorAll('.freq-box');
            const seps = wrapper.querySelectorAll('span');
            if (boxes.length > 1) {
                boxes[boxes.length - 1].remove();
                if (seps.length > 0) seps[seps.length - 1].remove();
                updateHiddenFreq(wrapper);
            }
        }
        function updateHiddenFreq(container) {
            const boxes = container.querySelectorAll('.freq-box');
            const values = Array.from(boxes).map(b => b.value.trim() || '0');
            const hiddenInput = container.parentElement.querySelector('input[name="frequency[]"]');
            if (hiddenInput) hiddenInput.value = values.join('-');
        }

        function createRowHTML(type, cat='') {
            const isMSE = type === 'mse';
            const prefix = isMSE ? 'mse' : type; 
            
            let contentHTML = '';
            
            if (type === 'med') {
                const uniqueId = Date.now() + Math.random(); 
                
                contentHTML = `
                <div style="display:flex; align-items:center; gap:10px; width:100%;">
                    <select name="drug_type[]" style="width:120px; flex:none;">
                        <option value="Gen">Generic</option><option value="Brand">Brand</option>
                    </select>

                    <select name="med_form[]" style="width:120px; flex:none;">
                        <option value="Tablet">Tablet</option>
                        <option value="Capsule">Capsule</option>
                        <option value="Injection">Injection</option>
                    </select>

                    <input type="text" name="drug_name[]" placeholder="Drug Name" style="flex:2; min-width:150px;">
                    
                    <div style="flex:1; min-width:100px;">
                        <input type="text" name="dose_full[]" list="dose-list-${uniqueId}" placeholder="Dose" oninput="updateDoseOptions(this)">
                        <datalist id="dose-list-${uniqueId}"></datalist>
                    </div>
                    
                    <input type="text" list="duration-options-list" name="med_duration[]" placeholder="Duration" style="flex:1; min-width:80px;" oninput="updateDurationOptions(this)">
                    
                    <div style="display:flex; gap:5px; flex:none;">
                        <button type="button" class="btn btn-sm" onclick="duplicateTaperRow(this)" style="padding:5px 10px; border-radius:4px; border:1px dashed #7ab8e0; background:#f0f8ff; color:#555;">+ Taper Step</button>
                        <button type="button" class="note-btn" onclick="toggleNote(this)">üìù</button>
                        <button type="button" class="remove-btn" onclick="this.closest('.entry-wrapper').remove()">‚úï</button>
                    </div>
                </div>

                <div style="display:flex; justify-content:flex-end; align-items:center; margin-top:8px; gap:8px;">
                    <span style="font-size:11px; font-weight:600; color:#888; text-transform:uppercase;">Frequency</span>
                    
                    <input type="hidden" name="frequency[]" value="1-0-1"> 
                    
                    <div class="freq-container" style="display:flex; align-items:center;">
                        <input type="text" class="freq-box" value="1" style="width:25px; text-align:center; padding:5px 2px;" oninput="handleFreqInput(this)">
                        <span style="margin:0 2px">-</span>
                        <input type="text" class="freq-box" value="0" style="width:25px; text-align:center; padding:5px 2px;" oninput="handleFreqInput(this)">
                        <span style="margin:0 2px">-</span>
                        <input type="text" class="freq-box" value="1" style="width:25px; text-align:center; padding:5px 2px;" oninput="handleFreqInput(this)">
                    </div>
                    
                    <div style="display:flex; flex-direction:column; margin-left:2px;">
                        <button type="button" class="add-freq-btn" onclick="addFreqBox(this)" style="font-size:10px; line-height:10px; padding:0 2px; cursor:pointer; margin-bottom:1px;">+</button>
                        <button type="button" onclick="removeFreqBox(this)" style="font-size:10px; line-height:10px; padding:0 2px; cursor:pointer;">-</button>
                    </div>
                </div>`;
            } else {
                // --- OTHER ROWS (Symptoms, SE, MSE) ---
                let slidersHTML = `
                <div class="sliders-container">
                    <div class="slider-group"><label>Severity at Onset</label><div class="slider-wrapper"><input type="range" name="${prefix}_onset[]" min="0" max="10" value="5" oninput="updVal(this)"><span class="slider-val">5</span></div></div>
                    <div class="slider-group"><label>Severity during Course</label><div class="slider-wrapper"><input type="range" name="${prefix}_progression[]" min="0" max="10" value="5" oninput="updVal(this)"><span class="slider-val">5</span></div></div>
                    <div class="slider-group"><label>Current Severity</label><div class="slider-wrapper"><input type="range" name="${prefix}_current[]" min="0" max="10" value="5" oninput="updVal(this)"><span class="slider-val">5</span></div></div>
                </div>`;
                
                let inputName = isMSE ? 
                    `<input type="hidden" name="mse_category[]" value="${cat}"><input type="text" name="mse_finding_name[]" placeholder="Finding..." style="flex:1.5;">` :
                    `<input type="text" name="${prefix}_name[]" placeholder="Name" style="flex:1.5;">`;

                // Single Duration Input with Type Dropdown
                let durationHTML = `<input type="text" list="duration-options-list" name="${prefix}_duration[]" placeholder="Duration" style="flex:0.5; min-width:100px;" oninput="updateDurationOptions(this)">`;

                contentHTML = `
                <div class="row-flex" style="align-items:center;">
                    ${inputName}
                    ${slidersHTML}
                    ${durationHTML}
                    <button type="button" class="note-btn" onclick="toggleNote(this)">üìù</button>
                    <button type="button" class="remove-btn" onclick="this.closest('.entry-wrapper').remove()">‚úï</button>
                </div>`;
            }

            return `<div class="entry-wrapper">${contentHTML}<input type="text" class="note-input" name="${prefix}_note[]" placeholder="History Notes (e.g. After Failure)..."></div>`;
        }

        function addSymptom() { document.getElementById('symptoms-container').insertAdjacentHTML('beforeend', createRowHTML('symptom')); }
        function addMedication() { document.getElementById('meds-container').insertAdjacentHTML('beforeend', createRowHTML('med')); }
        function addSideEffect() { document.getElementById('side-effects-container').insertAdjacentHTML('beforeend', createRowHTML('side_effect')); }
        function addMSE(cat) { 
            const containerId = 'mse-' + cat.toLowerCase() + '-container';
            document.getElementById(containerId).insertAdjacentHTML('beforeend', createRowHTML('mse', cat)); 
        }
        
        function filterPatients() {
            var filter = document.getElementById("search").value.toUpperCase();
            var items = document.getElementsByClassName("patient-item");
            for (var i = 0; i < items.length; i++) {
                items[i].style.display = items[i].innerText.toUpperCase().indexOf(filter) > -1 ? "" : "none";
            }
        }
    </script>

<div id="criteriaModal" class="modal" style="z-index: 9999;">
    <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
        <span class="close-btn" onclick="document.getElementById('criteriaModal').style.display='none'">&times;</span>
        <h3 id="criteriaTitle" style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">Diagnostic Criteria</h3>
        <div id="criteriaBody" style="font-family: 'Segoe UI', sans-serif; font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap;"></div>
    </div>
</div>

<script>
    // --- TEXTBOOK DATA DICTIONARY ---
    // Sources: Kaplan & Sadock (DSM-5), Neeraj Ahuja (ICD-10)
    const diagnosisDB = {
        "depression": {
            "DSM": "DSM-5 Criteria for Major Depressive Disorder:\n\nA. Five (or more) of the following during the same 2-week period; at least one is (1) depressed mood or (2) loss of interest/pleasure:\n1. Depressed mood most of the day, nearly every day.\n2. Markedly diminished interest or pleasure in all, or almost all, activities.\n3. Significant weight loss/gain or decrease/increase in appetite.\n4. Insomnia or hypersomnia nearly every day.\n5. Psychomotor agitation or retardation.\n6. Fatigue or loss of energy.\n7. Feelings of worthlessness or excessive/inappropriate guilt.\n8. Diminished ability to think/concentrate, or indecisiveness.\n9. Recurrent thoughts of death, suicidal ideation.\n\nB. Symptoms cause clinically significant distress or impairment.",
            "ICD": "ICD-10 Criteria for Depressive Episode (F32):\n\nKey Symptoms (At least 2 required):\n1. Depressed mood.\n2. Loss of interest and enjoyment.\n3. Reduced energy leading to increased fatiguability and diminished activity.\n\nAssociated Symptoms (At least 2 others):\n- Reduced concentration and attention\n- Reduced self-esteem and self-confidence\n- Ideas of guilt and unworthiness\n- Bleak and pessimistic views of the future\n- Ideas or acts of self-harm or suicide\n- Disturbed sleep\n- Diminished appetite"
        },
        "schizophrenia": {
            "DSM": "DSM-5 Criteria for Schizophrenia:\n\nA. Two (or more) of the following for 1 month (at least one must be 1, 2, or 3):\n1. Delusions\n2. Hallucinations\n3. Disorganized speech (e.g., frequent derailment or incoherence)\n4. Grossly disorganized or catatonic behavior\n5. Negative symptoms (i.e., diminished emotional expression or avolition)\n\nB. Level of functioning is markedly below the level achieved prior to onset.\nC. Continuous signs of disturbance persist for at least 6 months.",
            "ICD": "ICD-10 Criteria for Schizophrenia (F20):\n\nAt least one very clear symptom from group (a) to (d), OR two from group (e) to (h):\n\n(a) Thought echo, thought insertion or withdrawal, thought broadcasting.\n(b) Delusions of control, influence, or passivity; delusional perception.\n(c) Hallucinatory voices giving a running commentary or discussing the patient.\n(d) Persistent delusions of other kinds that are culturally inappropriate.\n(e) Persistent hallucinations in any modality + fleeting delusions/overvalued ideas.\n(f) Breaks in the train of thought (incoherence/neologisms).\n(g) Catatonic behaviour.\n(h) 'Negative' symptoms (apathy, paucity of speech, blunting of affect)."
        },
        "bipolar": {
            "DSM": "DSM-5 Criteria for Manic Episode (Bipolar I):\n\nA. A distinct period of abnormally and persistently elevated, expansive, or irritable mood and increased activity/energy (lasting at least 1 week).\n\nB. Three (or more) of the following (4 if mood is only irritable):\n1. Inflated self-esteem or grandiosity.\n2. Decreased need for sleep (e.g., feels rested after 3 hours).\n3. More talkative than usual or pressure to keep talking.\n4. Flight of ideas or subjective experience that thoughts are racing.\n5. Distractibility.\n6. Increase in goal-directed activity or psychomotor agitation.\n7. Excessive involvement in activities with painful consequences (e.g., buying sprees).",
            "ICD": "ICD-10 Criteria for Manic Episode (F30):\n\n1. Mood must be predominantly elevated, expansive, or irritable.\n2. At least three symptoms must be present (four if mood is irritable):\n- Increased activity or physical restlessness\n- Increased talkativeness ('pressure of speech')\n- Flight of ideas or subjective experience that thoughts are racing\n- Loss of normal social inhibitions\n- Decreased need for sleep\n- Inflated self-esteem or grandiosity\n- Distractibility or constant changes in activity\n- Foolish or reckless behaviour"
        },
        "anxiety": {
            "DSM": "DSM-5 Criteria for Generalized Anxiety Disorder (GAD):\n\nA. Excessive anxiety and worry occurring more days than not for at least 6 months.\nB. The individual finds it difficult to control the worry.\nC. Associated with three (or more) of the following:\n1. Restlessness or feeling keyed up or on edge.\n2. Being easily fatigued.\n3. Difficulty concentrating or mind going blank.\n4. Irritability.\n5. Muscle tension.\n6. Sleep disturbance.",
            "ICD": "ICD-10 Criteria for Generalized Anxiety Disorder (F41.1):\n\nPrimary symptoms of anxiety most days for at least several weeks/months:\n1. Apprehension (worries about future misfortune, feeling 'on edge', difficulty concentrating).\n2. Motor tension (restless fidgeting, tension headaches, trembling, inability to relax).\n3. Autonomic overactivity (lightheadedness, sweating, tachycardia, tachypnea, epigastric discomfort)."
        }
    };

    function showCriteria(type) {
        // 1. Get the Diagnosis Text
        const textInputs = document.getElementsByName('provisional_diagnosis');
        if (!textInputs.length) return;
        
        // Use the first found input's value
        const rawText = textInputs[0].value.toLowerCase();
        
        if (!rawText.trim()) {
            alert("Please type a diagnosis first (e.g., 'Schizophrenia', 'Depression').");
            return;
        }

        // 2. Simple Keyword Matching
        let matchKey = null;
        if (rawText.includes("depress") || rawText.includes("mdd")) matchKey = "depression";
        else if (rawText.includes("schizo") || rawText.includes("f20")) matchKey = "schizophrenia";
        else if (rawText.includes("bipolar") || rawText.includes("mania") || rawText.includes("manic")) matchKey = "bipolar";
        else if (rawText.includes("anxiet") || rawText.includes("gad") || rawText.includes("panic")) matchKey = "anxiety";
        
        // 3. Populate Modal
        const modal = document.getElementById('criteriaModal');
        const title = document.getElementById('criteriaTitle');
        const body = document.getElementById('criteriaBody');
        
        if (matchKey && diagnosisDB[matchKey]) {
            title.innerText = `${type} Verification: ${matchKey.charAt(0).toUpperCase() + matchKey.slice(1)}`;
            body.innerText = diagnosisDB[matchKey][type];
        } else {
            title.innerText = `${type} Criteria Not Found`;
            body.innerText = "Automatic criteria lookup failed for: '" + rawText + "'.\n\n(This demo supports: Depression, Schizophrenia, Bipolar, Anxiety)";
        }
        
        modal.style.display = 'block';
    }
</script>

<div id="modalTemplates" class="modal" onclick="if(event.target == this) this.style.display='none'">
    <div class="modal-content" style="width: 550px; margin: 5vh auto; max-height: 70vh; overflow-y: auto; padding: 25px;">
        <h3 style="margin-top: 0; margin-bottom: 15px; border-bottom: 2px solid #f4f8fb; padding-bottom: 10px;">Chief Complaint Templates</h3>
        
        <div id="template-list" style="margin-bottom: 20px;">
        </div>
        
        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px dashed #ccc; margin-bottom: 15px;">
            <h4 style="margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #555;">Create / Edit Custom Template</h4>
            
            <input type="text" id="custom-template-name" list="template-name-options" placeholder="Select or type Template Name..." style="margin-bottom: 10px;" oninput="loadTemplateForEdit()">
            <datalist id="template-name-options"></datalist>
            
            <textarea id="custom-template-symptoms" placeholder="Symptoms separated by commas (e.g., Inattention, Hyperactivity, Restlessness)" rows="3" style="resize: vertical;"></textarea>
            <button type="button" class="btn" onclick="saveCustomTemplate()" style="background-color: #a5dcfe; color: #333; padding: 8px 15px; font-size: 13px; margin-top: 10px; width: 100%;">üíæ Save / Update Template</button>
        </div>

        <div style="display: flex; gap: 10px;">
            <button type="button" class="btn" style="flex: 2; background-color: #7BC4F0; color: #000;" onclick="applyTemplates()">‚úÖ Apply Selected Symptoms</button>
            <button type="button" class="btn" style="flex: 1; background-color: #eee; color: #333;" onclick="document.getElementById('modalTemplates').style.display='none'">Close</button>
        </div>
    </div>
</div>

<script>
let currentTemplates = {};

async function fetchTemplates() {
    try {
        const response = await fetch('/api/templates');
        currentTemplates = await response.json();
        renderTemplates(currentTemplates);
    } catch (error) {
        console.error("Error fetching templates:", error);
    }
}

function renderTemplates(templates) {
    const container = document.getElementById('template-list');
    const datalist = document.getElementById('template-name-options');

    container.innerHTML = '';
    datalist.innerHTML = '';

    for (const [name, data] of Object.entries(templates)) {
        const safeId = name.replace(/[^a-zA-Z0-9]/g, '-');

        let badge = '';
        let actionBtn = '';
        if (data.is_modified) {
            badge = `<span style="background: #ffeeba; color: #856404; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 10px;">Modified Default</span>`;
            actionBtn = `<button type="button" onclick="deleteOrRevertTemplate('${name.replace(/'/g, "\\'")}', event)" style="background: none; border: none; color: #d9534f; cursor: pointer; font-size: 12px; margin-right: 15px;">‚Ü© Revert to Default</button>`;
        } else if (!data.is_default) {
            badge = `<span style="background: #d4edda; color: #155724; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 10px;">Custom</span>`;
            actionBtn = `<button type="button" onclick="deleteOrRevertTemplate('${name.replace(/'/g, "\\'")}', event)" style="background: none; border: none; color: #d9534f; cursor: pointer; font-size: 12px; margin-right: 15px;">üóë Delete</button>`;
        }

        const div = document.createElement('div');
        div.style.marginBottom = '8px';
        div.innerHTML = `
            <div style="background: #fdfdfd; padding: 12px; border-radius: 6px; border: 1px solid #e0e0e0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleTemplate('${safeId}')">
                <div>
                    <strong style="color: #444;">${name.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</strong>
                    ${badge}
                </div>
                <div>
                    ${actionBtn}
                    <span id="icon-${safeId}" style="color: #888; font-size: 12px;">‚ñº</span>
                </div>
            </div>
            <div id="tpl-${safeId}" style="display: none; padding: 12px; border: 1px solid #e0e0e0; border-top: none; background: #fafafa; border-radius: 0 0 6px 6px;">
                <div class="checklist-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    ${data.symptoms.map(sym => `<label style="font-size: 13px; display: flex; align-items: flex-start; gap: 5px;"><input type="checkbox" class="tpl-checkbox" value="${String(sym).replace(/"/g, '&quot;')}" style="margin-top: 3px;"> <span style="line-height: 1.2;">${String(sym).replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span></label>`).join('')}
                </div>
            </div>
        `;
        container.appendChild(div);

        const option = document.createElement('option');
        option.value = name;
        datalist.appendChild(option);
    }
}

function toggleTemplate(safeId) {
    const el = document.getElementById('tpl-' + safeId);
    const icon = document.getElementById('icon-' + safeId);
    if (el.style.display === 'none') {
        el.style.display = 'block';
        icon.innerText = '‚ñ≤';
    } else {
        el.style.display = 'none';
        icon.innerText = '‚ñº';
    }
}

async function openTemplatesModal() {
    document.getElementById('modalTemplates').style.display = 'block';
    await fetchTemplates();
}

function loadTemplateForEdit() {
    const name = document.getElementById('custom-template-name').value;
    if (currentTemplates[name]) {
        document.getElementById('custom-template-symptoms').value = currentTemplates[name].symptoms.join(', ');
    }
}

async function saveCustomTemplate() {
    const name = document.getElementById('custom-template-name').value.trim();
    const symptomsStr = document.getElementById('custom-template-symptoms').value.trim();

    if (!name || !symptomsStr) {
        alert("Please enter both a template name and a list of symptoms.");
        return;
    }

    const symptomsArray = symptomsStr.split(',').map(s => s.trim()).filter(s => s);

    try {
        const response = await fetch('/api/templates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, symptoms: symptomsArray })
        });

        if (response.ok) {
            document.getElementById('custom-template-name').value = '';
            document.getElementById('custom-template-symptoms').value = '';
            await fetchTemplates();
            alert("Template '" + name + "' saved successfully!");
        }
    } catch (error) {
        alert("Failed to save template.");
    }
}

async function deleteOrRevertTemplate(name, event) {
    event.stopPropagation();

    if (!confirm(`Are you sure you want to remove/revert the template: ${name}?`)) return;

    try {
        const response = await fetch('/api/templates/' + encodeURIComponent(name), {
            method: 'DELETE'
        });

        if (response.ok) {
            await fetchTemplates();
        }
    } catch (error) {
        alert("Failed to delete/revert template.");
    }
}

function applyTemplates() {
    const checkboxes = document.querySelectorAll('.tpl-checkbox:checked');
    if (checkboxes.length === 0) {
        alert("Please select at least one symptom to apply.");
        return;
    }

    checkboxes.forEach(cb => {
        addSymptom();
        const symptomRows = document.getElementsByName('symptom_name[]');
        const lastRow = symptomRows[symptomRows.length - 1];
        lastRow.value = cb.value;
        cb.checked = false;
    });

    document.getElementById('modalTemplates').style.display = 'none';
}
</script>

<div id="modalEqDose" class="modal" onclick="if(event.target == this) this.style.display='none'">
    <div class="modal-content" style="width: 450px;">
        <h3 style="margin-top: 0; margin-bottom: 15px; border-bottom: 2px solid #f4f8fb; padding-bottom: 10px;">Calculate Equivalent Dose</h3>
        
        <div style="margin-bottom: 15px;">
            <label>Past Drug</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="eq_past_drug" list="eq_drug_list" placeholder="Select or type drug..." style="flex: 2; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
                
                <input type="text" id="eq_past_dose" list="eq_dose_list" placeholder="Dose (e.g. 10 mg)" oninput="updateEqDoseOptions(this)" style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
                <datalist id="eq_dose_list"></datalist>
            </div>
        </div>

        <div style="margin-bottom: 15px;">
            <label>Current / Target Drug</label>
            <input type="text" id="eq_target_drug" list="eq_drug_list" placeholder="Select or type target drug..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
        </div>
        
        <datalist id="eq_drug_list"></datalist>

        <button type="button" class="btn" onclick="calculateEqDose()" style="background-color: #a5dcfe; color: #333; padding: 8px 15px; font-size: 13px; width: 100%; margin-bottom: 15px;">üßÆ Calculate Dose</button>

        <div style="margin-bottom: 15px;">
            <label>Equivalent Dose</label>
            <input type="text" id="eq_result_dose" readonly style="background: #f0f8ff; border: 1px dashed #7ab8e0; font-weight: bold; width: 100%; padding: 10px; border-radius: 6px;">
        </div>

        <div style="display: flex; gap: 10px;">
            <button type="button" class="btn" style="flex: 2; background-color: #7BC4F0; color: #000; margin-top: 0;" onclick="applyEqDose()">‚úÖ Apply to Medications</button>
            <button type="button" class="btn" style="flex: 1; background-color: #eee; color: #333; margin-top: 0;" onclick="document.getElementById('modalEqDose').style.display='none'">Close</button>
        </div>
    </div>
</div>

<script>
    const eqDrugDb = {
        "Risperidone": { min: 2, max: 16 },
        "Olanzapine": { min: 5, max: 20 },
        "Haloperidol": { min: 2, max: 20 },
        "Aripiprazole": { min: 10, max: 30 },
        "Amisulpride": { min: 300, max: 1200 },
        "Clozapine": { min: 6.25, max: 900 },
        "Chlorpromazine": { min: 200, max: 1000 },
        "Cariprazine": { min: 1.5, max: 6 },
        "Quetiapine": { min: 150, max: 800 },
        "Quetiapine (Sedative)": { min: 25, max: 150 },
        "Aripiprazole (Adjuvant)": { min: 2.5, max: 10 },
        "Lithium Carbonate": { min: 150, max: 1800 },
        "Sodium Valproate": { min: 200, max: 3000 },
        "Carbamazepine": { min: 100, max: 1600 },
        "Escitalopram": { min: 10, max: 30 },
        "Fluoxetine": { min: 20, max: 80 },
        "Fluvoxamine": { min: 50, max: 300 },
        "Sertraline": { min: 50, max: 200 },
        "Paroxetine": { min: 20, max: 62.5 },
        "Bupropion": { min: 150, max: 450 },
        "Duloxetine": { min: 60, max: 120 },
        "Venlafaxine": { min: 75, max: 375 },
        "Vortioxetine": { min: 10, max: 20 }
    };

    const eqBenzoDb = {
        "Diazepam": 10,
        "Chlordiazepoxide": 25,
        "Lorazepam": 2,
        "Alprazolam": 0.5,
        "Clonazepam": 0.5
    };

    window.addEventListener('DOMContentLoaded', () => {
        const drugList = document.getElementById('eq_drug_list');
        if (drugList) {
            let optionsHtml = '';
            for (let d in eqDrugDb) { optionsHtml += `<option value="${d}">`; }
            for (let b in eqBenzoDb) { optionsHtml += `<option value="${b}">`; }
            drugList.innerHTML = optionsHtml;
        }
    });

    function updateEqDoseOptions(input) {
        const val = input.value.trim();
        const match = val.match(/[\d\.]+/);
        if (!match) return;
        const num = match[0];

        const list = document.getElementById('eq_dose_list');
        list.innerHTML = '';

        ['g', 'mg', 'Œºg'].forEach(unit => {
            const opt = document.createElement('option');
            opt.value = `${num} ${unit}`;
            list.appendChild(opt);
        });
    }

    function calculateEqDose() {
        const pastDrug = document.getElementById('eq_past_drug').value.trim();
        const targetDrug = document.getElementById('eq_target_drug').value.trim();
        const doseInput = document.getElementById('eq_past_dose').value.trim().toLowerCase();

        const match = doseInput.match(/([\d\.]+)\s*(g|mg|Œºg|mcg)?/);

        if (!pastDrug || !targetDrug || !match) {
            alert("Please select both drugs and enter a valid dose.");
            return;
        }

        const rawVal = parseFloat(match[1]);
        let inputUnit = match[2] || 'mg';
        if (inputUnit === 'mcg') inputUnit = 'Œºg';

        let pastDoseMg = rawVal;
        if (inputUnit === 'g') pastDoseMg = rawVal * 1000;
        else if (inputUnit === 'Œºg') pastDoseMg = rawVal / 1000;

        let calcDoseMg = 0;

        if (eqDrugDb[pastDrug] && eqDrugDb[targetDrug]) {
            const pastMin = eqDrugDb[pastDrug].min;
            const pastMax = eqDrugDb[pastDrug].max;
            const targetMin = eqDrugDb[targetDrug].min;
            const targetMax = eqDrugDb[targetDrug].max;

            const rtp = (pastDoseMg - pastMin) / (pastMax - pastMin);
            calcDoseMg = (rtp * (targetMax - targetMin)) + targetMin;

        } else if (eqBenzoDb[pastDrug] && eqBenzoDb[targetDrug]) {
            const ratio = eqBenzoDb[targetDrug] / eqBenzoDb[pastDrug];
            calcDoseMg = pastDoseMg * ratio;
        } else {
            alert("Cannot calculate direct RTP equivalence across different drug categories (e.g., RTP to Benzo). Please select drugs from the same group.");
            return;
        }

        calcDoseMg = Math.max(0, calcDoseMg);

        let finalVal = 0;
        let finalUnit = inputUnit;

        if (inputUnit === 'g') {
            let valInG = calcDoseMg / 1000;
            if (valInG >= 1) {
                finalVal = valInG;
            } else if (calcDoseMg >= 1) {
                finalVal = calcDoseMg;
                finalUnit = 'mg';
            } else {
                finalVal = calcDoseMg * 1000;
                finalUnit = 'Œºg';
            }
        } else if (inputUnit === 'mg') {
            if (calcDoseMg >= 1 || calcDoseMg === 0) {
                finalVal = calcDoseMg;
            } else {
                finalVal = calcDoseMg * 1000;
                finalUnit = 'Œºg';
            }
        } else if (inputUnit === 'Œºg') {
            finalVal = calcDoseMg * 1000;
        }

        const formattedVal = finalVal.toFixed(2).replace(/\.00$/, '') + ' ' + finalUnit;
        document.getElementById('eq_result_dose').value = formattedVal;
    }

    function applyEqDose() {
        const targetDrug = document.getElementById('eq_target_drug').value;
        const calcDose = document.getElementById('eq_result_dose').value;

        if (!targetDrug || !calcDose) {
            alert("Please calculate the dose first.");
            return;
        }

        addMedication();

        const medNames = document.getElementsByName('drug_name[]');
        const medDoses = document.getElementsByName('dose_full[]');

        if (medNames.length > 0) {
            medNames[medNames.length - 1].value = targetDrug;
            medDoses[medDoses.length - 1].value = calcDose;
        }

        document.getElementById('modalEqDose').style.display = 'none';

        document.getElementById('eq_past_drug').value = '';
        document.getElementById('eq_target_drug').value = '';
        document.getElementById('eq_past_dose').value = '';
        document.getElementById('eq_result_dose').value = '';
    }
</script>
<script>
// ==========================================
// PSYCHIATRIC SCALES LOGIC
// ==========================================
const scalesLibrary = [
    {
        "scaleId": "CIWA-Ar",
        "scaleName": "Clinical Institute Withdrawal Assessment for Alcohol (CIWA-Ar)",
        "questions": [
            {"id": "q1", "text": "Nausea/Vomiting", "options": [{"value": 0, "label": "None"}, {"value": 1, "label": "Mild nausea with no vomiting"}, {"value": 2, "label": "2"}, {"value": 3, "label": "3"}, {"value": 4, "label": "Intermittent nausea"}, {"value": 5, "label": "5"}, {"value": 6, "label": "6"}, {"value": 7, "label": "Constant nausea, frequent dry heaves/vomiting"}]},
            {"id": "q2", "text": "Tremors - have patient extend arms & spread fingers", "options": [{"value": 0, "label": "No tremor"}, {"value": 1, "label": "Not visible, but can be felt"}, {"value": 2, "label": "2"}, {"value": 3, "label": "3"}, {"value": 4, "label": "Moderate, arms extended"}, {"value": 5, "label": "5"}, {"value": 6, "label": "6"}, {"value": 7, "label": "Severe, even arms not extended"}]},
            {"id": "q3", "text": "Anxiety", "options": [{"value": 0, "label": "No anxiety"}, {"value": 1, "label": "Mildly anxious"}, {"value": 2, "label": "2"}, {"value": 3, "label": "3"}, {"value": 4, "label": "Moderately anxious"}, {"value": 5, "label": "5"}, {"value": 6, "label": "6"}, {"value": 7, "label": "Equivalent to acute panic states"}]},
            {"id": "q4", "text": "Agitation", "options": [{"value": 0, "label": "Normal activity"}, {"value": 1, "label": "Somewhat normal"}, {"value": 2, "label": "2"}, {"value": 3, "label": "3"}, {"value": 4, "label": "Moderately fidgety/restless"}, {"value": 5, "label": "5"}, {"value": 6, "label": "6"}, {"value": 7, "label": "Paces back & forth, thrashes about"}]},
            {"id": "q5", "text": "Paroxysmal Sweats", "options": [{"value": 0, "label": "No sweats"}, {"value": 1, "label": "Barely perceptible, palms moist"}, {"value": 2, "label": "2"}, {"value": 3, "label": "3"}, {"value": 4, "label": "Beads of sweat on forehead"}, {"value": 5, "label": "5"}, {"value": 6, "label": "6"}, {"value": 7, "label": "Drenching sweats"}]},
            {"id": "q6", "text": "Orientation and clouding of sensorium", "options": [{"value": 0, "label": "Oriented"}, {"value": 1, "label": "Cannot do serial additions or uncertain date"}, {"value": 2, "label": "Disoriented to date by no more than 2 calendar days"}, {"value": 3, "label": "Disoriented to date by > 2 days"}, {"value": 4, "label": "Disoriented to place and/or person"}]},
            {"id": "q7", "text": "Tactile disturbances", "options": [{"value": 0, "label": "None"}, {"value": 1, "label": "Very mild itching, pins/needles"}, {"value": 2, "label": "Mild"}, {"value": 3, "label": "Moderate"}, {"value": 4, "label": "Moderate hallucinations"}, {"value": 5, "label": "Severe hallucinations"}, {"value": 6, "label": "Extremely severe hallucinations"}, {"value": 7, "label": "Continuous hallucinations"}]},
            {"id": "q8", "text": "Auditory Disturbances", "options": [{"value": 0, "label": "Not present"}, {"value": 1, "label": "Very mild harshness/startle"}, {"value": 2, "label": "Mild"}, {"value": 3, "label": "Moderate"}, {"value": 4, "label": "Moderate hallucinations"}, {"value": 5, "label": "Severe hallucinations"}, {"value": 6, "label": "Extremely severe hallucinations"}, {"value": 7, "label": "Continuous hallucinations"}]},
            {"id": "q9", "text": "Visual disturbances", "options": [{"value": 0, "label": "Not present"}, {"value": 1, "label": "Very mild sensitivity"}, {"value": 2, "label": "Mild"}, {"value": 3, "label": "Moderate"}, {"value": 4, "label": "Moderate hallucinations"}, {"value": 5, "label": "Severe hallucinations"}, {"value": 6, "label": "Extremely severe hallucinations"}, {"value": 7, "label": "Continuous hallucinations"}]},
            {"id": "q10", "text": "Headache", "options": [{"value": 0, "label": "Not present"}, {"value": 1, "label": "Very mild"}, {"value": 2, "label": "Mild"}, {"value": 3, "label": "Moderate"}, {"value": 4, "label": "Moderately severe"}, {"value": 5, "label": "Severe"}, {"value": 6, "label": "Very severe"}, {"value": 7, "label": "Extremely severe"}]}
        ],
        "interpretation": [
            {"min": 0, "max": 9, "label": "Absent or minimal withdrawal"},
            {"min": 10, "max": 19, "label": "Mild to moderate withdrawal"},
            {"min": 20, "max": 67, "label": "Severe withdrawal"}
        ]
    },
    {
        "scaleId": "Y-BOCS",
        "scaleName": "Yale Brown OCD Scale",
        "questions": [
            {"id": "q1", "text": "Time spent on obsessive thoughts?", "options": [{"value": 0, "label": "None"}, {"value": 1, "label": "0-1 hrs/day"}, {"value": 2, "label": "1-3 hrs/day"}, {"value": 3, "label": "3-8 hrs/day"}, {"value": 4, "label": "More than 8 hrs/day"}]},
            {"id": "q2", "text": "Interference from obsessive thoughts?", "options": [{"value": 0, "label": "None"}, {"value": 1, "label": "Mild"}, {"value": 2, "label": "Definite but manageable"}, {"value": 3, "label": "Substantial interference"}, {"value": 4, "label": "Severe"}]},
            {"id": "q3", "text": "Distress from obsessive thoughts?", "options": [{"value": 0, "label": "None"}, {"value": 1, "label": "Little"}, {"value": 2, "label": "Moderate but manageable"}, {"value": 3, "label": "Severe"}, {"value": 4, "label": "Nearly constant, Disabling"}]},
            {"id": "q4", "text": "Resistance to obsessions?", "options": [{"value": 0, "label": "Always try"}, {"value": 1, "label": "Try much of the time"}, {"value": 2, "label": "Try some of the time"}, {"value": 3, "label": "Rarely try. Often yield"}, {"value": 4, "label": "Never try. Completely yield"}]},
            {"id": "q5", "text": "Control over obsessive thoughts?", "options": [{"value": 0, "label": "Complete control"}, {"value": 1, "label": "Much control"}, {"value": 2, "label": "Some control"}, {"value": 3, "label": "Little control"}, {"value": 4, "label": "No control"}]},
            {"id": "q6", "text": "Time spent on compulsions?", "options": [{"value": 0, "label": "None"}, {"value": 1, "label": "0-1 hrs/day"}, {"value": 2, "label": "1-3 hrs/day"}, {"value": 3, "label": "3-8 hrs/day"}, {"value": 4, "label": "More than 8 hrs/day"}]},
            {"id": "q7", "text": "Interference from compulsions?", "options": [{"value": 0, "label": "None"}, {"value": 1, "label": "Mild"}, {"value": 2, "label": "Definite but manageable"}, {"value": 3, "label": "Substantial interference"}, {"value": 4, "label": "Severe"}]},
            {"id": "q8", "text": "Anxiety if compulsions prevented?", "options": [{"value": 0, "label": "None"}, {"value": 1, "label": "Little"}, {"value": 2, "label": "Moderate but manageable"}, {"value": 3, "label": "Severe"}, {"value": 4, "label": "Nearly constant, Disabling"}]},
            {"id": "q9", "text": "Resistance to compulsions?", "options": [{"value": 0, "label": "Always try"}, {"value": 1, "label": "Try much of the time"}, {"value": 2, "label": "Try some of the time"}, {"value": 3, "label": "Rarely try. Often yield"}, {"value": 4, "label": "Never try. Completely yield"}]},
            {"id": "q10", "text": "Control over compulsions?", "options": [{"value": 0, "label": "Complete control"}, {"value": 1, "label": "Much control"}, {"value": 2, "label": "Some control"}, {"value": 3, "label": "Little control"}, {"value": 4, "label": "No control"}]}
        ],
        "interpretation": [
            {"min": 0, "max": 7, "label": "Subclinical"},
            {"min": 8, "max": 15, "label": "Mild OCD"},
            {"min": 16, "max": 23, "label": "Moderate OCD"},
            {"min": 24, "max": 31, "label": "Severe OCD"},
            {"min": 32, "max": 40, "label": "Extreme OCD"}
        ]
    }
];

let appliedScales = {};
let currentActiveScale = null;

window.addEventListener('load', () => {
    const hiddenData = document.getElementById('scales_data');
    if (hiddenData && hiddenData.value && hiddenData.value !== '[]') {
        try {
            const parsed = JSON.parse(hiddenData.value);
            parsed.forEach(s => appliedScales[s.scale_id] = s);
            updateScalesBadge();
        } catch (e) {}
    }
});

function openScalesModal() {
    document.getElementById('scalesModal').style.display = 'block';
    showScalesList();
    renderScalesList(scalesLibrary);
}

function showScalesList() {
    document.getElementById('scale-assessment-view').style.display = 'none';
    document.getElementById('scales-list-view').style.display = 'flex';
}

function renderScalesList(scalesToRender) {
    const listDiv = document.getElementById('available-scales-list');
    listDiv.innerHTML = '';
    scalesToRender.forEach(scale => {
        const isApplied = appliedScales[scale.scaleId] ? '‚úÖ (Applied)' : '';
        const html = '<div style="padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;"><div><strong style="color: #444;">' + scale.scaleName + '</strong> <span style="color: green; font-size: 12px;">' + isApplied + '</span></div><button type="button" class="btn" style="margin:0; padding: 6px 12px; font-size: 12px; background: #a5dcfe; color: #333;" onclick="openScaleAssessment(\'' + scale.scaleId + '\')">Assess</button></div>';
        listDiv.insertAdjacentHTML('beforeend', html);
    });
}

function filterScales(recommendedVal = '') {
    const searchVal = document.getElementById('scale-search').value.toLowerCase();
    const dropdownVal = recommendedVal || document.getElementById('scale-recommended').value;
    const filtered = scalesLibrary.filter(s => {
        const matchesSearch = s.scaleName.toLowerCase().includes(searchVal);
        const matchesDropdown = dropdownVal === '' || s.scaleId === dropdownVal;
        return matchesSearch && matchesDropdown;
    });
    renderScalesList(filtered);
}

function openScaleAssessment(scaleId) {
    currentActiveScale = scalesLibrary.find(s => s.scaleId === scaleId);
    document.getElementById('scales-list-view').style.display = 'none';
    document.getElementById('scale-assessment-view').style.display = 'flex';
    document.getElementById('active-scale-title').innerText = currentActiveScale.scaleName;
    const form = document.getElementById('active-scale-form');
    form.innerHTML = '';
    const prevAnswers = appliedScales[scaleId] ? appliedScales[scaleId].raw_responses : {};
    currentActiveScale.questions.forEach((q, idx) => {
        let optionsHtml = '';
        q.options.forEach(opt => {
            const isChecked = prevAnswers[q.id] == opt.value ? 'checked' : '';
            optionsHtml += '<label style="display: block; margin-bottom: 5px; cursor: pointer;"><input type="radio" name="' + q.id + '" value="' + opt.value + '" ' + isChecked + ' onchange="calculateLiveScore()"> <span style="margin-left: 8px;">' + opt.value + ' - ' + opt.label + '</span></label>';
        });
        form.insertAdjacentHTML('beforeend', '<div style="background: #fdfdfd; padding: 15px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #e0e0e0;"><strong style="display: block; margin-bottom: 10px;">' + (idx + 1) + '. ' + q.text + '</strong>' + optionsHtml + '</div>');
    });
    calculateLiveScore();
}

function calculateLiveScore() {
    if (!currentActiveScale) return;
    const container = document.getElementById('active-scale-form');
    let totalScore = 0;

    // Find all checked radio buttons inside our div
    const checkedInputs = container.querySelectorAll('input[type="radio"]:checked');
    checkedInputs.forEach(input => {
        totalScore += parseInt(input.value);
    });

    document.getElementById('scale-live-score').innerText = totalScore;
    let severity = "Score out of bounds";
    for (let band of currentActiveScale.interpretation) {
        if (totalScore >= band.min && totalScore <= band.max) {
            severity = band.label;
            break;
        }
    }
    document.getElementById('scale-live-severity').innerText = severity;
}

function saveActiveScale() {
    const container = document.getElementById('active-scale-form');
    let rawResponses = {};

    // Save only the checked values
    const checkedInputs = container.querySelectorAll('input[type="radio"]:checked');
    checkedInputs.forEach(input => {
        rawResponses[input.name] = parseInt(input.value);
    });

    const totalScore = parseInt(document.getElementById('scale-live-score').innerText);
    const severityLabel = document.getElementById('scale-live-severity').innerText;
    appliedScales[currentActiveScale.scaleId] = {
        scale_id: currentActiveScale.scaleId,
        scale_name: currentActiveScale.scaleName,
        total_score: totalScore,
        severity_label: severityLabel,
        raw_responses: rawResponses
    };
    document.getElementById('scales_data').value = JSON.stringify(Object.values(appliedScales));
    updateScalesBadge();
    showScalesList();
    renderScalesList(scalesLibrary);
}

function updateScalesBadge() {
    const badge = document.getElementById('scales-count-badge');
    const count = Object.keys(appliedScales).length;
    if (count > 0) {
        badge.innerText = count + ' Applied';
        badge.style.display = 'inline-block';
    } else {
        badge.style.display = 'none';
    }
}
</script>
</body>
</html>