<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Chart - {{ patient.name if patient else 'Guest' }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    
    <style>
        :root { --primary: #A5DCFE; --dark: #7ab8e0; --bg: #f4f8fb; --text-main: #333; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); height: 100vh; display: flex; overflow: hidden; }
        
        /* SIDEBAR STYLES (Unchanged) */
        .sidebar { width: 280px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; flex-shrink: 0; z-index: 2; }
        .nav-row { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        .nav-row a { text-decoration: none; color: #555; font-weight: 600; font-size: 0.9rem; }
        .controls { padding: 15px; overflow-y: auto; flex: 1; }
        
        .sidebar-group { background: white; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
        .group-header { background: #f1f3f5; padding: 8px 12px; font-size: 0.85rem; font-weight: 700; color: #495057; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #e9ecef; }
        .list-container { padding: 5px 0; }
        
        .sidebar-item { display: grid; grid-template-columns: 24px 20px 1fr; gap: 8px; align-items: center; padding: 8px 12px; font-size: 0.9rem; color: var(--text-main); cursor: pointer; transition: background 0.15s; border-left: 3px solid transparent; }
        .sidebar-item:hover { background: #f8f9fa; border-left-color: var(--dark); }
        .sidebar-item input { width: 16px; height: 16px; margin: 0; accent-color: var(--dark); cursor: pointer; justify-self: center; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; margin: 0; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1); justify-self: center; }
        .item-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .sidebar-item.unified-item { background: #fcfcfc; border-bottom: 1px dashed #eee; font-weight: 600; }

        /* MAIN CONTENT AREA */
        .main-content { 
            flex: 1; 
            padding: 15px; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
        }

        /* --- NEW WIDGET SYSTEM STYLES --- */
        
        /* Widget Toolbar */
        .widget-toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
        }
        .widget-selector {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
            min-width: 200px;
        }
        .add-widget-btn {
            background: var(--dark);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        .add-widget-btn:hover { background: #5a9bc4; }
        .add-widget-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Grid Container */
        .widget-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 Column Grid */
            gap: 15px;
            align-items: start; /* Prevents stretching height automatically */
        }

        /* Individual Widget Card */
        .widget-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            position: relative;
            /* Enable Both Vertical and Horizontal Resizing */
            resize: both; 
            overflow: hidden; 
            min-height: 250px;
            height: 400px; /* Default Height */
            border: 1px solid #e0e0e0;
            transition: box-shadow 0.2s;
        }
        
        /* New Sticky Tooltip Style (matches standard Chart.js hover look) */
        .sticky-tooltip {
            position: fixed; 
            background: rgba(0, 0, 0, 0.8); /* Standard Chart.js dark background */
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Segoe UI', system-ui, sans-serif;
            pointer-events: none; /* Allows clicking through the tooltip */
            z-index: 5000;
            transform: translate(-50%, -120%); /* Centers and places it above the point */
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.25);
            transition: opacity 0.15s ease-in-out;
        }
        /* Small Triangle Arrow at the bottom */
        .sticky-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }
        .tooltip-color-box {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin-right: 6px;
            border-radius: 2px; /* Slight rounded corners for the box */
            border: 1px solid rgba(255,255,255,0.8);
            vertical-align: middle;
        }

        .widget-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #ccc;
        }

        /* Sizing Classes for Grid */
        .span-full { grid-column: span 2; }
        .span-half { grid-column: span 1; }

        /* Widget Header */
        .widget-header {
            padding: 8px 12px;
            background: #fdfdfd;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move; /* Implies dragging conceptually */
        }
        .widget-title {
            font-weight: bold;
            color: var(--dark);
            font-size: 0.95rem;
            user-select: none;
        }
        .widget-controls {
            display: flex;
            gap: 8px;
        }
        .widget-icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            font-size: 1.1rem;
            padding: 0;
            line-height: 1;
        }
        .widget-icon-btn:hover { color: #555; }
        .widget-icon-btn.remove:hover { color: red; }

        .canvas-container { 
            flex: 1; 
            position: relative; 
            width: 100%; 
            height: calc(100% - 35px); /* Subtract header height */
            min-height: 0; 
            padding: 5px; 
            box-sizing: border-box;
        }


        /* WORKFLOW INPUTS (Separate Section) */
        .form-section-separator {
            margin-top: 10px;
            border-top: 2px dashed #e0e0e0;
            padding-top: 20px;
        }
        .workflow-card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .row-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        input, textarea, select { width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit; box-sizing: border-box; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; background: var(--dark); width: 100%; font-size: 1rem; }
        
        /* MEDICATION ROW STYLES */
        .entry-wrapper { border: 1px solid #eee; padding: 10px; margin-bottom: 8px; border-radius: 6px; background: #fafafa; }
        .row-flex { display: flex; gap: 10px; align-items: center; }
        .note-btn { background: none; border: none; cursor: pointer; font-size: 1.1rem; color: #999; }
        .note-input { display: none; width: 100%; margin-top: 5px; padding: 5px; border: 1px dashed #ccc; background: #fffdf0; }
        .remove-btn { color: #ff6b6b; background: none; border: none; cursor: pointer; font-weight: bold; }
        .add-btn-small { background: var(--dark); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; float: right; }

        /* MODAL (Double Click) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
        .modal-content { background: white; margin: 5% auto; padding: 25px; width: 60%; max-width: 600px; border-radius: 12px; max-height: 80vh; overflow-y: auto; }
        .detail-row { margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 3px; font-size: 0.9rem; }
        .close-btn { float: right; font-size: 24px; cursor: pointer; color: #aaa; }

        /* DAILY SUMMARY POPUP (Single Click) */
        .daily-summary-popup { display: none; position: absolute; background: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); padding: 15px; z-index: 1500; min-width: 250px; max-width: 350px; font-size: 0.9rem; }
        .daily-summary-header { font-weight: bold; color: var(--dark); margin-bottom: 8px; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .daily-summary-content ul { list-style: none; padding: 0; margin: 0; }
        .daily-summary-content li { margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px dashed #eee; }
        .daily-summary-cat { font-weight: 700; color: #555; font-size: 0.8rem; text-transform: uppercase; margin-top: 5px; margin-bottom: 2px; }
        .pop-close { cursor: pointer; font-size: 16px; color: #999; }
        .pop-close:hover { color: red; }
    </style>
</head>
<body>
<div class="sidebar">
    <div class="nav-row">
        {% if not guest %}
            <a href="{{ url_for('first_visit') }}">← First Visit</a>
            <a href="{{ url_for('logout') }}" style="color: red;">Logout</a>
        {% else %}
            <span style="font-weight: 600; color: #555;">Guest View</span>
            <span style="font-size: 0.8rem; color: #888;">Read Only</span>
        {% endif %}
    </div>
    
    <div class="controls">
        <div class="sidebar-group">
            <div class="group-header">Chief Complaints</div>
            <div class="list-container">
                <label class="sidebar-item unified-item">
                    <input type="checkbox" id="check-unified-symptoms" checked onchange="toggleUnified('symptoms')">
                    <span class="color-dot" style="background:black;"></span>
                    <span class="item-text">Unified (Average)</span>
                </label>
                <label class="sidebar-item" style="border-bottom:1px solid #eee; margin-bottom:5px;">
                    <input type="checkbox" onchange="toggleAll('symptoms', this)">
                    <span></span> <span class="item-text" style="font-weight:700; color:#555; font-style:italic;">Select All</span>
                </label>
                {% for ds in symptom_datasets %}
                <label class="sidebar-item">
                    <input type="checkbox" class="chk-symptoms" value="{{ ds.label }}" onchange="toggleDataset('symptoms', '{{ ds.label }}')">
                    <span class="color-dot" style="background:{{ ds.borderColor }};"></span>
                    <span class="item-text">{{ ds.label }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="sidebar-group">
            <div class="group-header">Medications</div>
            <div class="list-container">
                <label class="sidebar-item unified-item">
                    <input type="checkbox" id="check-unified-meds" checked onchange="toggleUnified('meds')">
                    <span class="color-dot" style="background:black;"></span>
                    <span class="item-text">Unified (Average)</span>
                </label>
                <label class="sidebar-item" style="border-bottom:1px solid #eee; margin-bottom:5px;">
                    <input type="checkbox" onchange="toggleAll('meds', this)">
                    <span></span> <span class="item-text" style="font-weight:700; color:#555; font-style:italic;">Select All</span>
                </label>
                {% for ds in medication_datasets %}
                <label class="sidebar-item">
                    <input type="checkbox" class="chk-meds" value="{{ ds.label }}" onchange="toggleDataset('meds', '{{ ds.label }}')">
                    <span class="color-dot" style="background:{{ ds.borderColor }};"></span>
                    <span class="item-text">{{ ds.label }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="sidebar-group">
            <div class="group-header">Side Effects</div>
            <div class="list-container">
                <label class="sidebar-item unified-item">
                    <input type="checkbox" id="check-unified-se" checked onchange="toggleUnified('se')">
                    <span class="color-dot" style="background:black;"></span>
                    <span class="item-text">Unified (Average)</span>
                </label>
                <label class="sidebar-item" style="border-bottom:1px solid #eee; margin-bottom:5px;">
                    <input type="checkbox" onchange="toggleAll('se', this)">
                    <span></span> <span class="item-text" style="font-weight:700; color:#555; font-style:italic;">Select All</span>
                </label>
                {% for ds in side_effect_datasets %}
                <label class="sidebar-item">
                    <input type="checkbox" class="chk-se" value="{{ ds.label }}" onchange="toggleDataset('se', '{{ ds.label }}')">
                    <span class="color-dot" style="background:{{ ds.borderColor }};"></span>
                    <span class="item-text">{{ ds.label }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="sidebar-group">
            <div class="group-header">MSE Findings</div>
            <div class="list-container">
                <label class="sidebar-item unified-item">
                    <input type="checkbox" id="check-unified-mse" checked onchange="toggleUnified('mse')">
                    <span class="color-dot" style="background:black;"></span>
                    <span class="item-text">Unified (Average)</span>
                </label>
                <label class="sidebar-item" style="border-bottom:1px solid #eee; margin-bottom:5px;">
                    <input type="checkbox" onchange="toggleAll('mse', this)">
                    <span></span> <span class="item-text" style="font-weight:700; color:#555; font-style:italic;">Select All</span>
                </label>
                {% for ds in mse_datasets %}
                <label class="sidebar-item">
                    <input type="checkbox" class="chk-mse" value="{{ ds.label }}" onchange="toggleDataset('mse', '{{ ds.label }}')">
                    <span class="color-dot" style="background:{{ ds.borderColor }};"></span>
                    <span class="item-text">{{ ds.label }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="main-content">
    
    <div class="widget-toolbar">
        <select id="widgetSelector" class="widget-selector">
            <option value="" disabled selected>Select chart to add...</option>
            </select>
        <button onclick="addSelectedWidget()" class="add-widget-btn">Insert Chart</button>
        <button onclick="openDownloadModal()" class="btn" style="padding: 5px 10px; font-size: 13px; height: 30px; background: #555; color: white; margin-left: auto;">Download</button>
    </div>

    <div id="dashboardArea" class="widget-grid">
        </div>

    <div class="form-section-separator"></div>

    <div class="workflow-card">
        <form method="POST" action="{{ url_for('update_clinical', visit_id=visit.id) if visit else url_for('add_visit', patient_id=patient.id) }}">
            
            <h3 style="margin-top:0; color:#333; border-bottom:1px solid #eee; padding-bottom:10px;">
                {{ 'Edit Visit Details' if visit else 'Save New Visit from Chart' }}
            </h3>

            <div class="row-2-col">
                <div>
                    <label style="display:block; margin-bottom:5px; font-weight:600; color:#555;">Provisional Diagnosis</label>
                    <textarea name="provisional_diagnosis" rows="2">{{ visit.provisional_diagnosis if visit else '' }}</textarea>
                </div>
                <div>
                    <label style="display:block; margin-bottom:5px; font-weight:600; color:#555;">Differential Diagnosis</label>
                    <textarea name="differential_diagnosis" rows="2">{{ visit.differential_diagnosis if visit else '' }}</textarea>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <h4 style="margin:0 0 10px 0; color:#555; display:flex; justify-content:space-between;">
                    Medications 
                    <button type="button" class="add-btn-small" onclick="addMedication()">+</button>
                </h4>
                
                <div id="meds-container">
                    {% if visit and visit.medication_entries %}
                        {% for entry in visit.medication_entries %}
                            {% if entry.is_tapering and entry.taper_plan %}
                                {% set steps = entry.taper_plan|from_json %}
                                {% for step in steps %}
                                {% set unique_id = (entry.id|string ~ '_' ~ loop.index|string) if entry.id else loop.index %}
                                {% set step_freq = step.frequency|default('1-0-1') %}
                                <div class="entry-wrapper">
                                    <div class="row-flex" style="align-items:center;">
                                        <select name="drug_type[]" style="width:100px; flex:none;">
                                            <option value="Generic" {% if entry.drug_type == 'Generic' or not entry.drug_type %}selected{% endif %}>Generic</option>
                                            <option value="Brand" {% if entry.drug_type == 'Brand' %}selected{% endif %}>Brand</option>
                                        </select>
                                        <input type="text" name="drug_name[]" value="{{ entry.drug_name }}" placeholder="Drug" style="width:25%; {% if loop.index0 > 0 %}background:#f0f8ff; border:1px dashed #7ab8e0;{% endif %}" {% if loop.index0 > 0 %}readonly{% endif %}>
                                        <div style="flex:1; min-width:80px;">
                                            <input type="text" name="dose_full[]" value="{{ step.dose_mg or '' }}" list="dose-list-lc-{{ unique_id }}" placeholder="Dose" oninput="updateDoseOptionsLC(this)">
                                            <datalist id="dose-list-lc-{{ unique_id }}"></datalist>
                                        </div>
                                        <div style="flex:1.5; display:flex; align-items:center; min-width:140px;">
                                            <input type="hidden" name="frequency[]" value="{{ step_freq }}">
                                            <div class="freq-container" style="display:flex; align-items:center;">
                                                {% set parts = step_freq.split('-') if step_freq and '-' in step_freq else [step_freq] if step_freq else ['1','0','1'] %}
                                                {% for p in parts %}
                                                <input type="text" class="freq-box" value="{{ p }}" style="width:22px; text-align:center; padding:4px 2px;" oninput="handleFreqInputLC(this)">
                                                {% if not loop.last %}<span style="margin:0 2px">-</span>{% endif %}
                                                {% endfor %}
                                            </div>
                                            <div style="display:flex; flex-direction:column; margin-left:4px;">
                                                <button type="button" class="add-freq-btn" onclick="addFreqBoxLC(this)" style="font-size:10px; padding:0 2px; cursor:pointer;">+</button>
                                                <button type="button" onclick="removeFreqBoxLC(this)" style="font-size:10px; padding:0 2px; cursor:pointer;">-</button>
                                            </div>
                                        </div>
                                        <input list="duration-options-list" name="med_duration[]" value="{{ step.duration_text or '' }}" placeholder="Dur" style="flex:1;" oninput="updateDurationOptions(this)">
                                        <button type="button" class="btn btn-sm" onclick="duplicateTaperRowLC(this)" style="font-size:10px; padding:4px 6px; border-radius:4px; border:1px dashed #7ab8e0; background:#f0f8ff; color:#555;">+ Taper Step</button>
                                        <button type="button" class="remove-btn" onclick="this.closest('.entry-wrapper').remove()">✕</button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                {% set unique_id = entry.id if entry.id else loop.index %}
                                <div class="entry-wrapper">
                                    <div class="row-flex" style="align-items:center;">
                                        <select name="drug_type[]" style="width:100px; flex:none;">
                                            <option value="Generic" {% if entry.drug_type == 'Generic' or not entry.drug_type %}selected{% endif %}>Generic</option>
                                            <option value="Brand" {% if entry.drug_type == 'Brand' %}selected{% endif %}>Brand</option>
                                        </select>
                                        <input type="text" name="drug_name[]" value="{{ entry.drug_name }}" placeholder="Drug" style="width:25%;">
                                        <div style="flex:1; min-width:80px;">
                                            <input type="text" name="dose_full[]" value="{{ entry.dose_mg or '' }}" list="dose-list-lc-{{ unique_id }}" placeholder="Dose" oninput="updateDoseOptionsLC(this)">
                                            <datalist id="dose-list-lc-{{ unique_id }}"></datalist>
                                        </div>
                                        <div style="flex:1.5; display:flex; align-items:center; min-width:140px;">
                                            <input type="hidden" name="frequency[]" value="{{ entry.frequency or '1-0-1' }}">
                                            <div class="freq-container" style="display:flex; align-items:center;">
                                                {% set parts = entry.frequency.split('-') if entry.frequency and '-' in entry.frequency else [entry.frequency] if entry.frequency else ['1','0','1'] %}
                                                {% for p in parts %}
                                                <input type="text" class="freq-box" value="{{ p }}" style="width:22px; text-align:center; padding:4px 2px;" oninput="handleFreqInputLC(this)">
                                                {% if not loop.last %}<span style="margin:0 2px">-</span>{% endif %}
                                                {% endfor %}
                                            </div>
                                            <div style="display:flex; flex-direction:column; margin-left:4px;">
                                                <button type="button" class="add-freq-btn" onclick="addFreqBoxLC(this)" style="font-size:10px; padding:0 2px; cursor:pointer;">+</button>
                                                <button type="button" onclick="removeFreqBoxLC(this)" style="font-size:10px; padding:0 2px; cursor:pointer;">-</button>
                                            </div>
                                        </div>
                                        <input list="duration-options-list" name="med_duration[]" value="{{ entry.duration_text or '' }}" placeholder="Dur" style="flex:1;" oninput="updateDurationOptions(this)">
                                        <button type="button" class="btn btn-sm" onclick="duplicateTaperRowLC(this)" style="font-size:10px; padding:4px 6px; border-radius:4px; border:1px dashed #7ab8e0; background:#f0f8ff; color:#555;">+ Taper Step</button>
                                        <button type="button" class="remove-btn" onclick="this.closest('.entry-wrapper').remove()">✕</button>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <div style="background:#f9fafb; padding:15px; border-radius:8px; margin-top:20px; display:flex; gap:20px; align-items:center;">
                <div>
                    <label style="font-weight:600; color:#555;">Next Follow-up Date</label>
                    <input type="date" name="next_visit_date" id="nextVisitDate" value="{{ visit.next_visit_date.strftime('%Y-%m-%d') if visit and visit.next_visit_date else '' }}">
                </div>
                <div style="flex:1;">
                    <label style="font-weight:600; color:#555;">Visit Note</label>
                    <input type="text" name="visit_note" value="{{ visit.note if visit else '' }}" placeholder="Summary...">
                </div>
                <input type="hidden" name="date" value="{{ visit.date.strftime('%Y-%m-%d') if visit and visit.date else today }}">
            </div>

            <div style="margin-top:20px; display:flex; gap:10px;">
                <button type="submit" name="submit_action" value="lifechart" class="btn" style="background:#f5576c;">
                    {{ 'Update & Refresh Chart' if visit else 'Save & Refresh Chart' }}
                </button>
                <button type="submit" name="submit_action" value="prescription" class="btn" style="background:#7BC4F0; color:#000;">
                    {{ 'Update & Gen Prescription' if visit else 'Save & Gen Prescription' }}
                </button>
            </div>
        </form>
    </div>
</div>

<div id="dailySummary" class="daily-summary-popup">
    <div class="daily-summary-header">
        <span id="dsDate">Date</span>
        <span class="pop-close" onclick="closeDailySummary()">✕</span>
    </div>
    <div class="daily-summary-content" id="dsContent"></div>
</div>

<div id="visitModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 id="modalDate" class="visit-date"></h2>
        <div id="modalBody"></div>
    </div>
</div>

<datalist id="duration-options-list"></datalist>
<datalist id="freq-options-list">
    <option value="1-0-0">Morning</option>
    <option value="1-0-1">Morning & Night</option>
	<option value="1-0-1">Morning & Afternoon</option>
    <option value="0-0-1">Night</option>
    <option value="1-1-1">Morning, Afternoon & Night</option>
    <option value="0-1-0">Afternoon</option>
    <option value="SOS">As Needed</option>
</datalist>

<script>
    // --- DATA ---
    const rawData = {
        symptoms: {{ symptom_datasets | tojson }},
        symptomsUnified: {{ symptom_unified | tojson }},
        meds: {{ medication_datasets | tojson }}, 
        medsUnified: {{ med_unified | tojson }},
        se: {{ side_effect_datasets | tojson }}, 
        seUnified: {{ se_unified | tojson }},
        mse: {{ mse_datasets | tojson }},
        mseUnified: {{ mse_unified | tojson }},
        details: {{ visit_details | tojson }}
    };
	
	let suppressSingleClickUntil = 0;
    let charts = {}; // Global chart instance storage
    let activeStickyDate = null; // Remember active date for zoom/pan sync

    // --- CHART OPTIONS ---
    const commonOptions = {
        responsive: true, maintainAspectRatio: false, 
        scales: {
            x: { type: 'time', time: { unit: 'day' }, title: { display: true, text: 'Date' } },
            y: { beginAtZero: true, title: { display: true, text: 'Score' } }
        },
        plugins: {
            // --- UPDATED ZOOM CONFIGURATION ---
            zoom: { 
                zoom: { 
                    wheel: { enabled: true }, 
                    pinch: { enabled: true }, 
                    mode: 'x',
                    // Listener for Zooming
                    onZoom: ({chart}) => { if(activeStickyDate) showStickyTooltips(activeStickyDate); }
                }, 
                pan: { 
                    enabled: true, 
                    mode: 'x',
                    // Listener for Panning (Dragging)
                    onPan: ({chart}) => { if(activeStickyDate) showStickyTooltips(activeStickyDate); }
                } 
            },
            tooltip: { enabled: true, mode: 'nearest', intersect: true },
            legend: { display: false } 
        },
        // --- UPDATED CLICK HANDLER ---
        onClick: (e, activeEls, chart) => {
            if (Date.now() < suppressSingleClickUntil) return;
            if (chart.clickTimeout) clearTimeout(chart.clickTimeout);

            chart.clickTimeout = setTimeout(() => {
                const xScale = chart.scales.x;
                if (!xScale) return;

                let dateStr = "";
                const points = chart.getElementsAtEventForMode(e, 'nearest', { intersect: false, axis: 'x' }, true);

                if (points.length > 0) {
                    const firstPoint = points[0];
                    const dataItem = chart.data.datasets[firstPoint.datasetIndex].data[firstPoint.index];
                    if (dataItem && dataItem.x) dateStr = dataItem.x.split('T')[0];
                } 
                
                if (!dateStr) {
                    // Fallback Logic
                    const nativeEvent = e.native != null ? e.native : e;
                    const canvasPos = Chart.helpers.getRelativePosition(nativeEvent, chart);
                    const chartArea = chart.chartArea;
                    const canvasX = Math.max(chartArea.left, Math.min(chartArea.right, canvasPos.x));
                    const dateValue = xScale.getValueForPixel(canvasX);
                    
                    if (dateValue) {
                        const dateObj = new Date(dateValue);
                        if (dateObj.getHours() >= 12) dateObj.setDate(dateObj.getDate() + 1);
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const day = String(dateObj.getDate()).padStart(2, '0');
                        dateStr = `${year}-${month}-${day}`;
                    }
                }

                if (dateStr) {
                    activeStickyDate = dateStr; // Save the date for zoom/pan sync
                    showStickyTooltips(dateStr);
                }
            }, 220); 
        }
    };

    // --- WIDGET CONFIGURATION ---
    const widgetConfig = {
        'symptoms': { title: 'Chief Complaints', chartId: 'chartSymptoms', createData: () => ({ sets: rawData.symptoms, unified: rawData.symptomsUnified }) },
        'meds': { title: 'Medications', chartId: 'chartMeds', createData: () => ({ sets: rawData.meds, unified: rawData.medsUnified }) },
        'se': { title: 'Side Effects', chartId: 'chartSE', createData: () => ({ sets: rawData.se, unified: rawData.seUnified }) },
        'mse': { title: 'MSE Findings', chartId: 'chartMSE', createData: () => ({ sets: rawData.mse, unified: rawData.mseUnified }) }
    };

    // Initial Layout Order as requested
    // Row 1: Symptoms (Full), Row 2: Meds(Half) SE(Half), Row 3: MSE (Full)
    const initialLayout = [
        { key: 'symptoms', width: 'span-full' },
        { key: 'meds', width: 'span-half' },
        { key: 'se', width: 'span-half' },
        { key: 'mse', width: 'span-full' }
    ];

    let activeWidgets = []; // Tracks currently displayed widgets

    // --- WIDGET LOGIC ---

    function initDashboard() {
        const area = document.getElementById('dashboardArea');
        area.innerHTML = ''; // Clear
        activeWidgets = [];

        initialLayout.forEach(item => {
            addWidgetToDOM(item.key, item.width);
        });

        updateWidgetDropdown();
    }

    function addWidgetToDOM(key, widthClass = 'span-full') {
        if (activeWidgets.includes(key)) return; // Prevent duplicates

        const config = widgetConfig[key];
        const area = document.getElementById('dashboardArea');
        
        // Create HTML Structure
        const div = document.createElement('div');
        div.className = `widget-card ${widthClass}`;
        div.id = `widget-${key}`;
        div.innerHTML = `
            <div class="widget-header">
                <span class="widget-title">${config.title}</span>
                <div class="widget-controls">
                    <button class="widget-icon-btn" onclick="toggleWidgetWidth('${key}')" title="Toggle Width">⇲</button>
                    <button class="widget-icon-btn remove" onclick="removeWidget('${key}')" title="Remove">✕</button>
                </div>
            </div>
            <div class="canvas-container">
                <canvas id="${config.chartId}"></canvas>
            </div>
        `;

        area.appendChild(div);
        activeWidgets.push(key);

        // Initialize Chart.js instance
        const dataObj = config.createData();
        initChartInstance(key, config.chartId, dataObj.sets, dataObj.unified);
        updateWidgetDropdown();
    }

    function removeWidget(key) {
        const el = document.getElementById(`widget-${key}`);
        if(el) {
            // Destroy chart instance to free memory
            if(charts[key]) {
                charts[key].destroy();
                delete charts[key];
            }
            el.remove();
            activeWidgets = activeWidgets.filter(k => k !== key);
            updateWidgetDropdown();
        }
    }

    function addSelectedWidget() {
        const sel = document.getElementById('widgetSelector');
        const key = sel.value;
        if(key) {
            // Default new widgets to full width
            addWidgetToDOM(key, 'span-full');
            sel.value = "";
        }
    }

    function toggleWidgetWidth(key) {
        const el = document.getElementById(`widget-${key}`);
        if (el.classList.contains('span-full')) {
            el.classList.replace('span-full', 'span-half');
        } else {
            el.classList.replace('span-half', 'span-full');
        }
        // Chart needs to know resize happened
        if(charts[key]) charts[key].resize();
    }

    function updateWidgetDropdown() {
        const sel = document.getElementById('widgetSelector');
        sel.innerHTML = '<option value="" disabled selected>Select chart to add...</option>';
        Object.keys(widgetConfig).forEach(key => {
            if(!activeWidgets.includes(key)) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = widgetConfig[key].title;
                sel.appendChild(opt);
            }
        });
        // Disable button if no options
        const btn = document.querySelector('.add-widget-btn');
        btn.disabled = (sel.options.length === 1);
    }

    // --- CHART GENERATION LOGIC ---

    function initChartInstance(key, ctxId, datasets, unified) {
        const finalData = [];
        if (unified) finalData.push(unified);
        if (datasets) finalData.push(...datasets);
        
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
        finalData.forEach((ds, i) => {
            if (ds.isUnified) return;
            const c = ds.borderColor || colors[i % colors.length];
            ds.borderColor = c;
            ds.backgroundColor = c;
            ds.pointRadius = 5;
            ds.pointHoverRadius = 8;
            ds.fill = false;
        });

        const ctx = document.getElementById(ctxId);
        if (!ctx) return;

        // Destroy existing if re-initializing same canvas ID
        if(Chart.getChart(ctxId)) Chart.getChart(ctxId).destroy();

        const newChart = new Chart(ctx, { type: 'line', data: { datasets: finalData }, options: commonOptions });

        // Double Click Handler
        ctx.addEventListener('dblclick', (e) => {
            suppressSingleClickUntil = Date.now() + 400;
            if (newChart.clickTimeout) clearTimeout(newChart.clickTimeout);
            
            // FIX: Explicitly clear the new sticky tooltips when opening modal
            clearStickyTooltips(); 
            
            const activeEls = newChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
            if (!activeEls.length) return;
            const index = activeEls[0].index;
            const datasetIndex = activeEls[0].datasetIndex;
            const point = newChart.data.datasets[datasetIndex].data[index];
            
            if (['Onset','Progression','History'].includes(point.phase)) {
                showHistoryModal(point);
            } else if (point.x) {
                showModalByDate(point.x.split('T')[0]);
            }
        });

        // Hide non-unified by default (same as original logic)
        newChart.data.datasets.forEach(ds => { if (!ds.isUnified) ds.hidden = true; });
        newChart.update();

        charts[key] = newChart;
    }

    // --- SIDEBAR TOGGLES (Updated to check chart existence) ---
    function toggleUnified(type) {
        const chart = charts[type]; if(!chart) return;
        const cb = document.getElementById(`check-unified-${type}`);
        if(chart.data.datasets[0].isUnified) { chart.setDatasetVisibility(0, cb.checked); chart.update(); }
    }
    function toggleDataset(type, label) {
        const chart = charts[type]; if(!chart) return;
        const idx = chart.data.datasets.findIndex(ds => ds.label === label);
        if(idx !== -1) {
            let isChecked = false;
            document.querySelectorAll(`.chk-${type}`).forEach(c => { if(c.value===label) isChecked = c.checked; });
            chart.setDatasetVisibility(idx, isChecked); chart.update();
        }
    }

    // --- SIDEBAR "SELECT ALL" LOGIC ---
    function toggleAll(type, checkbox) {
        const chart = charts[type]; 
        if (!chart) return;

        // 1. Update Chart Datasets (Skip unified)
        chart.data.datasets.forEach((ds, index) => {
            if (!ds.isUnified) {
                 chart.setDatasetVisibility(index, checkbox.checked);
            }
        });
        chart.update();

        // 2. Sync Individual Checkboxes in Sidebar
        document.querySelectorAll(`.chk-${type}`).forEach(cb => {
            cb.checked = checkbox.checked;
        });
    }

    // --- STICKY TOOLTIPS LOGIC (Metadata Based + Scroll Sync + Overlap Prevention) ---

    function showStickyTooltips(dateStr) {
        clearStickyTooltips();
        
        // 1. Collect all Tooltip Candidates (Data & Positions)
        let candidates = [];

        Object.keys(charts).forEach(key => {
            const chart = charts[key];
            if (!chart) return;
            
            const chartArea = chart.chartArea;
            const canvasRect = chart.canvas.getBoundingClientRect();

            chart.data.datasets.forEach((ds, dsIndex) => {
                if (chart.isDatasetVisible(dsIndex)) {
                    // Find matching data point
                    const index = ds.data.findIndex(p => p.x && p.x.toString().startsWith(dateStr));
                    
                    if (index !== -1) {
                        const meta = chart.getDatasetMeta(dsIndex);
                        const element = meta.data[index];

                        if (element && !element.skip) {
                            const x = element.x;
                            const y = element.y;

                            // Bounds Check (Visible area only)
                            if (x >= chartArea.left - 5 && x <= chartArea.right + 5 && 
                                y >= chartArea.top - 5 && y <= chartArea.bottom + 5) {
                                
                                // Calculate Absolute Screen Position
                                const absX = canvasRect.left + x;
                                const absY = canvasRect.top + y;

                                candidates.push({
                                    absX, absY,
                                    dataset: ds,
                                    point: ds.data[index],
                                    chartType: key
                                });
                            }
                        }
                    }
                }
            });
        });

        if (candidates.length === 0) return;

        // 2. Create Elements (Initially hidden to measure size)
        const domElements = candidates.map(c => {
            const el = createTooltipElement(c.absX, c.absY, c.dataset, c.point, c.chartType);
            el.style.opacity = '0'; // Hide during calculation
            return { el, ...c };
        });

        // 3. Collision Resolution (Prevent Overlap)
        // Sort by Y position (top to bottom) so we handle them in order
        domElements.sort((a, b) => a.absY - b.absY);

        for (let i = 0; i < domElements.length; i++) {
            for (let j = i + 1; j < domElements.length; j++) {
                const A = domElements[i];
                const B = domElements[j];

                // Get current positions (getBoundingClientRect is expensive, so we calculate relative)
                const rectA = A.el.getBoundingClientRect();
                const rectB = B.el.getBoundingClientRect();

                // Check Intersection
                const overlapX = (rectA.left < rectB.right && rectA.right > rectB.left);
                const overlapY = (rectA.top < rectB.bottom && rectA.bottom > rectB.top);

                if (overlapX && overlapY) {
                    // Collision Detected! Push B down.
                    const pushDown = (rectA.bottom - rectB.top) + 5;
                    
                    const currentTop = parseFloat(B.el.style.top);
                    B.el.style.top = (currentTop + pushDown) + 'px';
                }
            }
        }

        // 4. Reveal Elements
        domElements.forEach(item => item.el.style.opacity = '1');
    }

    // Helper function to create the DOM element
    function createTooltipElement(x, y, dataset, point, chartType) {
        const div = document.createElement('div');
        div.className = 'sticky-tooltip';
        
        // Position
        div.style.left = x + 'px';
        div.style.top = y + 'px';
        
        // Content
        let valDisplay = point.y;
        if (chartType === 'meds') valDisplay += ' mg';
        
        div.innerHTML = `
            <span class="tooltip-color-box" style="background:${dataset.borderColor}"></span>
            <span style="font-weight:600;">${dataset.label}:</span> ${valDisplay}
        `;
        
        if (point.detail) {
            div.innerHTML += `<div style="margin-top:2px; font-weight:normal; opacity:0.8;">${point.detail}</div>`;
        }
        
        document.body.appendChild(div);
        return div;
    }

    function clearStickyTooltips() {
        document.querySelectorAll('.sticky-tooltip').forEach(el => el.remove());
    }

    // --- POPUP LOGIC (Generic) ---
    function showDailySummary(dateStr, x, y) {
        const popup = document.getElementById('dailySummary');
        const content = document.getElementById('dsContent');
        document.getElementById('dsDate').innerText = dateStr;
        content.innerHTML = '';
        
        let hasData = false;
        // Iterate only over active charts
        Object.keys(charts).forEach(key => {
            const chartObj = charts[key];
            const groupName = widgetConfig[key].title;
            let groupHtml = '';
            chartObj.data.datasets.forEach(ds => {
                if (ds.hidden) return;
                const point = ds.data.find(p => p.x && p.x.startsWith(dateStr));
                if (point) {
                    let val = point.y; let det = point.detail || '';
                    if (key === 'meds') val = `${val} mg`;
                    groupHtml += `<li><span style="color:${ds.borderColor}; font-weight:bold;">● ${ds.label}</span>: ${val} <br><small style="color:#666; margin-left:15px;">${det}</small></li>`;
                }
            });
            if (groupHtml) { content.innerHTML += `<div class="daily-summary-cat">${groupName}</div><ul>${groupHtml}</ul>`; hasData = true; }
        });

        if (!hasData) content.innerHTML = '<em>No visible data points.</em>';
        popup.style.left = Math.min(x + 10, window.innerWidth - 300) + 'px';
        popup.style.top = Math.min(y + 10, window.innerHeight - 300) + 'px';
        popup.style.display = 'block';
    }
    function closeDailySummary() { document.getElementById('dailySummary').style.display = 'none'; }
    
    // Existing Modal Logic (Unchanged but ensured references work)
    function showModalByDate(date) {
        const modal = document.getElementById('visitModal');
        const body = document.getElementById('modalBody');
        document.getElementById('modalDate').innerText = date + " (Full Record)";
        body.innerHTML = '';
        const visit = Object.values(rawData.details).find(v => v.date === date);
        if (!visit) { body.innerHTML = '<p>No full visit record found (Calculated Point).</p>'; modal.style.display='block'; return; }
        const sections = [['Symptoms', visit.symptoms], ['Medications', visit.meds], ['Side Effects', visit.se], ['MSE Findings', visit.mse]];
        sections.forEach(([heading, items]) => {
            if (!items || !items.length) return;
            body.innerHTML += `<h4>${heading}</h4>`;
            items.forEach(i => {
                let line;
                if (heading==='Medications') {
                    if (i.is_tapering && i.taper_plan) {
                        let plan = [];
                        try { plan = JSON.parse(i.taper_plan); } catch(e) {}
                        line = `<strong>${i.name}</strong> <span style="font-size:0.85em; color:#e65100;">Tapering</span><div style="font-size:0.85em; padding-left:10px; border-left:2px solid #ccc; margin-top:4px;">${(plan.map(s => `&#8212; ${s.dose_mg || '—'} (${s.frequency || ''}) x ${s.duration_text || ''}`).join('<br>'))}</div>`;
                    } else {
                        line = `${i.name} — ${i.dose || ''} (${i.freq})`;
                    }
                } else {
                    line = `${i.name} — Score ${i.score}`;
                }
                body.innerHTML += `<div class="detail-row">${line}</div>`;
            });
        });
        modal.style.display = 'block';
    }
    function showHistoryModal(point) {
        document.getElementById('modalDate').innerText = `${point.x.split('T')[0]} (${point.phase})`;
        let contentHtml = '';
        if (point.breakdown && point.breakdown.length > 0) {
            contentHtml += '<ul>';
            point.breakdown.forEach(item => { contentHtml += `<li><strong>${item.name}:</strong> ${item.score}</li>`; });
            contentHtml += '</ul>';
        } else {
            contentHtml += `<p><strong>Score:</strong> ${point.y}</p><p>${point.detail || ''}</p>`;
        }
        document.getElementById('modalBody').innerHTML = `<div style="background:#e3f2fd; padding:15px; border-radius:8px;">${contentHtml}</div>`;
        document.getElementById('visitModal').style.display = 'block';
    }
    function closeModal() { document.getElementById('visitModal').style.display = 'none'; }
    window.onclick = function(event) { 
        // Close Modal Logic
        if (event.target == document.getElementById('visitModal')) closeModal();
        
        // Close Sticky Tooltips Logic
        // If we didn't click a canvas and didn't click a tooltip, clear them.
        if (!event.target.closest('canvas') && !event.target.closest('.sticky-tooltip')) {
            clearStickyTooltips();
            activeStickyDate = null; // Reset state
        }
        
        // Close Daily Summary Popup (if still used)
        const summaryPopup = document.getElementById('dailySummary');
        if (summaryPopup && summaryPopup.style.display === 'block' && !event.target.closest('.daily-summary-popup')) {
            closeDailySummary();
        }
    }

    // Form Logic (Unchanged)
    // --- SMART FREQUENCY DROPDOWN LOGIC ---
    function updateFreqOptions(input) {
        const val = input.value.trim().replace(/-/g, ''); // strip dashes for matching
        const list = document.getElementById('freq-options-list');
        
        // Map inputs like "101" to "1-0-1"
        const map = {
            '1': '1-0-0', '10': '1-0-0', '100': '1-0-0',
            '01': '0-1-0', '010': '0-1-0',
            '001': '0-0-1', 
            '101': '1-0-1', 
            '111': '1-1-1',
            'sos': 'SOS'
        };
        
        if (map[val]) {
            // Create a temporary option to show the suggestion
            let opt = document.createElement('option');
            opt.value = map[val];
            opt.label = `${val} -> ${map[val]}`;
            list.appendChild(opt);
        }
    }
    function updateDurationOptions(input) {
        const v = parseFloat(input.value); if(!isNaN(v)) { 
            const l = document.getElementById('duration-options-list'); l.innerHTML=''; 
            ['Days','Weeks','Months'].forEach(u => { let o=document.createElement('option'); o.value=`${v} ${u}`; l.appendChild(o); });
        }
    }
    // --- SMART DOSE (Life Chart) ---
    function updateDoseOptionsLC(input) {
        const val = input.value.trim();
        const match = val.match(/[\d\.]+/);
        if (!match) return;
        const num = match[0];
        const listId = input.getAttribute('list');
        const list = document.getElementById(listId);
        if (!list) return;
        list.innerHTML = '';
        ['mg', 'g', 'mcg', 'ml', 'IU', 'Tablet'].forEach(unit => {
            const opt = document.createElement('option');
            opt.value = num + ' ' + unit;
            list.appendChild(opt);
        });
    }
    function handleFreqInputLC(input) {
        const container = input.closest('.freq-container');
        updateHiddenFreqLC(container);
        const boxes = container.querySelectorAll('.freq-box');
        if (input === boxes[boxes.length - 1] && input.value !== '') addFreqBoxLC(container.nextElementSibling.querySelector('.add-freq-btn'));
    }
    function addFreqBoxLC(btn) {
        const wrapper = btn.closest('.row-flex').querySelector('.freq-container');
        const sep = document.createElement('span');
        sep.innerText = '-';
        sep.style.margin = '0 2px';
        wrapper.appendChild(sep);
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.className = 'freq-box';
        inp.style = 'width:22px; text-align:center; padding:4px 2px;';
        inp.oninput = function() { handleFreqInputLC(this); };
        wrapper.appendChild(inp);
        updateHiddenFreqLC(wrapper);
    }
    function removeFreqBoxLC(btn) {
        const wrapper = btn.closest('.row-flex').querySelector('.freq-container');
        const boxes = wrapper.querySelectorAll('.freq-box');
        const seps = wrapper.querySelectorAll('span');
        if (boxes.length > 1) {
            boxes[boxes.length - 1].remove();
            if (seps.length > 0) seps[seps.length - 1].remove();
            updateHiddenFreqLC(wrapper);
        }
    }
    function updateHiddenFreqLC(container) {
        const boxes = container.querySelectorAll('.freq-box');
        const values = Array.from(boxes).map(b => b.value.trim() || '0');
        const hiddenInput = container.parentElement.querySelector('input[name="frequency[]"]');
        if (hiddenInput) hiddenInput.value = values.join('-');
    }
    function duplicateTaperRowLC(btn) {
        var currentRow = btn.closest('.entry-wrapper');
        var newRow = currentRow.cloneNode(true);
        var uniqueId = Date.now() + Math.random().toString().slice(2, 6);
        var inputs = newRow.querySelectorAll('input, select, textarea');
        inputs.forEach(function(input) {
            var name = input.getAttribute('name');
            if (name === 'drug_name[]' || name === 'drug_type[]') {
                if (name === 'drug_name[]') {
                    input.readOnly = true;
                    input.style.backgroundColor = '#f0f8ff';
                    input.style.border = '1px dashed #7ab8e0';
                }
            } else if (name === 'frequency[]') {
                input.value = '1-0-1';
            } else if (name === 'dose_full[]') {
                input.value = '';
                input.setAttribute('list', 'dose-list-lc-' + uniqueId);
            } else {
                if (input.type === 'text' || input.type === 'hidden' || input.tagName === 'TEXTAREA') input.value = '';
            }
        });
        var datalist = newRow.querySelector('datalist[id^="dose-list-lc-"]');
        if (datalist) {
            datalist.id = 'dose-list-lc-' + uniqueId;
            datalist.innerHTML = '';
        }
        var freqContainer = newRow.querySelector('.freq-container');
        if (freqContainer) {
            freqContainer.innerHTML = '<input type="text" class="freq-box" value="1" style="width:22px; text-align:center; padding:4px 2px;" oninput="handleFreqInputLC(this)"><span style="margin:0 2px">-</span><input type="text" class="freq-box" value="0" style="width:22px; text-align:center; padding:4px 2px;" oninput="handleFreqInputLC(this)"><span style="margin:0 2px">-</span><input type="text" class="freq-box" value="1" style="width:22px; text-align:center; padding:4px 2px;" oninput="handleFreqInputLC(this)">';
        }
        currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
    }

    function addMedication() {
        const uid = Date.now() + Math.random();
        const h = `<div class="entry-wrapper"><div class="row-flex" style="align-items:center;">
            <select name="drug_type[]" style="width:100px; flex:none;"><option value="Generic" selected>Gen</option><option value="Brand">Brand</option></select>
            <input type="text" name="drug_name[]" placeholder="Drug" style="width:25%;">
            <div style="flex:1; min-width:80px;">
                <input type="text" name="dose_full[]" list="dose-list-lc-${uid}" placeholder="Dose" oninput="updateDoseOptionsLC(this)">
                <datalist id="dose-list-lc-${uid}"></datalist>
            </div>
            <div style="flex:1.5; display:flex; align-items:center; min-width:140px;">
                <input type="hidden" name="frequency[]" value="1-0-1">
                <div class="freq-container" style="display:flex; align-items:center;">
                    <input type="text" class="freq-box" value="1" style="width:22px; text-align:center; padding:4px 2px;" oninput="handleFreqInputLC(this)">
                    <span style="margin:0 2px">-</span>
                    <input type="text" class="freq-box" value="0" style="width:22px; text-align:center; padding:4px 2px;" oninput="handleFreqInputLC(this)">
                    <span style="margin:0 2px">-</span>
                    <input type="text" class="freq-box" value="1" style="width:22px; text-align:center; padding:4px 2px;" oninput="handleFreqInputLC(this)">
                </div>
                <div style="display:flex; flex-direction:column; margin-left:4px;">
                    <button type="button" class="add-freq-btn" onclick="addFreqBoxLC(this)" style="font-size:10px; padding:0 2px; cursor:pointer;">+</button>
                    <button type="button" onclick="removeFreqBoxLC(this)" style="font-size:10px; padding:0 2px; cursor:pointer;">-</button>
                </div>
            </div>
            <input list="duration-options-list" name="med_duration[]" placeholder="Dur" style="flex:1;" oninput="updateDurationOptions(this)">
            <button type="button" class="btn btn-sm" onclick="duplicateTaperRowLC(this)" style="font-size:10px; padding:4px 6px; border-radius:4px; border:1px dashed #7ab8e0; background:#f0f8ff; color:#555;">+ Taper Step</button>
            <button type="button" class="remove-btn" onclick="this.closest('.entry-wrapper').remove()">✕</button>
        </div>
        </div>`;
        document.getElementById('meds-container').insertAdjacentHTML('beforeend', h);
    }

    window.onload = function() {
        initDashboard(); // LOAD DASHBOARD WIDGETS
        
        // DATE LOGIC: Only set default Next Visit Date if the input is empty (Add Mode)
        const nextVisitInput = document.getElementById('nextVisitDate');
        if (!nextVisitInput.value) {
            const d = new Date(); d.setDate(d.getDate() + 30);
            nextVisitInput.value = d.toISOString().split('T')[0];
        }

        // MEDICATION LOGIC: Only add a blank row if container is empty (Add Mode)
        // In Edit Mode, Jinja has already populated the div.
        const medContainer = document.getElementById('meds-container');
        if (medContainer.children.length === 0) {
            addMedication();
        }

        // --- SYNC TOOLTIPS ON VERTICAL SCROLL ---
        const mainContent = document.querySelector('.main-content');
        if (mainContent) {
            mainContent.addEventListener('scroll', () => {
                if (activeStickyDate) {
                    showStickyTooltips(activeStickyDate);
                }
            }, { passive: true }); // passive improves scroll performance
        }
    };

    // --- EXPORT FUNCTIONS ---
    function openDownloadModal() {
        // 1. Calculate Earliest and Latest Dates from JS Chart Data
        let minDate = null;
        let maxDate = null;

        // Loop through all datasets to find absolute min/max
        if (typeof rawData !== 'undefined') {
            // Check all dataset types
            const allDatasets = [
                ...rawData.symptoms,
                ...rawData.meds,
                ...rawData.se,
                ...rawData.mse,
                rawData.symptomsUnified,
                rawData.medsUnified,
                rawData.seUnified,
                rawData.mseUnified
            ].filter(ds => ds && ds.data);

            allDatasets.forEach(ds => {
                if (ds.data) {
                    ds.data.forEach(pt => {
                        if (pt && pt.x) {
                            const d = new Date(pt.x);
                            if (!isNaN(d.getTime())) {
                                if (!minDate || d < minDate) minDate = d;
                                if (!maxDate || d > maxDate) maxDate = d;
                            }
                        }
                    });
                }
            });
        }

        // 2. Set inputs (Format YYYY-MM-DD)
        if (minDate) document.getElementById('exportStartDate').value = minDate.toISOString().split('T')[0];
        if (maxDate) document.getElementById('exportEndDate').value = maxDate.toISOString().split('T')[0];

        // 3. Show Modal
        document.getElementById('downloadModal').style.display = 'block';
    }

    function submitExport() {
        const start = document.getElementById('exportStartDate').value;
        const end = document.getElementById('exportEndDate').value;
        
        // 4. Get Currently Visible Lines (By LABEL Name)
        const checkboxes = document.querySelectorAll('.chk-symptoms, .chk-mse, .chk-se, .chk-meds');
        const visibleLabels = [];
        checkboxes.forEach(cb => {
            if (cb.checked) {
                // The checkbox value is already the label
                visibleLabels.push(cb.value);
            }
        });

        if (!start || !end) {
            alert("Please select both start and end dates.");
            return;
        }

        // 5. Open Preview (Sending 'visible' as names now)
        // EncodeURIComponent ensures special characters in drug names don't break the URL
        const namesParam = visibleLabels.map(s => encodeURIComponent(s)).join(',');
        const url = `{{ url_for('preview_lifechart', patient_id=patient.id) }}?start=${start}&end=${end}&visible=${namesParam}`;
        window.open(url, '_blank');
        document.getElementById('downloadModal').style.display = 'none';
    }
</script>

<div id="downloadModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000;">
    <div style="background:white; margin:10% auto; padding:20px; width:350px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.2);">
        <h3 style="margin-top:0;">Export Life Chart</h3>
        <label style="display:block; margin:10px 0 5px; font-weight:600;">Start Date</label>
        <input type="date" id="exportStartDate" style="width:100%; padding:8px;">
        
        <label style="display:block; margin:10px 0 5px; font-weight:600;">End Date</label>
        <input type="date" id="exportEndDate" style="width:100%; padding:8px;">
        
        <div style="margin-top:20px; text-align:right;">
			<button onclick="submitExport()" class="btn">Preview PDF/Image</button>
			<button onclick="document.getElementById('downloadModal').style.display='none'" class="btn" style="background:#ccc; color:#333;margin-top:20px;">Cancel</button>
        </div>
    </div>
</div>
</body>
</html>