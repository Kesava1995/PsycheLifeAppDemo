<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Chart - {{ patient.name if patient else 'Guest' }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <style>
        :root { --primary: #A5DCFE; --dark: #7ab8e0; --bg: #f4f8fb; --text-main: #333; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); height: 100vh; display: flex; overflow: hidden; }
        
        /* SIDEBAR STYLES (Unchanged) */
        .sidebar { width: 280px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; flex-shrink: 0; z-index: 2; }
        .nav-row { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        .nav-row a { text-decoration: none; color: #555; font-weight: 600; font-size: 0.9rem; }
        .controls { padding: 15px; overflow-y: auto; flex: 1; }
        
        .sidebar-group { background: white; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
        .group-header { background: #f1f3f5; padding: 8px 12px; font-size: 0.85rem; font-weight: 700; color: #495057; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #e9ecef; }
        .list-container { padding: 5px 0; }
        
        .sidebar-item { display: grid; grid-template-columns: 24px 20px 1fr; gap: 8px; align-items: center; padding: 8px 12px; font-size: 0.9rem; color: var(--text-main); cursor: pointer; transition: background 0.15s; border-left: 3px solid transparent; }
        .sidebar-item:hover { background: #f8f9fa; border-left-color: var(--dark); }
        .sidebar-item input { width: 16px; height: 16px; margin: 0; accent-color: var(--dark); cursor: pointer; justify-self: center; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; margin: 0; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1); justify-self: center; }
        .item-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .sidebar-item.unified-item { background: #fcfcfc; border-bottom: 1px dashed #eee; font-weight: 600; }

        /* MAIN CONTENT AREA */
        .main-content { 
            flex: 1; 
            padding: 15px; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
        }

        /* --- NEW WIDGET SYSTEM STYLES --- */
        
        /* Widget Toolbar */
        .widget-toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
        }
        .widget-selector {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
            min-width: 200px;
        }
        .add-widget-btn {
            background: var(--dark);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        .add-widget-btn:hover { background: #5a9bc4; }
        .add-widget-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Grid Container */
        .widget-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 Column Grid */
            gap: 15px;
            align-items: start; /* Prevents stretching height automatically */
        }

        /* Individual Widget Card */
        .widget-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            position: relative;
            /* Enable Both Vertical and Horizontal Resizing */
            resize: both; 
            overflow: hidden; 
            min-height: 250px;
            height: 400px; /* Default Height */
            border: 1px solid #e0e0e0;
            transition: box-shadow 0.2s;
        }
        
        /* New Sticky Tooltip Style (matches standard Chart.js hover look) */
        .sticky-tooltip {
            position: fixed; 
            background: rgba(0, 0, 0, 0.8); /* Standard Chart.js dark background */
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Segoe UI', system-ui, sans-serif;
            pointer-events: none; /* Allows clicking through the tooltip */
            z-index: 5000;
            transform: translate(-50%, -120%); /* Centers and places it above the point */
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.25);
            transition: opacity 0.15s ease-in-out;
        }
        /* Small Triangle Arrow at the bottom */
        .sticky-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }
        .tooltip-color-box {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin-right: 6px;
            border-radius: 2px; /* Slight rounded corners for the box */
            border: 1px solid rgba(255,255,255,0.8);
            vertical-align: middle;
        }

        .widget-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #ccc;
        }
        .widget-card.dragging {
            opacity: 0.5;
            border: 2px dashed var(--dark);
        }
        .widget-card.drag-over {
            border: 2px dashed #ff6b6b;
        }

        /* Sizing Classes for Grid */
        .span-full { grid-column: span 2; }
        .span-half { grid-column: span 1; }

        /* Widget Header */
        .widget-header {
            padding: 8px 12px;
            background: #fdfdfd;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move; /* Implies dragging conceptually */
        }
        .widget-title {
            font-weight: bold;
            color: var(--dark);
            font-size: 0.95rem;
            user-select: none;
        }
        .widget-controls {
            display: flex;
            gap: 8px;
        }
        .widget-icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            font-size: 1.1rem;
            padding: 0;
            line-height: 1;
        }
        .widget-icon-btn:hover { color: #555; }
        .widget-icon-btn.remove:hover { color: red; }

        .canvas-container { 
            flex: 1; 
            position: relative; 
            width: 100%; 
            height: calc(100% - 35px); /* Subtract header height */
            min-height: 0; 
            padding: 5px; 
            box-sizing: border-box;
        }


        /* WORKFLOW INPUTS (Separate Section) */
        .form-section-separator {
            margin-top: 10px;
            border-top: 2px dashed #e0e0e0;
            padding-top: 20px;
        }
        .workflow-card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .row-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        input, textarea, select { width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit; box-sizing: border-box; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; background: var(--dark); width: 100%; font-size: 1rem; }
        
        /* MEDICATION ROW STYLES */
        .entry-wrapper { border: 1px solid #eee; padding: 10px; margin-bottom: 8px; border-radius: 6px; background: #fafafa; }
        .row-flex { display: flex; gap: 10px; align-items: center; }
        .note-btn { background: none; border: none; cursor: pointer; font-size: 1.1rem; color: #999; }
        .note-input { display: none; width: 100%; margin-top: 5px; padding: 5px; border: 1px dashed #ccc; background: #fffdf0; }
        .remove-btn { color: #ff6b6b; background: none; border: none; cursor: pointer; font-weight: bold; }
        .add-btn-small { background: var(--dark); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; float: right; }

        /* MODAL (Double Click) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
        .modal-content { background: white; margin: 5% auto; padding: 25px; width: 60%; max-width: 600px; border-radius: 12px; max-height: 80vh; overflow-y: auto; }
        .detail-row { margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 3px; font-size: 0.9rem; }
        .close-btn { float: right; font-size: 24px; cursor: pointer; color: #aaa; }

        /* DAILY SUMMARY POPUP (Single Click) */
        .daily-summary-popup { display: none; position: absolute; background: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); padding: 15px; z-index: 1500; min-width: 250px; max-width: 350px; font-size: 0.9rem; }
        .daily-summary-header { font-weight: bold; color: var(--dark); margin-bottom: 8px; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .daily-summary-content ul { list-style: none; padding: 0; margin: 0; }
        .daily-summary-content li { margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px dashed #eee; }
        .daily-summary-cat { font-weight: 700; color: #555; font-size: 0.8rem; text-transform: uppercase; margin-top: 5px; margin-bottom: 2px; }
        .pop-close { cursor: pointer; font-size: 16px; color: #999; }
        .pop-close:hover { color: red; }

        /* Chart top bar: avoid squished controls */
        .chart-controls-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 20px;
        }
        .zoom-control select {
            min-width: 150px;
            padding: 5px;
        }

        /* Toggle Switch Styles */
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; margin: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--dark); }
        input:checked + .slider:before { transform: translateX(14px); }
        .slider.round { border-radius: 20px; }
        .slider.round:before { border-radius: 50%; }
    </style>
</head>
<body>
<div class="sidebar">
    <div class="nav-row" style="flex-wrap: wrap; gap: 8px;">
        {% if not guest %}
            <div style="display: flex; justify-content: space-between; width: 100%;">
                <a href="{{ url_for('patient_detail', patient_id=patient.id) if patient else '#' }}">← Patient Details</a>
                <a href="{{ url_for('logout') }}" style="color: red;">Logout</a>
            </div>
            <div style="display: flex; justify-content: space-between; width: 100%; align-items: center; margin-top: 5px;">
                <a href="{{ url_for('dashboard') }}">← Dashboard</a>
                {% if scale_datasets %}
                <div style="display: flex; align-items: center; gap: 6px;">
                    <label class="switch">
                        <input type="checkbox" id="masterScaleToggle" onchange="toggleMasterScales()">
                        <span class="slider round"></span>
                    </label>
                    <span style="font-size: 0.85rem; font-weight: 600; color: #555;">Scales</span>
                </div>
                {% endif %}
            </div>
        {% else %}
            <span style="font-weight: 600; color: #555;">Guest View</span>
            <span style="font-size: 0.8rem; color: #888;">Read Only</span>
        {% endif %}
    </div>
    
    <div class="controls">
        <div class="sidebar-group">
            <div class="group-header">Events & Stressors</div>
            <div style="padding: 10px; display: flex; gap: 10px;">
                <button id="btnStressors" class="btn btn-sm" style="flex:1; padding: 6px; font-size:12px; background:var(--dark); color:white; margin:0;" onclick="toggleEventDataset('symptoms', 'Stressors', this)">Stressors</button>
                <button id="btnEvents" class="btn btn-sm" style="flex:1; padding: 6px; font-size:12px; background:var(--dark); color:white; margin:0;" onclick="toggleEventDataset('symptoms', 'Major Events', this)">Major Events</button>
            </div>
        </div>
        <div class="sidebar-group">
            <div class="group-header">Symptom Trajectory</div>
            <div class="list-container">
                <label class="sidebar-item unified-item">
                    <input type="checkbox" id="check-unified-symptoms" checked onchange="toggleUnified('symptoms')">
                    <span class="color-dot" style="background:black;"></span>
                    <span class="item-text">Unified (Average)</span>
                </label>
                <label class="sidebar-item" style="border-bottom:1px solid #eee; margin-bottom:5px;">
                    <input type="checkbox" onchange="toggleAll('symptoms', this)">
                    <span></span> <span class="item-text" style="font-weight:700; color:#555; font-style:italic;">Select All</span>
                </label>
                {% for ds in symptom_datasets %}
                <label class="sidebar-item">
                    <input type="checkbox" class="chk-symptoms" value="{{ ds.label }}" onchange="toggleDataset('symptoms', '{{ ds.label }}')">
                    <span class="color-dot" style="background:{{ ds.borderColor }};"></span>
                    <span class="item-text">{{ ds.label }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="sidebar-group">
            <div class="group-header">Medications</div>
            <div class="list-container">
                <label class="sidebar-item unified-item">
                    <input type="checkbox" id="check-unified-meds" checked onchange="toggleUnified('meds')">
                    <span class="color-dot" style="background:black;"></span>
                    <span class="item-text">Unified (Average)</span>
                </label>
                <label class="sidebar-item" style="border-bottom:1px solid #eee; margin-bottom:5px;">
                    <input type="checkbox" onchange="toggleAll('meds', this)">
                    <span></span> <span class="item-text" style="font-weight:700; color:#555; font-style:italic;">Select All</span>
                </label>
                {% for ds in medication_datasets %}
                <label class="sidebar-item">
                    <input type="checkbox" class="chk-meds" value="{{ ds.label }}" onchange="toggleDataset('meds', '{{ ds.label }}')">
                    <span class="color-dot" style="background:{{ ds.borderColor }};"></span>
                    <span class="item-text">{{ ds.label }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="sidebar-group">
            <div class="group-header">Side Effects</div>
            <div class="list-container">
                <label class="sidebar-item unified-item">
                    <input type="checkbox" id="check-unified-se" checked onchange="toggleUnified('se')">
                    <span class="color-dot" style="background:black;"></span>
                    <span class="item-text">Unified (Average)</span>
                </label>
                <label class="sidebar-item" style="border-bottom:1px solid #eee; margin-bottom:5px;">
                    <input type="checkbox" onchange="toggleAll('se', this)">
                    <span></span> <span class="item-text" style="font-weight:700; color:#555; font-style:italic;">Select All</span>
                </label>
                {% for ds in side_effect_datasets %}
                <label class="sidebar-item">
                    <input type="checkbox" class="chk-se" value="{{ ds.label }}" onchange="toggleDataset('se', '{{ ds.label }}')">
                    <span class="color-dot" style="background:{{ ds.borderColor }};"></span>
                    <span class="item-text">{{ ds.label }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="sidebar-group">
            <div class="group-header">MSE Findings</div>
            <div class="list-container">
                <label class="sidebar-item unified-item">
                    <input type="checkbox" id="check-unified-mse" checked onchange="toggleUnified('mse')">
                    <span class="color-dot" style="background:black;"></span>
                    <span class="item-text">Unified (Average)</span>
                </label>
                <label class="sidebar-item" style="border-bottom:1px solid #eee; margin-bottom:5px;">
                    <input type="checkbox" onchange="toggleAll('mse', this)">
                    <span></span> <span class="item-text" style="font-weight:700; color:#555; font-style:italic;">Select All</span>
                </label>
                {% for ds in mse_datasets %}
                <label class="sidebar-item">
                    <input type="checkbox" class="chk-mse" value="{{ ds.label }}" onchange="toggleDataset('mse', '{{ ds.label }}')">
                    <span class="color-dot" style="background:{{ ds.borderColor }};"></span>
                    <span class="item-text">{{ ds.label }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        {% if scale_datasets %}
        <div class="sidebar-group" id="sidebar-group-scale" style="display: none;">
            <div class="group-header">Scale Assessments</div>
            <div class="list-container">
                <label class="sidebar-item unified-item">
                    <input type="checkbox" id="check-unified-scale" checked onchange="toggleUnified('scale')">
                    <span class="color-dot" style="background:black;"></span>
                    <span class="item-text">Unified (Average)</span>
                </label>
                <label class="sidebar-item" style="border-bottom:1px solid #eee; margin-bottom:5px;">
                    <input type="checkbox" onchange="toggleAll('scale', this)">
                    <span></span> <span class="item-text" style="font-weight:700; color:#555; font-style:italic;">Select All</span>
                </label>
                {% for ds in scale_datasets %}
                <label class="sidebar-item">
                    <input type="checkbox" class="chk-scale" value="{{ ds.label }}" onchange="toggleDataset('scale', '{{ ds.label }}')">
                    <span class="color-dot" style="background:{{ ds.borderColor }};"></span>
                    <span class="item-text">{{ ds.label }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="main-content">
    
    <div class="widget-toolbar chart-controls-container">
        <div style="display: flex; gap: 10px; flex-wrap: nowrap; align-items: center;">
            <div style="display: flex; gap: 5px;">
                <select id="widgetSelector" class="widget-selector" style="min-width: 150px;">
                    <option value="" disabled selected>Insert chart...</option>
                </select>
                <button onclick="addSelectedWidget()" class="add-widget-btn">Add</button>
            </div>
            <div style="display: flex; gap: 5px; padding-left: 10px;">
                <select id="removeWidgetSelector" class="widget-selector" style="min-width: 150px;">
                    <option value="" disabled selected>Remove chart...</option>
                </select>
                <button onclick="removeSelectedWidget()" class="add-widget-btn" style="background: #f5576c;">Remove</button>
            </div>
        </div>

        <div class="zoom-control" style="display: flex; align-items: center; gap: 10px; margin-left: auto; margin-right: 10px;">
            <select id="zoomSelect" onchange="handleZoomSelect(this.value)" class="btn btn-sm" style="background: white; border: 1px dashed #7ab8e0; color: #333; margin: 0;">
                <option value="">Zoom View...</option>
                <option value="all">Show All (Reset)</option>
                <option value="week">Week-wise</option>
                <option value="month">Month-wise</option>
                <option value="year">Year-wise</option>
                <option value="custom">Custom Range</option>
            </select>
            <div id="customZoomDiv" style="display:none; align-items:center; gap:5px;">
                <input type="date" id="zoomStart" class="btn btn-sm" style="background:white; border:1px solid #ccc; padding:4px; margin:0;">
                <input type="date" id="zoomEnd" class="btn btn-sm" style="background:white; border:1px solid #ccc; padding:4px; margin:0;">
                <button class="btn btn-sm" onclick="applyCustomZoom()" style="background:#7ab8e0; color:white; margin:0;">Go</button>
            </div>
        </div>
        <button onclick="openDownloadModal()" class="btn" style="padding: 5px 10px; font-size: 13px; height: 30px; background: #555; color: white;">Download</button>
    </div>

    <div id="dashboardArea" class="widget-grid">
        </div>

    {% if request.args.get('view_only') != '1' %}
    <div class="form-section-separator"></div>

    <div class="workflow-card">
        <form method="POST" enctype="multipart/form-data" action="{% if guest %}{{ url_for('guest_lifechart_proxy') }}{% elif visit %}{{ url_for('update_clinical', visit_id=visit.id) }}{% else %}{{ url_for('add_visit', patient_id=patient.id) }}{% endif %}">
            
            {% if guest %}
            <input type="hidden" name="is_chart_update" value="true">
            {% endif %}
            
            <h3 style="margin-top:0; color:#333; border-bottom:1px solid #eee; padding-bottom:10px;">
                {{ 'Edit Visit Details' if visit else 'Save New Visit from Chart' }}
            </h3>

            <div class="row-2-col">
                <div>
                    <label style="display:block; margin-bottom:5px; font-weight:600; color:#555;">Provisional Diagnosis</label>
                    <textarea name="provisional_diagnosis" rows="2">{{ visit.provisional_diagnosis if visit else '' }}</textarea>
                </div>
                <div>
                    <label style="display:block; margin-bottom:5px; font-weight:600; color:#555;">Differential Diagnosis</label>
                    <textarea name="differential_diagnosis" rows="2">{{ visit.differential_diagnosis if visit else '' }}</textarea>
                </div>
            </div>

            <div style="margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                <h4 style="margin:0 0 10px 0; color:#555;">Current Clinical State</h4>
                <button type="button" class="btn" style="margin-top:0; padding:8px 14px; font-size:12px; background:#666; color:#fff; width:auto;" onclick="openClinicalStateRangesModal()">Manage Clinical State Ranges (dates)</button>
                <input type="hidden" name="clinical_state_data" id="clinical_state_data" value="{% if clinical_states is defined and clinical_states %}{{ clinical_states | tojson | e }}{% else %}[]{% endif %}">
            </div>

            <div style="margin-bottom: 20px;">
                <h4 style="margin:0 0 10px 0; color:#555; display:flex; align-items:center;">
                    <span style="flex-grow: 1;">Medications</span>
                    <button type="button" class="add-btn-small" onclick="addMedication()" style="margin-right: 10px;">+</button>
                    <button type="button" class="btn" onclick="document.getElementById('modalEqDose').style.display='block'" style="padding: 5px 15px; font-size: 12px; background: #666; color: #fff; width: auto; line-height: 1; margin: 0; white-space: nowrap;">⚖️ Equivalent Dose</button>
                </h4>
                <div style="margin-bottom: 15px; display: flex; align-items: center;">
                    <label style="font-size: 13px; font-weight: 600; color: #555; margin-right: 10px; margin-bottom: 0;">Medication Adherence:</label>
                    <button type="button" class="btn" style="margin-left:0; padding:6px 12px; font-size:12px; background:#666; color:#fff; margin-top:0; width:auto;" onclick="openAdherenceRangesModal()">Manage Adherence Ranges (dates)</button>
                    <input type="hidden" name="adherence_data" id="adherence_data" value="{% if adherences is defined and adherences %}{{ adherences | tojson | e }}{% else %}[]{% endif %}">
                </div>
                <div id="meds-container">
                    {% if visit and visit.medication_entries %}
                        {% for entry in visit.medication_entries %}
                            {% if entry.is_tapering and entry.taper_plan %}
                                {% set steps = entry.taper_plan|from_json %}
                                {% for step in steps %}
                                {% set unique_id = (entry.id|string ~ '_' ~ loop.index|string) if entry.id else loop.index %}
                                {% set step_freq = step.frequency|default('1-0-1') %}
                                <div class="entry-wrapper">
                                    <div class="row-flex" style="align-items: center; gap: 8px; flex-wrap: wrap;">
                                        <select name="drug_type[]" style="width: 80px; flex: none; font-size: 13px; padding: 8px 4px;">
                                            <option value="Generic" {% if entry.drug_type == 'Generic' or not entry.drug_type %}selected{% endif %}>Gen</option>
                                            <option value="Brand" {% if entry.drug_type == 'Brand' %}selected{% endif %}>Brand</option>
                                        </select>
                                        <select name="med_form[]" style="width: 90px; flex: none; font-size: 13px; padding: 8px 4px;">
                                            <option value="Tablet" {% if (entry.form_type or 'Tablet')=='Tablet' %}selected{% endif %}>Tablet</option>
                                            <option value="Capsule" {% if entry.form_type=='Capsule' %}selected{% endif %}>Capsule</option>
                                            <option value="Injection" {% if entry.form_type=='Injection' %}selected{% endif %}>Injection</option>
                                        </select>
                                        <input type="text" name="drug_name[]" value="{{ entry.drug_name }}" placeholder="Drug Name" style="flex: 2; min-width: 120px; padding: 8px; {% if loop.index0 > 0 %}background:#f0f8ff; border:1px dashed #7ab8e0;{% endif %}" {% if loop.index0 > 0 %}readonly{% endif %}>
                                        <div style="flex: 1; min-width: 80px;">
                                            <input type="text" name="dose_full[]" value="{{ step.dose_mg or '' }}" list="dose-list-lc-{{ unique_id }}" placeholder="Dose" style="width: 100%; padding: 8px;" oninput="updateDoseOptionsLC(this)">
                                            <datalist id="dose-list-lc-{{ unique_id }}"></datalist>
                                        </div>
                                        <div style="display: flex; align-items: center; border: 1px solid #ddd; border-radius: 4px; padding: 2px 6px; background: #fff; flex: none;">
                                            <input type="hidden" name="frequency[]" value="{{ step_freq }}">
                                            <div class="freq-container" style="display:flex; align-items:center;">
                                                {% set parts = step_freq.split('-') if step_freq and '-' in step_freq else [step_freq] if step_freq else ['1','0','1'] %}
                                                {% for p in parts %}
                                                <input type="text" class="freq-box" value="{{ p }}" style="width:25px; text-align:center; padding:5px 2px; border: none; border-bottom: 1px solid #eee; outline: none; background: transparent;" oninput="handleFreqInputLC(this)">
                                                {% if not loop.last %}<span style="margin:0 2px; color: #888;">-</span>{% endif %}
                                                {% endfor %}
                                            </div>
                                            <div style="display:flex; flex-direction:column; margin-left:4px;">
                                                <button type="button" class="add-freq-btn" onclick="addFreqBoxLC(this)" style="font-size:10px; line-height:10px; padding:0 2px; cursor:pointer; margin-bottom:1px; background: none; border: 1px solid #ddd; border-radius: 2px;">+</button>
                                                <button type="button" onclick="removeFreqBoxLC(this)" style="font-size:10px; line-height:10px; padding:0 2px; cursor:pointer; background: none; border: 1px solid #ddd; border-radius: 2px;">-</button>
                                            </div>
                                        </div>
                                        <input list="duration-options-list" name="med_duration[]" value="{{ step.duration_text or '' }}" placeholder="Dur" style="width: 80px; flex: none; padding: 8px;" oninput="updateDurationOptions(this)">
                                        <div style="display:flex; gap:5px; flex:none; align-items: center;">
                                            <button type="button" class="btn btn-sm" onclick="duplicateTaperRowLC(this)" style="padding:6px 10px; font-size:11px; border-radius:4px; border:1px dashed #7ab8e0; background:#f0f8ff; color:#555; margin: 0; line-height: 1;">+ Taper</button>
                                            <button type="button" class="remove-btn" onclick="this.closest('.entry-wrapper').remove()" style="margin: 0; font-size: 16px;">✕</button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                {% set unique_id = entry.id if entry.id else loop.index %}
                                <div class="entry-wrapper">
                                    <div class="row-flex" style="align-items: center; gap: 8px; flex-wrap: wrap;">
                                        <select name="drug_type[]" style="width: 80px; flex: none; font-size: 13px; padding: 8px 4px;">
                                            <option value="Generic" {% if entry.drug_type == 'Generic' or not entry.drug_type %}selected{% endif %}>Gen</option>
                                            <option value="Brand" {% if entry.drug_type == 'Brand' %}selected{% endif %}>Brand</option>
                                        </select>
                                        <select name="med_form[]" style="width: 90px; flex: none; font-size: 13px; padding: 8px 4px;">
                                            <option value="Tablet" {% if (entry.form_type or 'Tablet')=='Tablet' %}selected{% endif %}>Tablet</option>
                                            <option value="Capsule" {% if entry.form_type=='Capsule' %}selected{% endif %}>Capsule</option>
                                            <option value="Injection" {% if entry.form_type=='Injection' %}selected{% endif %}>Injection</option>
                                        </select>
                                        <input type="text" name="drug_name[]" value="{{ entry.drug_name }}" placeholder="Drug Name" style="flex: 2; min-width: 120px; padding: 8px;">
                                        <div style="flex: 1; min-width: 80px;">
                                            <input type="text" name="dose_full[]" value="{{ entry.dose_mg or '' }}" list="dose-list-lc-{{ unique_id }}" placeholder="Dose" style="width: 100%; padding: 8px;" oninput="updateDoseOptionsLC(this)">
                                            <datalist id="dose-list-lc-{{ unique_id }}"></datalist>
                                        </div>
                                        <div style="display: flex; align-items: center; border: 1px solid #ddd; border-radius: 4px; padding: 2px 6px; background: #fff; flex: none;">
                                            <input type="hidden" name="frequency[]" value="{{ entry.frequency or '1-0-1' }}">
                                            <div class="freq-container" style="display:flex; align-items:center;">
                                                {% set parts = entry.frequency.split('-') if entry.frequency and '-' in entry.frequency else [entry.frequency] if entry.frequency else ['1','0','1'] %}
                                                {% for p in parts %}
                                                <input type="text" class="freq-box" value="{{ p }}" style="width:25px; text-align:center; padding:5px 2px; border: none; border-bottom: 1px solid #eee; outline: none; background: transparent;" oninput="handleFreqInputLC(this)">
                                                {% if not loop.last %}<span style="margin:0 2px; color: #888;">-</span>{% endif %}
                                                {% endfor %}
                                            </div>
                                            <div style="display:flex; flex-direction:column; margin-left:4px;">
                                                <button type="button" class="add-freq-btn" onclick="addFreqBoxLC(this)" style="font-size:10px; line-height:10px; padding:0 2px; cursor:pointer; margin-bottom:1px; background: none; border: 1px solid #ddd; border-radius: 2px;">+</button>
                                                <button type="button" onclick="removeFreqBoxLC(this)" style="font-size:10px; line-height:10px; padding:0 2px; cursor:pointer; background: none; border: 1px solid #ddd; border-radius: 2px;">-</button>
                                            </div>
                                        </div>
                                        <input list="duration-options-list" name="med_duration[]" value="{{ entry.duration_text or '' }}" placeholder="Dur" style="width: 80px; flex: none; padding: 8px;" oninput="updateDurationOptions(this)">
                                        <div style="display:flex; gap:5px; flex:none; align-items: center;">
                                            <button type="button" class="btn btn-sm" onclick="duplicateTaperRowLC(this)" style="padding:6px 10px; font-size:11px; border-radius:4px; border:1px dashed #7ab8e0; background:#f0f8ff; color:#555; margin: 0; line-height: 1;">+ Taper</button>
                                            <button type="button" class="remove-btn" onclick="this.closest('.entry-wrapper').remove()" style="margin: 0; font-size: 16px;">✕</button>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <div style="background:#f9fafb; padding:15px; border-radius:8px; margin-top:20px; display:flex; gap:20px; align-items:center;">
                <div>
                    <label style="font-weight:600; color:#555;">Next Follow-up Date</label>
                    <input type="date" name="next_visit_date" id="nextVisitDate" value="{{ visit.next_visit_date.strftime('%Y-%m-%d') if visit and visit.next_visit_date else '' }}">
                </div>
                <div style="flex:1;">
                    <label style="font-weight:600; color:#555;">Visit Note</label>
                    <input type="text" name="visit_note" value="{{ visit.note if visit else '' }}" placeholder="Summary...">
                </div>
                <input type="hidden" name="date" value="{{ visit.date.strftime('%Y-%m-%d') if visit and visit.date else today }}">
            </div>

            <div style="margin-top:20px; display:flex; gap:10px;">
                {% if guest %}
                <button type="submit" formaction="{{ url_for('guest_lifechart_proxy') }}" class="btn" style="background:#f5576c;">Refresh Chart (Guest)</button>
                <button type="button" onclick="openGuestDoctorModal('{{ url_for('guest_both') }}')" class="btn" style="background:#7BC4F0; color:#000;">Gen Prescription (Guest)</button>
                {% else %}
                <button type="submit" name="submit_action" value="lifechart" class="btn" style="background:#f5576c;">{{ 'Update & Refresh Chart' if visit else 'Save & Refresh Chart' }}</button>
                <button type="submit" name="submit_action" value="prescription" class="btn" style="background:#7BC4F0; color:#000;">{{ 'Update & Gen Prescription' if visit else 'Save & Gen Prescription' }}</button>
                {% endif %}
            </div>

            <div id="guestDoctorModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
                <div style="background:white; padding:30px; border-radius:12px; width:500px; max-height:90vh; overflow-y:auto; text-align:left; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <h3 style="margin-top:0; color:#7ab8e0; border-bottom:1px solid #eee; padding-bottom:10px;">Doctor Profile Details</h3>
                    <p style="font-size:12px; color:#666; margin-bottom:20px;">These details are required to generate your prescription header.</p>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div>
                            <label style="font-size: 12px; font-weight: bold;">Full Name (as on Prescription) *</label>
                            <input type="text" name="doc_name" required value="{% if guest_doctor %}{{ guest_doctor.name }}{% endif %}" class="form-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label style="font-size: 12px; font-weight: bold;">Qualification *</label>
                                <input type="text" name="doc_qual" required value="{% if guest_doctor %}{{ guest_doctor.qualification }}{% endif %}" class="form-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 12px; font-weight: bold;">Registration Number *</label>
                                <input type="text" name="doc_reg" required value="{% if guest_doctor %}{{ guest_doctor.registration }}{% endif %}" class="form-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: bold;">Clinic / Hospital Name</label>
                            <input type="text" name="doc_clinic" value="{% if guest_doctor %}{{ guest_doctor.clinic }}{% endif %}" class="form-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: bold;">Full Clinic Address</label>
                            <textarea name="doc_address" class="form-input" rows="2" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">{% if guest_doctor %}{{ guest_doctor.address }}{% endif %}</textarea>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label style="font-size: 12px; font-weight: bold;">Phone Number (For Patients)</label>
                                <input type="text" name="doc_phone" value="{% if guest_doctor %}{{ guest_doctor.phone }}{% endif %}" class="form-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 12px; font-weight: bold;">Email Address</label>
                                <input type="email" name="doc_email" value="{% if guest_doctor %}{{ guest_doctor.email }}{% endif %}" class="form-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: bold;">Social Media Handle (Optional)</label>
                            <input type="text" name="doc_social" value="{% if guest_doctor %}{{ guest_doctor.social }}{% endif %}" class="form-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div style="margin-top:5px;">
                            <label style="font-size: 12px; font-weight: bold; color:#d9534f;">Digital Signature (Image) *</label>
                            {% if guest_signature_b64 %}
                                <p style="font-size: 11px; color: #2ecc71; margin-bottom: 5px; font-weight: bold;">✓ Signature already uploaded</p>
                                <input type="file" name="doc_signature" accept="image/*" style="display:block; font-size:12px;">
                            {% else %}
                                <input type="file" name="doc_signature" accept="image/*" required style="display:block; margin-top:5px; font-size:12px;">
                            {% endif %}
                        </div>
                    </div>
                    
                    <div style="display:flex; gap:10px; margin-top:25px;">
                        <button type="button" onclick="document.getElementById('guestDoctorModal').style.display='none'" class="btn" style="flex:1; background:#eee; color:#333; font-weight:bold;">Cancel</button>
                        <button type="submit" id="guestModalSubmitBtn" class="btn" style="flex:1; background:#7ab8e0; color:#fff; font-weight:bold;">Proceed</button>
                    </div>
                </div>
            </div>
            <script>
                function openGuestDoctorModal(actionUrl) {
                    document.getElementById('guestModalSubmitBtn').setAttribute('formaction', actionUrl);
                    document.getElementById('guestDoctorModal').style.display = 'flex';
                }
            </script>
        </form>
    </div>
    {% endif %}
</div>

<div id="dailySummary" class="daily-summary-popup">
    <div class="daily-summary-header">
        <span id="dsDate">Date</span>
        <span class="pop-close" onclick="closeDailySummary()">✕</span>
    </div>
    <div class="daily-summary-content" id="dsContent"></div>
</div>

<div id="visitModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 id="modalDate" class="visit-date"></h2>
        <div id="modalBody"></div>
    </div>
</div>

<datalist id="duration-options-list"></datalist>
<datalist id="freq-options-list">
    <option value="1-0-0">Morning</option>
    <option value="1-0-1">Morning & Night</option>
	<option value="1-0-1">Morning & Afternoon</option>
    <option value="0-0-1">Night</option>
    <option value="1-1-1">Morning, Afternoon & Night</option>
    <option value="0-1-0">Afternoon</option>
    <option value="SOS">As Needed</option>
</datalist>

<script>
    // --- DATA ---
    const rawData = {
        symptoms: {{ symptom_datasets | tojson }},
        symptomsUnified: {{ symptom_unified | tojson }},
        meds: {{ medication_datasets | tojson }}, 
        medsUnified: {{ med_unified | tojson }},
        se: {{ side_effect_datasets | tojson }}, 
        seUnified: {{ se_unified | tojson }},
        mse: {{ mse_datasets | tojson }},
        mseUnified: {{ mse_unified | tojson }},
        scale: {{ scale_datasets | default([]) | tojson }},
        scaleUnified: {{ scale_unified | default('null') | tojson }},
        details: {{ visit_details | tojson }},
        events: {{ events | default([]) | tojson }},
        stressors: {{ stressors | default([]) | tojson }},
        substances: {{ substances | default([]) | tojson }}
    };
    const subColors = {
        "Alcohol": { base: "#B3742A", light: "#E3B07A", dark: "#8C4F16", medium: "#B3742A" },
        "Tobacco (Smoked)": { base: "#5E5E5E", light: "#A0A0A0", dark: "#3A3A3A", medium: "#5E5E5E" },
        "Smokeless Tobacco": { base: "#8B6B4A", light: "#C6A889", dark: "#5F472F", medium: "#8B6B4A" },
        "Cannabis": { base: "#6C7A3C", light: "#A6B574", dark: "#4A5426", medium: "#6C7A3C" },
        "Opioids": { base: "#3E4F6A", light: "#7D8DA6", dark: "#2A3649", medium: "#3E4F6A" },
        "Stimulants": { base: "#A35A2B", light: "#D59B74", dark: "#703B18", medium: "#A35A2B" }
    };
    function getSubstanceStyle(sub, pattern) {
        let c = subColors[sub] || subColors["Alcohol"];
        if (pattern === "Occasional") return { bg: 'transparent', border: c.base, dash: [4,4] };
        if (pattern === "Weekends") return { bg: c.light, border: c.base, dash: [] };
        if (pattern === "Daily") return { bg: c.medium, border: c.base, dash: [] };
        if (pattern === "Severe/Early morning intake") return { bg: c.dark, border: c.dark, dash: [] };
        return { bg: c.base, border: c.base, dash: [] };
    }
    const backendClinicalStates = {{ clinical_states | default([]) | tojson }};
    const backendAdherences = {{ adherences | default([]) | tojson }};
	
	let suppressSingleClickUntil = 0;
    let charts = {}; // Global chart instance storage
    let activeStickyDate = null; // Remember active date for zoom/pan sync
    let isPanning = false;

    // --- CHART OPTIONS (Now a function to prevent infinite loop object merging) ---
    function getCommonOptions() {
        return {
            responsive: true, maintainAspectRatio: false, 
            layout: { padding: { top: 45 } }, 
            scales: {
                x: { type: 'time', time: { unit: 'day' }, title: { display: true, text: 'Date' } },
                y: { beginAtZero: true, min: 0, title: { display: true, text: 'Score' }, grace: '10%' } 
            },
            plugins: {
                zoom: {
                    limits: {
                        y: { min: 0 }
                    },
                    zoom: {
                        wheel: { enabled: true },
                        pinch: { enabled: true },
                        mode: 'x',
                        scaleMode: 'y',
                        onZoomStart: () => { clearStickyTooltips(); },
                        onZoomComplete: ({chart}) => { if(activeStickyDate) showStickyTooltips(activeStickyDate); }
                    },
                    pan: {
                        enabled: true, 
                        mode: 'xy',
                        onPanStart: () => { 
                            isPanning = true; 
                            clearStickyTooltips(); 
                        },
                        onPanComplete: ({chart}) => { 
                            if(activeStickyDate) showStickyTooltips(activeStickyDate);
                            setTimeout(() => { isPanning = false; }, 100); 
                        }
                    }
                },
                tooltip: {
                    enabled: true,
                    mode: 'nearest',
                    intersect: true,
                    callbacks: {
                        title: function(context) {
                            const pt = context[0].raw;
                            if (pt && pt.x) return pt.x.split('T')[0];
                            return context[0].label;
                        },
                        label: function(context) {
                            const dsLabel = context.dataset.label;
                            const pt = context.raw;

                            if (dsLabel === 'Major Events' || dsLabel === 'Stressors') {
                                let lines = [`${dsLabel}: ${pt.title || ''}`];
                                if (pt.duration) lines.push(`Duration: ${pt.duration}`);
                                if (pt.detail) lines.push(`Note: ${pt.detail}`);
                                return lines;
                            }

                            let val = pt.y;
                            if (context.chart.config._configKey === 'meds') val += ' mg';
                            let lines = [`${dsLabel}: ${val}`];
                            if (pt.detail && pt.detail !== 'Average') {
                                lines.push(`Note: ${pt.detail}`);
                            }
                            return lines;
                        }
                    }
                },
                legend: { display: false } 
            },
            onClick: (e, activeEls, chart) => {
                if (isPanning) return; // Abort if we just finished dragging
                if (Date.now() < suppressSingleClickUntil) return;
                if (chart.clickTimeout) clearTimeout(chart.clickTimeout);

                chart.clickTimeout = setTimeout(() => {
                    // FIX: Changed intersect to TRUE so it ONLY triggers on actual data points
                    const points = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);

                    if (points.length > 0) {
                        const firstPoint = points[0];
                        const dataItem = chart.data.datasets[firstPoint.datasetIndex].data[firstPoint.index];
                        
                        if (dataItem && dataItem.x) {
                            const dateStr = dataItem.x.split('T')[0];
                            activeStickyDate = dateStr; 
                            showStickyTooltips(dateStr);
                        }
                    } 
                    // NOTE: Removed the entire fallback block that triggered clicks on empty space
                }, 220); 
            }
        };
    }

    // --- CLINICAL OVERLAY PLUGIN (labels in ribbons, hover tooltip) ---
    const clinicalOverlayPlugin = {
        id: 'clinicalOverlay',

        afterDraw(chart) {
            const { ctx, chartArea, scales } = chart;
            if (!chartArea) return;

            const topY = chartArea.top;
            const bottomY = chartArea.bottom;
            const xScale = scales.x;
            const bottomPadding = chart.options.scales?.x?.ticks?.padding || 0;

            chart.$ribbons = [];
            ctx.save();

            ctx.beginPath();
            ctx.rect(chartArea.left, 0, chartArea.right - chartArea.left, chartArea.bottom + bottomPadding);
            ctx.clip();

            /* ========================= 1️⃣ CLINICAL STATE ========================== */
            if (chart.config._configKey === 'symptoms') {
                (backendClinicalStates || []).forEach(state => {
                    if (!state.start || !state.end) return;

                    const startMs = new Date(state.start).valueOf();
                    const endMs = new Date(state.end).valueOf();
                    const xMin = xScale.getPixelForValue(startMs);
                    const xMax = xScale.getPixelForValue(endMs);
                    const height = 28;
                    const laneTop = topY - height - 5;

                    ctx.fillStyle = 'rgba(164,194,244,0.7)';
                    ctx.fillRect(xMin, laneTop, xMax - xMin, height);

                    ctx.fillStyle = '#222';
                    ctx.font = '12px Segoe UI';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(state.state, xMin + 6, laneTop + height / 2);

                    chart.$ribbons.push({
                        xMin, xMax,
                        yMin: laneTop,
                        yMax: laneTop + height,
                        title: state.state,
                        duration: `${state.start} → ${state.end}`,
                        note: state.note || '',
                        type: 'Clinical State'
                    });
                });
            }

            /* ========================= 2️⃣ ADHERENCE ========================== */
            (backendAdherences || []).forEach(ad => {
                if (!ad.start || !ad.end) return;

                const startMs = new Date(ad.start).valueOf();
                const endMs = new Date(ad.end).valueOf();
                const xMin = xScale.getPixelForValue(startMs);
                const xMax = xScale.getPixelForValue(endMs);
                const height = 22;

                if (chart.config._configKey === 'symptoms') {
                    const laneTop = bottomY + 5;
                    ctx.fillStyle = 'rgba(34,139,34,0.15)';
                    ctx.fillRect(xMin, laneTop, xMax - xMin, height);

                    ctx.fillStyle = '#000';
                    ctx.font = '11px Segoe UI';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(ad.status, xMin + 6, laneTop + height/2);

                    chart.$ribbons.push({
                        xMin, xMax,
                        yMin: laneTop,
                        yMax: laneTop + height,
                        title: ad.status,
                        duration: `${ad.start} → ${ad.end}`,
                        note: ad.note || '',
                        type: 'Adherence'
                    });
                }

                if (chart.config._configKey === 'meds') {
                    const medHeight = 28;
                    const laneTop = topY - medHeight - 5;

                    ctx.fillStyle = 'rgba(34,139,34,0.8)';
                    ctx.fillRect(xMin, laneTop, xMax - xMin, medHeight);

                    ctx.fillStyle = '#fff';
                    ctx.font = '12px Segoe UI';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(ad.status, xMin + 6, laneTop + 14);

                    chart.$ribbons.push({
                        xMin, xMax,
                        yMin: laneTop,
                        yMax: laneTop + medHeight,
                        title: ad.status,
                        duration: `${ad.start} → ${ad.end}`,
                        note: ad.note || '',
                        type: 'Adherence'
                    });
                }
            });

            /* ========================= 3️⃣ SUBSTANCES ========================== */
            if (chart.config._configKey === 'symptoms') {
                const uniqueSubs = [...new Set((rawData.substances || []).map(s => s.substance))];

                uniqueSubs.forEach((sub, idx) => {
                    // REQUIREMENT 3: Draw progressively below Adherence lane in the Free Zone
                    const laneTop = bottomY + 30 + (idx * 22);

                    (rawData.substances || [])
                        .filter(s => s.substance === sub)
                        .forEach(su => {
                            const startMs = new Date(su.start_date).valueOf();
                            const endMs = new Date(su.end_date).valueOf();
                            const xMin = xScale.getPixelForValue(startMs);
                            const xMax = xScale.getPixelForValue(endMs);

                            ctx.fillStyle = '#B3742A';
                            ctx.fillRect(xMin, laneTop, xMax - xMin, 18);

                            ctx.fillStyle = '#fff';
                            ctx.font = '11px Segoe UI';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(sub, xMin + 6, laneTop + 9);

                            chart.$ribbons.push({
                                xMin, xMax,
                                yMin: laneTop,
                                yMax: laneTop + 18,
                                title: sub,
                                duration: `${su.start_date} → ${su.end_date}`,
                                note: su.note || '',
                                type: 'Substance'
                            });
                        });
                });
            }

            ctx.restore();
        }
    };

    // --- WIDGET CONFIGURATION ---
    const widgetConfig = {
        'symptoms': { title: 'Symptom Trajectory', chartId: 'chartSymptoms', createData: () => ({ sets: rawData.symptoms, unified: rawData.symptomsUnified }) },
        'meds': { title: 'Medications', chartId: 'chartMeds', createData: () => ({ sets: rawData.meds, unified: rawData.medsUnified }) },
        'se': { title: 'Side Effects', chartId: 'chartSE', createData: () => ({ sets: rawData.se, unified: rawData.seUnified }) },
        'mse': { title: 'MSE Findings', chartId: 'chartMSE', createData: () => ({ sets: rawData.mse, unified: rawData.mseUnified }) }
    };
    if (rawData.scale && rawData.scale.length > 0) {
        widgetConfig['scale'] = { title: 'Scale Assessments', chartId: 'chartScale', createData: () => ({ sets: rawData.scale, unified: rawData.scaleUnified }) };
    }

    // Initial Layout Order (Scale is NOT added here; use master toggle to show/hide)
    const initialLayout = [
        { key: 'symptoms', width: 'span-full' },
        { key: 'meds', width: 'span-half' },
        { key: 'se', width: 'span-half' },
        { key: 'mse', width: 'span-full' }
    ];

    function toggleMasterScales() {
        const toggle = document.getElementById('masterScaleToggle');
        const sidebarGroup = document.getElementById('sidebar-group-scale');

        if (toggle.checked) {
            if (sidebarGroup) sidebarGroup.style.display = 'block';
            if (rawData.scale && rawData.scale.length > 0) {
                addWidgetToDOM('scale', 'span-full');
            }
        } else {
            if (sidebarGroup) sidebarGroup.style.display = 'none';
            removeWidget('scale');
        }
    }

    let activeWidgets = []; // Tracks currently displayed widgets

    // --- WIDGET LOGIC ---

    function initDashboard() {
        const area = document.getElementById('dashboardArea');
        area.innerHTML = ''; // Clear
        activeWidgets = [];

        initialLayout.forEach(item => {
            addWidgetToDOM(item.key, item.width);
        });

        updateWidgetDropdown();
    }

    function addWidgetToDOM(key, widthClass = 'span-full') {
        if (activeWidgets.includes(key)) return; // Prevent duplicates

        const config = widgetConfig[key];
        const area = document.getElementById('dashboardArea');
        
        // Create HTML Structure
        const div = document.createElement('div');
        div.className = `widget-card ${widthClass}`;
        div.id = `widget-${key}`;
        // Note: We DO NOT set draggable='true' here anymore. It blocks the canvas.

        div.innerHTML = `
            <div class="widget-header">
                <span class="widget-title">${config.title}</span>
                <div class="widget-controls">
                    <button class="widget-icon-btn" onclick="toggleWidgetWidth('${key}')" title="Toggle Width">⇲</button>
                    <button class="widget-icon-btn remove" onclick="removeWidget('${key}')" title="Remove">✕</button>
                </div>
            </div>
            <div class="canvas-container">
                <canvas id="${config.chartId}"></canvas>
            </div>
        `;

        // --- NEW DRAG HANDLE LOGIC ---
        // Only allow the HTML5 drag API to activate when grabbing the header
        const header = div.querySelector('.widget-header');
        header.addEventListener('mousedown', () => div.setAttribute('draggable', 'true'));
        header.addEventListener('mouseup', () => div.setAttribute('draggable', 'false'));
        header.addEventListener('mouseleave', () => div.setAttribute('draggable', 'false'));

        // Add Drag and Drop Event Listeners
        div.addEventListener('dragstart', handleDragStart);
        div.addEventListener('dragenter', handleDragEnter);
        div.addEventListener('dragover', handleDragOver);
        div.addEventListener('dragleave', handleDragLeave);
        div.addEventListener('drop', handleDrop);
        div.addEventListener('dragend', handleDragEnd);

        area.appendChild(div);
        activeWidgets.push(key);

        // Initialize Chart.js instance
        const dataObj = config.createData();
        initChartInstance(key, config.chartId, dataObj.sets, dataObj.unified);
        updateWidgetDropdown();
    }

    // --- DRAG AND DROP LOGIC ---
    let draggedWidget = null;

    function handleDragStart(e) {
        draggedWidget = this;
        e.dataTransfer.effectAllowed = 'move';
        setTimeout(() => this.classList.add('dragging'), 0);
    }

    function handleDragOver(e) {
        e.preventDefault(); // Necessary to allow dropping
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnter(e) {
        e.preventDefault();
        if (this !== draggedWidget) {
            this.classList.add('drag-over');
        }
    }

    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.stopPropagation();
        this.classList.remove('drag-over');
        
        if (draggedWidget !== this && draggedWidget) {
            const grid = document.getElementById('dashboardArea');
            const allWidgets = Array.from(grid.children);
            const draggedIndex = allWidgets.indexOf(draggedWidget);
            const droppedIndex = allWidgets.indexOf(this);

            // Reorder nodes in the DOM
            if (draggedIndex < droppedIndex) {
                this.parentNode.insertBefore(draggedWidget, this.nextSibling);
            } else {
                this.parentNode.insertBefore(draggedWidget, this);
            }
        }
        return false;
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        this.setAttribute('draggable', 'false'); // Reset the state after drop
        document.querySelectorAll('.widget-card').forEach(c => c.classList.remove('drag-over'));
    }

    function removeWidget(key) {
        const el = document.getElementById(`widget-${key}`);
        if(el) {
            // Destroy chart instance to free memory
            if(charts[key]) {
                charts[key].destroy();
                delete charts[key];
            }
            el.remove();
            activeWidgets = activeWidgets.filter(k => k !== key);
            updateWidgetDropdown();
        }
    }

    function addSelectedWidget() {
        const sel = document.getElementById('widgetSelector');
        const key = sel.value;
        if(key) {
            // Default new widgets to full width
            addWidgetToDOM(key, 'span-full');
            sel.value = "";
        }
    }

    function toggleWidgetWidth(key) {
        const el = document.getElementById(`widget-${key}`);
        if (el.classList.contains('span-full')) {
            el.classList.replace('span-full', 'span-half');
        } else {
            el.classList.replace('span-half', 'span-full');
        }
        // Chart needs to know resize happened
        if(charts[key]) charts[key].resize();
    }

    function updateWidgetDropdown() {
        const addSel = document.getElementById('widgetSelector');
        const remSel = document.getElementById('removeWidgetSelector');
        
        addSel.innerHTML = '<option value="" disabled selected>Insert chart...</option>';
        remSel.innerHTML = '<option value="" disabled selected>Remove chart...</option>';
        
        Object.keys(widgetConfig).forEach(key => {
            const title = widgetConfig[key].title;
            if(!activeWidgets.includes(key)) {
                addSel.innerHTML += `<option value="${key}">${title}</option>`;
            } else {
                remSel.innerHTML += `<option value="${key}">${title}</option>`;
            }
        });

        const addBtn = document.querySelector('button[onclick="addSelectedWidget()"]');
        const remBtn = document.querySelector('button[onclick="removeSelectedWidget()"]');
        
        if(addBtn) {
            const noMoreToAdd = (addSel.options.length === 1);
            addBtn.disabled = noMoreToAdd;
            addBtn.style.background = noMoreToAdd ? '#ccc' : '';
            addBtn.style.cursor = noMoreToAdd ? 'not-allowed' : 'pointer';
        }
        
        if(remBtn) {
            const noMoreToRemove = (remSel.options.length === 1);
            remBtn.disabled = noMoreToRemove;
            remBtn.style.background = noMoreToRemove ? '#ccc' : '#f5576c';
            remBtn.style.cursor = noMoreToRemove ? 'not-allowed' : 'pointer';
        }
    }

    function removeSelectedWidget() {
        const sel = document.getElementById('removeWidgetSelector');
        const key = sel.value;
        if(key) {
            removeWidget(key);
            sel.value = "";
        }
    }

    // --- CHART GENERATION LOGIC ---

    function initChartInstance(key, ctxId, datasets, unified) {
        const finalData = [];
        if (unified) {
            if (key === 'meds') { unified.pointRadius = 1; unified.pointHoverRadius = 5; unified.pointHitRadius = 10; }
            finalData.push(unified);
        }
        if (datasets) finalData.push(...datasets);
        
        // Setup Symbols for Events/Stressors
        if (key === 'symptoms') {
            const imgEvent = new Image(); imgEvent.src = "{{ url_for('static', filename='Event.png') }}";
            imgEvent.width = 16; imgEvent.height = 16;
            
            const imgStressor = new Image(); imgStressor.src = "{{ url_for('static', filename='Stressor.png') }}";
            imgStressor.width = 16; imgStressor.height = 16;

            finalData.push({
                label: 'Major Events',
                data: (rawData.events || []).map(e => ({ x: e.date, y: 9.5, detail: e.note || '', title: e.type, duration: e.duration || '' })),
                pointStyle: imgEvent, showLine: false, hidden: false
            });
            finalData.push({
                label: 'Stressors',
                data: (rawData.stressors || []).map(s => ({ x: s.date, y: 9.0, detail: s.note || '', title: s.type, duration: s.duration || '' })),
                pointStyle: imgStressor, showLine: false, hidden: false
            });
        }

        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
        finalData.forEach((ds, i) => {
            if (ds.isUnified) return;
            const c = ds.borderColor || colors[i % colors.length];
            ds.borderColor = c; ds.backgroundColor = c;
            ds.pointRadius = 2; ds.pointHoverRadius = 5; ds.fill = false;
        });

        // 2. Set Min/Max relative to the main 'y' scale
        let maxY = 10;
        finalData.forEach(d => { (d.data || []).forEach(p => { if (p.y != null && p.y > maxY) maxY = p.y; }); });
        maxY = maxY * 1.15;

        if (key === 'meds') maxY = Math.max(maxY, 12);

        let activeSubsCount = 0;
        if (key === 'symptoms' && (rawData.substances || []).length > 0) {
            activeSubsCount = [...new Set((rawData.substances || []).map(s => s.substance))].length;
        }
        
        // Calculate required pixel padding to fit all active strips below the graph
        const freeZoneHeight = (key === 'symptoms') ? (35 + (activeSubsCount * 22)) : 5;

        // Fetch a fresh, isolated copy of the options and safely apply custom limits
        const chartOptions = getCommonOptions();
        chartOptions.scales.y.max = maxY;
        chartOptions.scales.x.ticks = { padding: freeZoneHeight };

        const ctx = document.getElementById(ctxId);
        if (!ctx) return;
        if(Chart.getChart(ctxId)) Chart.getChart(ctxId).destroy();

        // 1. Initialize Chart with our isolated options and overlay plugin
        const newChart = new Chart(ctx, {
            type: 'line',
            data: { datasets: finalData },
            options: chartOptions,
            plugins: [clinicalOverlayPlugin]
        });
        newChart.config._configKey = key;

        // Ribbon hover
        newChart.canvas.addEventListener('mousemove', function(e) {
            if (!newChart.$ribbons) return;

            const rect = newChart.canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const hit = newChart.$ribbons.find(r =>
                mouseX >= r.xMin && mouseX <= r.xMax &&
                mouseY >= r.yMin && mouseY <= r.yMax
            );

            if (hit) {
                newChart.canvas.style.cursor = 'pointer';
                showRibbonTooltip(e.clientX, e.clientY, hit);
            } else {
                newChart.canvas.style.cursor = 'default';
                hideRibbonTooltip();
            }
        });
        newChart.canvas.addEventListener('mouseleave', hideRibbonTooltip);

        // Modal Double Click Handler
        ctx.addEventListener('dblclick', (e) => {
            suppressSingleClickUntil = Date.now() + 400;
            if (newChart.clickTimeout) clearTimeout(newChart.clickTimeout);
            clearStickyTooltips();

            const activeEls = newChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
            let dateStr = null;

            if (activeEls.length) {
                const index = activeEls[0].index;
                const datasetIndex = activeEls[0].datasetIndex;
                const point = newChart.data.datasets[datasetIndex].data[index];
                dateStr = point.x ? point.x.split('T')[0] : null;
            } else {
                const xScale = newChart.scales.x;
                if (xScale) {
                    const nativeEvent = e.native != null ? e.native : e;
                    const canvasPos = Chart.helpers.getRelativePosition(nativeEvent, newChart);
                    const dateValue = xScale.getValueForPixel(canvasPos.x);
                    if (dateValue) dateStr = new Date(dateValue).toISOString().split('T')[0];
                }
            }

            if (dateStr) {
                showModalByDate(dateStr);
            }
        });

        // 3. Hide non-unified datasets initially
        newChart.data.datasets.forEach(ds => { if (!ds.isUnified) ds.hidden = true; });
        newChart.update();

        charts[key] = newChart;
    }

    function handleZoomSelect(val) {
        const customDiv = document.getElementById('customZoomDiv');
        if (customDiv) customDiv.style.display = (val === 'custom') ? 'inline-flex' : 'none';

        if (!val || val === 'custom') return;

        if (val === 'all') {
            Object.values(charts).forEach(chart => {
                if (chart) {
                    chart.resetZoom();
                    delete chart.options.scales.x.min;
                    delete chart.options.scales.x.max;
                    chart.update();
                }
            });
            return;
        }

        let maxTime = 0;
        Object.values(charts).forEach(c => {
            c.data.datasets.forEach(ds => {
                ds.data.forEach(p => {
                    if (p.x) {
                        let t = new Date(p.x).getTime();
                        if (t > maxTime) maxTime = t;
                    }
                });
            });
        });

        let end = maxTime > 0 ? new Date(maxTime) : new Date();
        end.setDate(end.getDate() + 2);

        let start = new Date(end);

        if (val === 'week') {
            start.setDate(end.getDate() - 7);
        } else if (val === 'month') {
            start.setMonth(end.getMonth() - 1);
        } else if (val === 'year') {
            start.setFullYear(end.getFullYear() - 1);
        }

        applyZoomRange(start, end);
    }

    function applyCustomZoom() {
        const s = document.getElementById('zoomStart').value;
        const e = document.getElementById('zoomEnd').value;
        if (s && e) {
            let endDate = new Date(e);
            endDate.setHours(23, 59, 59, 999);
            applyZoomRange(new Date(s), endDate);
        } else {
            alert("Please select both start and end dates.");
        }
    }

    function applyZoomRange(start, end) {
        Object.values(charts).forEach(chart => {
            if (chart) {
                if (typeof chart.resetZoom === 'function') {
                    chart.resetZoom();
                }

                if (chart.options.scales && chart.options.scales.x) {
                    chart.options.scales.x.min = start.valueOf();
                    chart.options.scales.x.max = end.valueOf();
                }

                chart.update();
            }
        });
    }

    // --- SIDEBAR TOGGLES (Updated to check chart existence) ---
    function toggleUnified(type) {
        const chart = charts[type]; if(!chart) return;
        const cb = document.getElementById(`check-unified-${type}`);
        if(chart.data.datasets[0].isUnified) { chart.setDatasetVisibility(0, cb.checked); chart.update(); }
    }
    function toggleDataset(type, label) {
        const chart = charts[type]; if(!chart) return;
        const idx = chart.data.datasets.findIndex(ds => ds.label === label);
        if(idx !== -1) {
            let isChecked = false;
            document.querySelectorAll(`.chk-${type}`).forEach(c => { if(c.value===label) isChecked = c.checked; });
            chart.setDatasetVisibility(idx, isChecked); chart.update();
        }
    }

    // --- SIDEBAR "SELECT ALL" LOGIC ---
    function toggleAll(type, checkbox) {
        const chart = charts[type]; 
        if (!chart) return;

        // 1. Update Chart Datasets (Skip unified)
        chart.data.datasets.forEach((ds, index) => {
            if (!ds.isUnified) {
                 chart.setDatasetVisibility(index, checkbox.checked);
            }
        });
        chart.update();

        // 2. Sync Individual Checkboxes in Sidebar
        document.querySelectorAll(`.chk-${type}`).forEach(cb => {
            cb.checked = checkbox.checked;
        });
    }

    // --- STICKY TOOLTIPS LOGIC (Metadata Based + Scroll Sync + Overlap Prevention) ---

    function showStickyTooltips(dateStr) {
        clearStickyTooltips();
        
        // 1. Collect all Tooltip Candidates (Data & Positions)
        let candidates = [];

        Object.keys(charts).forEach(key => {
            const chart = charts[key];
            if (!chart) return;
            
            const chartArea = chart.chartArea;
            const canvasRect = chart.canvas.getBoundingClientRect();

            chart.data.datasets.forEach((ds, dsIndex) => {
                if (chart.isDatasetVisible(dsIndex)) {
                    // Find matching data point
                    const index = ds.data.findIndex(p => p.x && p.x.toString().startsWith(dateStr));
                    
                    if (index !== -1) {
                        const meta = chart.getDatasetMeta(dsIndex);
                        const element = meta.data[index];

                        if (element && !element.skip) {
                            const x = element.x;
                            const y = element.y;

                            // Bounds Check (Visible area only)
                            if (x >= chartArea.left - 5 && x <= chartArea.right + 5 && 
                                y >= chartArea.top - 5 && y <= chartArea.bottom + 5) {
                                
                                // Calculate Absolute Screen Position
                                const absX = canvasRect.left + x;
                                const absY = canvasRect.top + y;

                                candidates.push({
                                    absX, absY,
                                    dataset: ds,
                                    point: ds.data[index],
                                    chartType: key
                                });
                            }
                        }
                    }
                }
            });
        });

        if (candidates.length === 0) return;

        // 2. Create Elements (Initially hidden to measure size)
        const domElements = candidates.map(c => {
            const el = createTooltipElement(c.absX, c.absY, c.dataset, c.point, c.chartType);
            el.style.opacity = '0'; // Hide during calculation
            return { el, ...c };
        });

        // 3. Collision Resolution (Prevent Overlap)
        // Sort by Y position (top to bottom) so we handle them in order
        domElements.sort((a, b) => a.absY - b.absY);

        for (let i = 0; i < domElements.length; i++) {
            for (let j = i + 1; j < domElements.length; j++) {
                const A = domElements[i];
                const B = domElements[j];

                // Get current positions (getBoundingClientRect is expensive, so we calculate relative)
                const rectA = A.el.getBoundingClientRect();
                const rectB = B.el.getBoundingClientRect();

                // Check Intersection
                const overlapX = (rectA.left < rectB.right && rectA.right > rectB.left);
                const overlapY = (rectA.top < rectB.bottom && rectA.bottom > rectB.top);

                if (overlapX && overlapY) {
                    // Collision Detected! Push B down.
                    const pushDown = (rectA.bottom - rectB.top) + 5;
                    
                    const currentTop = parseFloat(B.el.style.top);
                    B.el.style.top = (currentTop + pushDown) + 'px';
                }
            }
        }

        // 4. Reveal Elements
        domElements.forEach(item => item.el.style.opacity = '1');
    }

    // Helper function to create the DOM element
    function createTooltipElement(x, y, dataset, point, chartType) {
        const div = document.createElement('div');
        div.className = 'sticky-tooltip';

        div.style.left = x + 'px';
        div.style.top = y + 'px';

        if (point.title) {
            const dateStr = point.x ? point.x.split('T')[0] : '';
            div.innerHTML = '<div style="font-weight:bold; margin-bottom:4px; color:' + (dataset.borderColor || '#A5DCFE') + '">' + dataset.label + '</div>';
            div.innerHTML += '<div>Date: ' + dateStr + '</div>';
            div.innerHTML += '<div>Name: <strong>' + point.title + '</strong></div>';
            if (point.detail) div.innerHTML += '<div style="color:#ddd; margin-top:4px; font-style:italic; white-space: normal; max-width: 200px;">Note: ' + point.detail + '</div>';
        } else {
            let valDisplay = point.y;
            if (chartType === 'meds') valDisplay += ' mg';
            div.innerHTML = '<span class="tooltip-color-box" style="background:' + dataset.borderColor + '"></span><span style="font-weight:600;">' + dataset.label + ':</span> ' + valDisplay;
            if (point.detail) div.innerHTML += '<div style="margin-top:2px; font-weight:normal; opacity:0.8;">' + point.detail + '</div>';
        }

        document.body.appendChild(div);
        return div;
    }

    function clearStickyTooltips() {
        document.querySelectorAll('.sticky-tooltip').forEach(el => el.remove());
    }

    function showRibbonTooltip(x, y, ribbon) {
        let tip = document.getElementById('ribbonTooltip');
        if (!tip) {
            tip = document.createElement('div');
            tip.id = 'ribbonTooltip';
            tip.className = 'sticky-tooltip';
            document.body.appendChild(tip);
        }
        tip.innerHTML = `
            <strong>${ribbon.type}</strong><br>
            <strong>${ribbon.title}</strong><br>
            <span>Duration: ${ribbon.duration}</span>
            ${ribbon.note ? `<br><em>${ribbon.note}</em>` : ''}
        `;
        tip.style.left = x + 'px';
        tip.style.top = (y - 12) + 'px';
        tip.style.display = 'block';
    }

    function hideRibbonTooltip() {
        const tip = document.getElementById('ribbonTooltip');
        if (tip) tip.style.display = 'none';
    }

    // --- POPUP LOGIC (Generic) ---
    function showDailySummary(dateStr, x, y) {
        const popup = document.getElementById('dailySummary');
        const content = document.getElementById('dsContent');
        document.getElementById('dsDate').innerText = dateStr;
        content.innerHTML = '';

        let hasData = false;

        Object.keys(charts).forEach(key => {
            const chartObj = charts[key];
            const groupName = widgetConfig[key].title;
            let groupHtml = '';

            chartObj.data.datasets.forEach(ds => {
                if (ds.hidden) return;

                const dayPoints = ds.data.filter(p => p.x && p.x.startsWith(dateStr));

                dayPoints.forEach(point => {
                    let det = point.detail || '';

                    if (ds.label === 'Stressors' || ds.label === 'Major Events') {
                        let title = point.title || '';
                        groupHtml += `<li>
                            <span style="color:#333; font-weight:bold;">● [${dateStr}] ${ds.label}</span>: ${title}
                            ${det ? `<br><small style="color:#666; margin-left:15px;">Note: ${det}</small>` : ''}
                        </li>`;
                    } else {
                        let val = point.y;
                        if (key === 'meds') val = `${val} mg`;
                        groupHtml += `<li>
                            <span style="color:${ds.borderColor || '#333'}; font-weight:bold;">● ${ds.label}</span>: ${val}
                            ${det ? `<br><small style="color:#666; margin-left:15px;">${det}</small>` : ''}
                        </li>`;
                    }
                });
            });

            if (groupHtml) {
                content.innerHTML += `<div class="daily-summary-cat">${groupName}</div><ul>${groupHtml}</ul>`;
                hasData = true;
            }
        });

        if (!hasData) content.innerHTML = '<em>No visible data points.</em>';
        popup.style.left = Math.min(x + 10, window.innerWidth - 300) + 'px';
        popup.style.top = Math.min(y + 10, window.innerHeight - 300) + 'px';
        popup.style.display = 'block';
    }
    function closeDailySummary() { document.getElementById('dailySummary').style.display = 'none'; }
    
    function showModalByDate(date) {
        const modal = document.getElementById('visitModal');
        const body = document.getElementById('modalBody');
        document.getElementById('modalDate').innerText = date;
        body.innerHTML = '';

        // 1. Fetch available data sources for this date
        const visit = Object.values(rawData.details).find(v => v.date === date);
        const plottedStressors = (rawData.stressors || []).filter(s => s.date === date);
        const plottedEvents = (rawData.events || []).filter(e => e.date === date);

        const sections = [];

        // 2. Aggregate Clinical Data
        if (visit) {
            document.getElementById('modalDate').innerText += " (Visit Record)";
            if(visit.symptoms && visit.symptoms.length) sections.push(['Symptoms', visit.symptoms]);
            if(visit.meds && visit.meds.length) sections.push(['Medications', visit.meds]);
            if(visit.se && visit.se.length) sections.push(['Side Effects', visit.se]);
            if(visit.mse && visit.mse.length) sections.push(['MSE Findings', visit.mse]);
            if(visit.scales && visit.scales.length) sections.push(['Scale Assessments', visit.scales]);
        } else {
            document.getElementById('modalDate').innerText += " (Chart Data)";

            // Build dynamically from chart datasets for interpolated dates (Onset/Progression, etc.)
            const dynamicData = { symptoms: [], meds: [], se: [], mse: [], scale: [] };

            const extract = (datasetGroup, targetArray) => {
                if(!datasetGroup) return;
                datasetGroup.forEach(ds => {
                    if(ds.isUnified) return;
                    if(ds.data) {
                        ds.data.forEach(pt => {
                            if(pt.x && pt.x.startsWith(date)) {
                                targetArray.push({ name: ds.label, score: pt.y, detail: pt.detail, phase: pt.phase });
                            }
                        });
                    }
                });
            };

            extract(rawData.symptoms, dynamicData.symptoms);
            extract(rawData.meds, dynamicData.meds);
            extract(rawData.se, dynamicData.se);
            extract(rawData.mse, dynamicData.mse);
            extract(rawData.scale, dynamicData.scale);

            if(dynamicData.symptoms.length) sections.push(['Symptoms', dynamicData.symptoms]);
            if(dynamicData.meds.length) sections.push(['Medications', dynamicData.meds]);
            if(dynamicData.se.length) sections.push(['Side Effects', dynamicData.se]);
            if(dynamicData.mse.length) sections.push(['MSE Findings', dynamicData.mse]);
            if(dynamicData.scale.length) sections.push(['Scale Assessments', dynamicData.scale]);
        }

        // 3. ALWAYS attach Stressors & Events occurring on this date
        if (plottedStressors.length > 0) sections.push(['Stressors', plottedStressors.map(s => ({ type: s.title || s.type, duration: s.duration, note: s.detail || s.note }))]);
        if (plottedEvents.length > 0) sections.push(['Major Events', plottedEvents.map(e => ({ type: e.title || e.type, duration: e.duration, note: e.detail || e.note }))]);

        // 4. Handle Empty State
        if (sections.length === 0) {
            body.innerHTML = '<p>No data points found for this date.</p>';
            modal.style.display='block';
            return;
        }

        // 5. Render Modal Formatting
        sections.forEach(([heading, items]) => {
            if (!items || !items.length) return;
            body.innerHTML += `<h4 style="margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 4px; color: #444;">${heading}</h4>`;
            items.forEach(i => {
                let line;
                if (heading.includes('Scale Assessments')) {
                    line = `<strong>${i.name}</strong> — Score: ${i.score} ${i.label ? '('+i.label+')' : (i.detail ? '('+i.detail+')' : '')}`;
                } else if (heading === 'Medications') {
                    if (i.is_tapering && i.taper_plan) {
                        let plan = [];
                        try { plan = JSON.parse(i.taper_plan); } catch(e) {}
                        line = `<strong>${i.name}</strong> <span style="font-size:0.85em; color:#e65100; border:1px solid #e65100; border-radius:3px; padding:1px 4px; margin-left:4px;">Tapering</span><div style="font-size:0.85em; padding-left:10px; border-left:2px solid #ccc; margin-top:4px;">${(plan.map(s => `&#8212; ${s.dose_mg || '—'} (${s.frequency || ''}) x ${s.duration_text || ''}`).join('<br>'))}</div>`;
                    } else if (i.dose) {
                        line = `<strong>${i.name}</strong> — ${i.dose || ''} (${i.freq})`;
                    } else {
                        line = `<strong>${i.name}</strong> — Equivalent Dose: ${i.score} ${i.detail ? '<span style="color:#666;font-size:0.9em;">('+i.detail+')</span>' : ''}`;
                    }
                } else if (heading.includes('Stressors') || heading.includes('Major Events')) {
                    line = `<strong style="color: #d32f2f;">${i.type}</strong>`;
                    if (i.duration) line += ` <span style="font-size:0.9em; color:#555; background:#f0f0f0; padding:2px 6px; border-radius:4px; margin-left:6px;">Duration: ${i.duration}</span>`;
                    if (i.note) line += `<div style="font-size:0.85em; color:#666; margin-top: 4px; padding-left:10px; border-left: 2px solid #ffcdd2;">Note: ${i.note}</div>`;
                } else {
                    line = `<strong>${i.name}</strong> — Score: ${i.score} ${i.phase && i.phase !== 'Current' ? '<span style="color:#888; font-size: 0.85em; background:#eee; padding:2px 4px; border-radius:3px; margin-left:4px;">' + i.phase + '</span>' : ''}`;
                    if (i.detail && !['Onset','Progression','Current','Symptom Onset','Symptom Progression','Symptom Current'].includes(i.detail.trim()) && !i.detail.includes('MSE (')) {
                        line += `<div style="font-size:0.85em; color:#666; margin-top: 2px; padding-left:10px; border-left: 2px solid #ddd;">Note: ${i.detail}</div>`;
                    }
                }
                body.innerHTML += `<div class="detail-row" style="padding: 6px 0;">${line}</div>`;
            });
        });
        modal.style.display = 'block';
    }
    function closeModal() { document.getElementById('visitModal').style.display = 'none'; }
    window.onclick = function(event) { 
        // Close Modal Logic
        if (event.target == document.getElementById('visitModal')) closeModal();
        
        // Close Sticky Tooltips Logic
        // If we didn't click a canvas and didn't click a tooltip, clear them.
        if (!event.target.closest('canvas') && !event.target.closest('.sticky-tooltip')) {
            clearStickyTooltips();
            activeStickyDate = null; // Reset state
        }
        
        // Close Daily Summary Popup (if still used)
        const summaryPopup = document.getElementById('dailySummary');
        if (summaryPopup && summaryPopup.style.display === 'block' && !event.target.closest('.daily-summary-popup')) {
            closeDailySummary();
        }
    }

    // Form Logic (Unchanged)
    // --- SMART FREQUENCY DROPDOWN LOGIC ---
    function updateFreqOptions(input) {
        const val = input.value.trim().replace(/-/g, ''); // strip dashes for matching
        const list = document.getElementById('freq-options-list');
        
        // Map inputs like "101" to "1-0-1"
        const map = {
            '1': '1-0-0', '10': '1-0-0', '100': '1-0-0',
            '01': '0-1-0', '010': '0-1-0',
            '001': '0-0-1', 
            '101': '1-0-1', 
            '111': '1-1-1',
            'sos': 'SOS'
        };
        
        if (map[val]) {
            // Create a temporary option to show the suggestion
            let opt = document.createElement('option');
            opt.value = map[val];
            opt.label = `${val} -> ${map[val]}`;
            list.appendChild(opt);
        }
    }
    function updateDurationOptions(input) {
        const v = parseFloat(input.value); if(!isNaN(v)) { 
            const l = document.getElementById('duration-options-list'); l.innerHTML=''; 
            ['Days','Weeks','Months'].forEach(u => { let o=document.createElement('option'); o.value=`${v} ${u}`; l.appendChild(o); });
        }
    }
    // --- SMART DOSE (Life Chart) ---
    function updateDoseOptionsLC(input) {
        const val = input.value.trim();
        const match = val.match(/[\d\.]+/);
        if (!match) return;
        const num = match[0];
        const listId = input.getAttribute('list');
        const list = document.getElementById(listId);
        if (!list) return;
        list.innerHTML = '';
        ['mg', 'g', 'mcg', 'ml', 'IU', 'Tablet'].forEach(unit => {
            const opt = document.createElement('option');
            opt.value = num + ' ' + unit;
            list.appendChild(opt);
        });
    }
    function handleFreqInputLC(input) {
        let val = input.value;
        
        // Convert H to ½ and F to ¼
        if (val.toLowerCase() === 'h') {
            input.value = '½';
        } else if (val.toLowerCase() === 'f') {
            input.value = '¼';
        } else if (val.length > 1) {
            // Keep only the last typed character and convert if necessary
            input.value = val.slice(-1);
            if (input.value.toLowerCase() === 'h') input.value = '½';
            if (input.value.toLowerCase() === 'f') input.value = '¼';
        }

        const container = input.closest('.freq-container');
        updateHiddenFreqLC(container);
        
        const boxes = Array.from(container.querySelectorAll('.freq-box'));
        const currentIndex = boxes.indexOf(input);
        
        // Auto-advance to the next box if a value is entered
        if (input.value !== '' && currentIndex < boxes.length - 1) {
            boxes[currentIndex + 1].focus();
        }
        
        // Auto-add a new box if typing in the last box
        if (input === boxes[boxes.length - 1] && input.value !== '') {
            const addBtn = container.parentElement.querySelector('.add-freq-btn');
            if (addBtn) {
                addFreqBoxLC(addBtn);
                setTimeout(() => {
                    const newBoxes = container.querySelectorAll('.freq-box');
                    newBoxes[newBoxes.length - 1].focus();
                }, 10);
            }
        }
    }
    function addFreqBoxLC(btn) {
        const wrapper = btn.closest('.row-flex').querySelector('.freq-container');
        const sep = document.createElement('span');
        sep.innerText = '-';
        sep.style.margin = '0 2px';
        wrapper.appendChild(sep);
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.className = 'freq-box';
        inp.style = 'width:22px; text-align:center; padding:4px 2px;';
        inp.oninput = function() { handleFreqInputLC(this); };
        wrapper.appendChild(inp);
        updateHiddenFreqLC(wrapper);
    }
    function removeFreqBoxLC(btn) {
        const wrapper = btn.closest('.row-flex').querySelector('.freq-container');
        const boxes = wrapper.querySelectorAll('.freq-box');
        const seps = wrapper.querySelectorAll('span');
        if (boxes.length > 1) {
            boxes[boxes.length - 1].remove();
            if (seps.length > 0) seps[seps.length - 1].remove();
            updateHiddenFreqLC(wrapper);
        }
    }
    function updateHiddenFreqLC(container) {
        const boxes = container.querySelectorAll('.freq-box');
        const values = Array.from(boxes).map(b => b.value.trim() || '0');
        const hiddenInput = container.parentElement.querySelector('input[name="frequency[]"]');
        if (hiddenInput) hiddenInput.value = values.join('-');
    }
    function duplicateTaperRowLC(btn) {
        var currentRow = btn.closest('.entry-wrapper');
        var newRow = currentRow.cloneNode(true);
        var uniqueId = Date.now() + Math.random().toString().slice(2, 6);
        var inputs = newRow.querySelectorAll('input, select, textarea');
        inputs.forEach(function(input) {
            var name = input.getAttribute('name');
            if (name === 'drug_name[]' || name === 'drug_type[]' || name === 'med_form[]') {
                if (name === 'drug_name[]') {
                    input.readOnly = true;
                    input.style.backgroundColor = '#f0f8ff';
                    input.style.border = '1px dashed #7ab8e0';
                }
            } else if (name === 'frequency[]') {
                input.value = '1-0-1';
            } else if (name === 'dose_full[]') {
                input.value = '';
                input.setAttribute('list', 'dose-list-lc-' + uniqueId);
            } else {
                if (input.type === 'text' || input.type === 'hidden' || input.tagName === 'TEXTAREA') input.value = '';
            }
        });
        var datalist = newRow.querySelector('datalist[id^="dose-list-lc-"]');
        if (datalist) {
            datalist.id = 'dose-list-lc-' + uniqueId;
            datalist.innerHTML = '';
        }
        var freqContainer = newRow.querySelector('.freq-container');
        if (freqContainer) {
            freqContainer.innerHTML = '<input type="text" class="freq-box" value="1" style="width:25px; text-align:center; padding:5px 2px; border: none; border-bottom: 1px solid #eee; outline: none; background: transparent;" oninput="handleFreqInputLC(this)"><span style="margin:0 2px; color: #888;">-</span><input type="text" class="freq-box" value="0" style="width:25px; text-align:center; padding:5px 2px; border: none; border-bottom: 1px solid #eee; outline: none; background: transparent;" oninput="handleFreqInputLC(this)"><span style="margin:0 2px; color: #888;">-</span><input type="text" class="freq-box" value="1" style="width:25px; text-align:center; padding:5px 2px; border: none; border-bottom: 1px solid #eee; outline: none; background: transparent;" oninput="handleFreqInputLC(this)">';
        }
        currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
    }

    function addMedication() {
        const uid = Date.now() + Math.random();
        const h = `<div class="entry-wrapper">
            <div class="row-flex" style="align-items: center; gap: 8px; flex-wrap: wrap;">
                <select name="drug_type[]" style="width: 80px; flex: none; font-size: 13px; padding: 8px 4px;"><option value="Generic" selected>Gen</option><option value="Brand">Brand</option></select>
                <select name="med_form[]" style="width: 90px; flex: none; font-size: 13px; padding: 8px 4px;"><option value="Tablet">Tablet</option><option value="Capsule">Capsule</option><option value="Injection">Injection</option></select>
                <input type="text" name="drug_name[]" placeholder="Drug Name" style="flex: 2; min-width: 120px; padding: 8px;">
                <div style="flex: 1; min-width: 80px;">
                    <input type="text" name="dose_full[]" list="dose-list-lc-${uid}" placeholder="Dose" style="width: 100%; padding: 8px;" oninput="updateDoseOptionsLC(this)">
                    <datalist id="dose-list-lc-${uid}"></datalist>
                </div>
                <div style="display: flex; align-items: center; border: 1px solid #ddd; border-radius: 4px; padding: 2px 6px; background: #fff; flex: none;">
                    <input type="hidden" name="frequency[]" value="1-0-1">
                    <div class="freq-container" style="display:flex; align-items:center;">
                        <input type="text" class="freq-box" value="1" style="width:25px; text-align:center; padding:5px 2px; border: none; border-bottom: 1px solid #eee; outline: none; background: transparent;" oninput="handleFreqInputLC(this)"><span style="margin:0 2px; color: #888;">-</span><input type="text" class="freq-box" value="0" style="width:25px; text-align:center; padding:5px 2px; border: none; border-bottom: 1px solid #eee; outline: none; background: transparent;" oninput="handleFreqInputLC(this)"><span style="margin:0 2px; color: #888;">-</span><input type="text" class="freq-box" value="1" style="width:25px; text-align:center; padding:5px 2px; border: none; border-bottom: 1px solid #eee; outline: none; background: transparent;" oninput="handleFreqInputLC(this)">
                    </div>
                    <div style="display:flex; flex-direction:column; margin-left:4px;">
                        <button type="button" class="add-freq-btn" onclick="addFreqBoxLC(this)" style="font-size:10px; line-height:10px; padding:0 2px; cursor:pointer; margin-bottom:1px; background: none; border: 1px solid #ddd; border-radius: 2px;">+</button>
                        <button type="button" onclick="removeFreqBoxLC(this)" style="font-size:10px; line-height:10px; padding:0 2px; cursor:pointer; background: none; border: 1px solid #ddd; border-radius: 2px;">-</button>
                    </div>
                </div>
                <input type="text" list="duration-options-list" name="med_duration[]" placeholder="Dur" style="width: 80px; flex: none; padding: 8px;" oninput="updateDurationOptions(this)">
                <div style="display:flex; gap:5px; flex:none; align-items: center;">
                    <button type="button" class="btn btn-sm" onclick="duplicateTaperRowLC(this)" style="padding:6px 10px; font-size:11px; border-radius:4px; border:1px dashed #7ab8e0; background:#f0f8ff; color:#555; margin: 0; line-height: 1;">+ Taper</button>
                    <button type="button" class="remove-btn" onclick="this.closest('.entry-wrapper').remove()" style="margin: 0; font-size: 16px;">✕</button>
                </div>
            </div>
        </div>`;
        document.getElementById('meds-container').insertAdjacentHTML('beforeend', h);
    }

    window.onload = function() {
        initDashboard(); // LOAD DASHBOARD WIDGETS
        
        // DATE LOGIC: Check if the element exists first (it won't in view_only mode)
        const nextVisitInput = document.getElementById('nextVisitDate');
        if (nextVisitInput && !nextVisitInput.value) {
            const d = new Date(); d.setDate(d.getDate() + 30);
            nextVisitInput.value = d.toISOString().split('T')[0];
        }

        // MEDICATION LOGIC: Check if the container exists first
        const medContainer = document.getElementById('meds-container');
        if (medContainer && medContainer.children.length === 0) {
            addMedication();
        }

        // --- SYNC TOOLTIPS ON VERTICAL SCROLL ---
        const mainContent = document.querySelector('.main-content');
        if (mainContent) {
            mainContent.addEventListener('scroll', () => {
                if (activeStickyDate) {
                    showStickyTooltips(activeStickyDate);
                }
            }, { passive: true }); // passive improves scroll performance
        }

        bindAdherenceCheckboxes();
        renderClinicalStates();
    };

    // --- EXPORT FUNCTIONS ---
    function openDownloadModal() {
        // 1. Calculate Earliest and Latest Dates from JS Chart Data
        let minDate = null;
        let maxDate = null;

        // Loop through all datasets to find absolute min/max
        if (typeof rawData !== 'undefined') {
            // Check all dataset types
            const allDatasets = [
                ...rawData.symptoms,
                ...rawData.meds,
                ...rawData.se,
                ...rawData.mse,
                ...(rawData.scale || []),
                rawData.symptomsUnified,
                rawData.medsUnified,
                rawData.seUnified,
                rawData.mseUnified,
                rawData.scaleUnified
            ].filter(ds => ds && ds.data);

            allDatasets.forEach(ds => {
                if (ds.data) {
                    ds.data.forEach(pt => {
                        if (pt && pt.x) {
                            const d = new Date(pt.x);
                            if (!isNaN(d.getTime())) {
                                if (!minDate || d < minDate) minDate = d;
                                if (!maxDate || d > maxDate) maxDate = d;
                            }
                        }
                    });
                }
            });
        }

        // 2. Set inputs (Format YYYY-MM-DD)
        if (minDate) document.getElementById('exportStartDate').value = minDate.toISOString().split('T')[0];
        if (maxDate) document.getElementById('exportEndDate').value = maxDate.toISOString().split('T')[0];

        // 3. Show Modal
        document.getElementById('downloadModal').style.display = 'block';
    }

    function submitExport() {
        const start = document.getElementById('exportStartDate').value;
        const end = document.getElementById('exportEndDate').value;
        
        // 4. Get Currently Visible Lines (By LABEL Name)
        const checkboxes = document.querySelectorAll('.chk-symptoms, .chk-mse, .chk-se, .chk-meds, .chk-scale');
        const visibleLabels = [];
        checkboxes.forEach(cb => {
            if (cb.checked) {
                // The checkbox value is already the label
                visibleLabels.push(cb.value);
            }
        });

        if (!start || !end) {
            alert("Please select both start and end dates.");
            return;
        }

        // 5. Open Preview (Sending 'visible' as names now)
        // EncodeURIComponent ensures special characters in drug names don't break the URL
        const namesParam = visibleLabels.map(s => encodeURIComponent(s)).join(',');
        
        {% if guest %}
            const url = `{{ url_for('guest_preview_lifechart') }}?token={{ guest_token }}&start=${start}&end=${end}&visible=${namesParam}`;
            window.open(url, '_blank');
        {% else %}
            const url = `{{ url_for('preview_lifechart', patient_id=patient.id) }}?start=${start}&end=${end}&visible=${namesParam}`;
            window.open(url, '_blank');
        {% endif %}
        
        document.getElementById('downloadModal').style.display = 'none';
    }
</script>

<div id="downloadModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000;">
    <div style="background:white; margin:10% auto; padding:20px; width:350px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.2);">
        <h3 style="margin-top:0;">Export Life Chart</h3>
        <label style="display:block; margin:10px 0 5px; font-weight:600;">Start Date</label>
        <input type="date" id="exportStartDate" style="width:100%; padding:8px;">
        
        <label style="display:block; margin:10px 0 5px; font-weight:600;">End Date</label>
        <input type="date" id="exportEndDate" style="width:100%; padding:8px;">
        
        <div style="margin-top:20px; text-align:right;">
			<button onclick="submitExport()" class="btn">Preview PDF/Image</button>
			<button onclick="document.getElementById('downloadModal').style.display='none'" class="btn" style="background:#ccc; color:#333;margin-top:20px;">Cancel</button>
        </div>
    </div>
</div>

<div id="modalEqDose" class="modal" onclick="if(event.target == this) this.style.display='none'">
    <div class="modal-content" style="width: 450px;">
        <span class="close-btn" onclick="document.getElementById('modalEqDose').style.display='none'" style="float: right; font-size: 24px; cursor: pointer; color: #aaa;">&times;</span>
        <h3 style="margin-top: 0; margin-bottom: 15px; border-bottom: 2px solid #f4f8fb; padding-bottom: 10px;">Calculate Equivalent Dose</h3>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; color: #555;">Past Drug</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="eq_past_drug" list="eq_drug_list" placeholder="Select or type drug..." style="flex: 2; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;">
                
                <input type="text" id="eq_past_dose" list="eq_dose_list" placeholder="Dose (e.g. 10 mg)" oninput="updateEqDoseOptionsLC(this)" style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;">
                <datalist id="eq_dose_list"></datalist>
            </div>
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; color: #555;">Current / Target Drug</label>
            <input type="text" id="eq_target_drug" list="eq_drug_list" placeholder="Select or type target drug..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;">
        </div>
        
        <datalist id="eq_drug_list"></datalist>

        <button type="button" class="btn" onclick="calculateEqDose()" style="background-color: #a5dcfe; color: #333; padding: 8px 15px; font-size: 13px; width: 100%; margin-bottom: 15px;">🧮 Calculate Dose</button>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; color: #555;">Equivalent Dose</label>
            <input type="text" id="eq_result_dose" readonly style="background: #f0f8ff; border: 1px dashed #7ab8e0; font-weight: bold; width: 100%; padding: 10px; border-radius: 6px; box-sizing: border-box;">
        </div>

        <div style="display: flex; gap: 10px;">
            <button type="button" class="btn" style="flex: 2; background-color: #7BC4F0; color: #000; margin-top: 0;" onclick="applyEqDoseLC()">✅ Apply to Medications</button>
            <button type="button" class="btn" style="flex: 1; background-color: #eee; color: #333; margin-top: 0;" onclick="document.getElementById('modalEqDose').style.display='none'">Close</button>
        </div>
    </div>
</div>

<script>
    const eqDrugDb = {
        "Risperidone": { min: 2, max: 16 }, "Olanzapine": { min: 5, max: 20 },
        "Haloperidol": { min: 2, max: 20 }, "Aripiprazole": { min: 10, max: 30 },
        "Amisulpride": { min: 300, max: 1200 }, "Clozapine": { min: 6.25, max: 900 },
        "Chlorpromazine": { min: 200, max: 1000 }, "Cariprazine": { min: 1.5, max: 6 },
        "Quetiapine": { min: 150, max: 800 }, "Quetiapine (Sedative)": { min: 25, max: 150 },
        "Aripiprazole (Adjuvant)": { min: 2.5, max: 10 }, "Lithium Carbonate": { min: 150, max: 1800 },
        "Sodium Valproate": { min: 200, max: 3000 }, "Carbamazepine": { min: 100, max: 1600 },
        "Escitalopram": { min: 10, max: 30 }, "Fluoxetine": { min: 20, max: 80 },
        "Fluvoxamine": { min: 50, max: 300 }, "Sertraline": { min: 50, max: 200 },
        "Paroxetine": { min: 20, max: 62.5 }, "Bupropion": { min: 150, max: 450 },
        "Duloxetine": { min: 60, max: 120 }, "Venlafaxine": { min: 75, max: 375 },
        "Vortioxetine": { min: 10, max: 20 }
    };
    const eqBenzoDb = {
        "Diazepam": 10, "Chlordiazepoxide": 25, "Lorazepam": 2,
        "Alprazolam": 0.5, "Clonazepam": 0.5
    };

    window.addEventListener('DOMContentLoaded', () => {
        const drugList = document.getElementById('eq_drug_list');
        if (drugList) {
            let optionsHtml = '';
            for (let d in eqDrugDb) { optionsHtml += `<option value="${d}">`; }
            for (let b in eqBenzoDb) { optionsHtml += `<option value="${b}">`; }
            drugList.innerHTML = optionsHtml;
        }
    });

    function updateEqDoseOptionsLC(input) {
        const val = input.value.trim();
        const match = val.match(/[\d\.]+/);
        if (!match) return;
        const num = match[0];
        const list = document.getElementById('eq_dose_list');
        list.innerHTML = '';
        ['g', 'mg', 'μg'].forEach(unit => {
            const opt = document.createElement('option');
            opt.value = `${num} ${unit}`;
            list.appendChild(opt);
        });
    }

    function calculateEqDose() {
        const pastDrug = document.getElementById('eq_past_drug').value.trim();
        const targetDrug = document.getElementById('eq_target_drug').value.trim();
        const doseInput = document.getElementById('eq_past_dose').value.trim().toLowerCase();
        const match = doseInput.match(/([\d\.]+)\s*(g|mg|μg|mcg)?/);

        if (!pastDrug || !targetDrug || !match) { alert("Please select both drugs and enter a valid dose."); return; }

        const rawVal = parseFloat(match[1]);
        let inputUnit = match[2] || 'mg';
        if (inputUnit === 'mcg') inputUnit = 'μg';

        let pastDoseMg = rawVal;
        if (inputUnit === 'g') pastDoseMg = rawVal * 1000;
        else if (inputUnit === 'μg') pastDoseMg = rawVal / 1000;

        let calcDoseMg = 0;

        if (eqDrugDb[pastDrug] && eqDrugDb[targetDrug]) {
            const rtp = (pastDoseMg - eqDrugDb[pastDrug].min) / (eqDrugDb[pastDrug].max - eqDrugDb[pastDrug].min);
            calcDoseMg = (rtp * (eqDrugDb[targetDrug].max - eqDrugDb[targetDrug].min)) + eqDrugDb[targetDrug].min;
        } else if (eqBenzoDb[pastDrug] && eqBenzoDb[targetDrug]) {
            calcDoseMg = pastDoseMg * (eqBenzoDb[targetDrug] / eqBenzoDb[pastDrug]);
        } else {
            alert("Cannot calculate direct equivalence across different drug categories."); return;
        }

        calcDoseMg = Math.max(0, calcDoseMg);
        let finalVal = 0; let finalUnit = inputUnit;

        if (inputUnit === 'g') {
            let valInG = calcDoseMg / 1000;
            if (valInG >= 1) { finalVal = valInG; } 
            else if (calcDoseMg >= 1) { finalVal = calcDoseMg; finalUnit = 'mg'; } 
            else { finalVal = calcDoseMg * 1000; finalUnit = 'μg'; }
        } else if (inputUnit === 'mg') {
            if (calcDoseMg >= 1 || calcDoseMg === 0) { finalVal = calcDoseMg; } 
            else { finalVal = calcDoseMg * 1000; finalUnit = 'μg'; }
        } else if (inputUnit === 'μg') { finalVal = calcDoseMg * 1000; }

        document.getElementById('eq_result_dose').value = finalVal.toFixed(2).replace(/\.00$/, '') + ' ' + finalUnit;
    }

    function applyEqDoseLC() {
        const targetDrug = document.getElementById('eq_target_drug').value;
        const calcDose = document.getElementById('eq_result_dose').value;

        if (!targetDrug || !calcDose) { alert("Please calculate the dose first."); return; }

        addMedication();

        const medNames = document.getElementsByName('drug_name[]');
        const medDoses = document.getElementsByName('dose_full[]');

        if (medNames.length > 0) {
            medNames[medNames.length - 1].value = targetDrug;
            medDoses[medDoses.length - 1].value = calcDose;
        }

        document.getElementById('modalEqDose').style.display = 'none';
        document.getElementById('eq_past_drug').value = '';
        document.getElementById('eq_target_drug').value = '';
        document.getElementById('eq_past_dose').value = '';
        document.getElementById('eq_result_dose').value = '';
    }

    // --- STRESSOR / EVENTS BUTTON TOGGLE ---
    function toggleEventDataset(type, label, btn) {
        const chart = charts[type]; if(!chart) return;
        const idx = chart.data.datasets.findIndex(ds => ds.label === label);
        if(idx !== -1) {
            const currentlyVisible = chart.isDatasetVisible(idx);
            chart.setDatasetVisibility(idx, !currentlyVisible);
            chart.update();
            btn.style.opacity = currentlyVisible ? '0.5' : '1';
        }
    }

    // --- MODALS JS FOR CLINICAL STATES AND ADHERENCE ---
    function bindAdherenceCheckboxes() {
        const cbs = document.querySelectorAll('.adherence-checkbox');
        if (!cbs.length) return;
        cbs.forEach(cb => {
            cb.addEventListener('change', function() {
                const container = document.getElementById('adherence-ranges-container');
                if (!container) return;
                const id = 'adherence-range-' + this.value.replace(/\s+/g, '_');
                if (this.checked) {
                    let html = '<div class="range-group" id="' + id + '" data-status="' + this.value + '"><div class="range-row"><label>Start: <input type="date" class="range-start"></label> <label>End: <input type="date" class="range-end"></label></div><button type="button" class="btn" style="margin-top:6px; padding:4px 10px; font-size:11px; background:#7ab8e0; color:#fff;" onclick="addExtraRange(this)">+ Add another range</button></div>';
                    container.insertAdjacentHTML('beforeend', html);
                } else {
                    const g = document.getElementById(id);
                    if (g) g.remove();
                }
            });
        });
    }
    function addExtraRange(btn) {
        const group = btn.closest('.range-group');
        if (!group) return;
        const row = document.createElement('div');
        row.className = 'range-row';
        row.innerHTML = '<label>Start: <input type="date" class="range-start"></label> <label>End: <input type="date" class="range-end"></label>';
        group.insertBefore(row, btn);
    }
    function closeAdherenceRangesModal() {
        const data = [];
        const container = document.getElementById('adherence-ranges-container');
        if (container) {
            container.querySelectorAll('.range-group').forEach(group => {
                const status = group.getAttribute('data-status');
                group.querySelectorAll('.range-row').forEach(row => {
                    const start = row.querySelector('.range-start');
                    const end = row.querySelector('.range-end');
                    if (start && end) data.push({ status: status, start: start.value || null, end: end.value || null });
                });
            });
        }
        const hid = document.getElementById('adherence_data');
        if (hid) hid.value = JSON.stringify(data);
        const modal = document.getElementById('adherenceRangesModal');
        if (modal) modal.style.display = 'none';
    }
    function openAdherenceRangesModal() { const m = document.getElementById('adherenceRangesModal'); if (m) m.style.display = 'block'; }

    function closeClinicalStateRangesModal() {
        const data = [];
        document.querySelectorAll('#clinical-state-ranges-container > div[id^="csr-input-"]').forEach(div => {
            const strong = div.querySelector('strong');
            const s = div.querySelector('.range-start');
            const e = div.querySelector('.range-end');
            if (strong && s && e) data.push({ state: strong.innerText, start: s.value || null, end: e.value || null });
        });
        const hid = document.getElementById('clinical_state_data');
        if (hid) hid.value = JSON.stringify(data);
        const modal = document.getElementById('clinicalStateRangesModal');
        if (modal) modal.style.display = 'none';
    }
    function openClinicalStateRangesModal() { const m = document.getElementById('clinicalStateRangesModal'); if (m) { m.style.display = 'block'; renderClinicalStates(); } }

    const stateDBLC = {
        "Bipolar Disorder": ["Recovery", "Remission", "Partial Remission", "Depressive Episode", "Manic Episode", "Hypomanic Episode", "Mixed Episode", "Relapse", "Loss of Follow-up"],
        "Major Depressive Disorder": ["Recovery", "Remission", "Partial Remission", "Mild Depressive Episode", "Moderate Depressive Episode", "Severe Depressive Episode", "Relapse", "Loss of Follow-up"],
        "Schizophrenia Spectrum": ["Recovery", "Remission", "Partial Remission", "Stable Phase", "Acute Psychotic Episode", "Residual Phase", "Relapse", "Loss of Follow-up"],
        "Obsessive Compulsive Disorder": ["Recovery", "Remission", "Partial Remission", "Active OCD", "Severe OCD", "Treatment Resistant Phase", "Relapse", "Loss of Follow-up"],
        "Anxiety Disorders": ["Recovery", "Remission", "Partial Remission", "Active Anxiety", "Acute Panic Phase", "Relapse", "Loss of Follow-up"]
    };
    let customStatesLC = [];
    function renderClinicalStates() {
        const container = document.getElementById('dynamic-states-container');
        if (!container) return;
        const selectedDiags = Array.from(document.querySelectorAll('#diagnosis-checkboxes input:checked')).map(cb => cb.value);
        let statesToShow = new Set();
        if (selectedDiags.length === 0) {
            ["Recovery", "Remission", "Partial Remission", "Relapse", "Loss of Follow-up"].forEach(s => statesToShow.add(s));
        } else {
            selectedDiags.forEach(d => { if (stateDBLC[d]) stateDBLC[d].forEach(s => statesToShow.add(s)); });
        }
        customStatesLC.forEach(s => statesToShow.add(s));
        container.innerHTML = '';
        Array.from(statesToShow).sort().forEach(state => {
            let isCustom = customStatesLC.includes(state);
            let remBtn = isCustom ? '<button type="button" onclick="removeCustomStateLC(\'' + state.replace(/'/g, "\\'") + '\')" style="background:none; border:none; color:red; cursor:pointer; font-weight:bold; margin-left:auto;">[-]</button>' : '';
            let html = '<label style="display:flex; width:100%;"><input type="checkbox" class="clinical-state-checkbox" value="' + state.replace(/"/g, '&quot;') + '" onchange="handleStateCheckboxChangeLC(this)"> <span style="flex:1;">' + state.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span> ' + remBtn + '</label>';
            container.insertAdjacentHTML('beforeend', html);
        });
        const rangesContainer = document.getElementById('clinical-state-ranges-container');
        let activeStates = [];
        if (rangesContainer) activeStates = Array.from(rangesContainer.querySelectorAll('div[id^="csr-input-"]')).map(div => { const s = div.querySelector('strong'); return s ? s.innerText : ''; }).filter(Boolean);
        document.querySelectorAll('.clinical-state-checkbox').forEach(cb => { if (activeStates.includes(cb.value)) cb.checked = true; });
    }
    function addCustomState() {
        const inp = document.getElementById('customStateInput');
        if (!inp) return;
        let val = inp.value.trim();
        if (val && !customStatesLC.includes(val)) { customStatesLC.push(val); inp.value = ''; renderClinicalStates(); }
    }
    function removeCustomStateLC(val) { customStatesLC = customStatesLC.filter(s => s !== val); renderClinicalStates(); }
    function handleStateCheckboxChangeLC(cb) {
        var container = document.getElementById('clinical-state-ranges-container');
        if (!container) return;
        var safeId = 'csr-input-' + cb.value.replace(/[^a-zA-Z0-9]/g, '');
        if (cb.checked) {
            var html = '<div id="' + safeId + '" style="background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;"><strong style="font-size: 13px; color: #333;">' + cb.value.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</strong><div style="display: flex; gap: 10px; margin-top: 5px; align-items:center;"><label>Start: <input type="date" class="range-start"></label><label>End: <input type="date" class="range-end"></label></div></div>';
            container.insertAdjacentHTML('beforeend', html);
        } else { var el = document.getElementById(safeId); if (el) el.remove(); }
    }
</script>
<div id="adherenceRangesModal" class="modal" onclick="if(event.target === this) closeAdherenceRangesModal()">
    <div class="modal-content" style="width: 480px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; margin-top: 5vh;">
        <h4 style="margin-top: 0;">Adherence Ranges (with dates)</h4>
        <div style="overflow-y: auto; flex-grow: 1; padding-right: 10px;">
            <div class="checklist-group">
                <label><input type="checkbox" class="adherence-checkbox" value="Complete"> Complete</label>
                <label><input type="checkbox" class="adherence-checkbox" value="Partial"> Partial</label>
                <label><input type="checkbox" class="adherence-checkbox" value="No Adherence"> No Adherence</label>
            </div>
            <div id="adherence-ranges-container" style="margin-top:12px;"></div>
        </div>
        <div style="margin-top:15px; padding-top:15px; border-top: 1px solid #eee;">
            <button type="button" class="btn" style="margin-top:0; background:#888; color:#fff;" onclick="closeAdherenceRangesModal()">Done</button>
        </div>
    </div>
</div>

<div id="clinicalStateRangesModal" class="modal" onclick="if(event.target === this) closeClinicalStateRangesModal()">
    <div class="modal-content" style="width: 520px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; margin-top: 5vh;">
        <h4 style="margin-top: 0; color: #333;">Clinical State Ranges</h4>
        <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
            <strong style="font-size: 13px; color: #555; display:block; margin-bottom: 5px;">Select Diagnoses:</strong>
            <div class="checklist-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; font-size:12px;" id="diagnosis-checkboxes">
                <label><input type="checkbox" value="Bipolar Disorder" onchange="renderClinicalStates()"> Bipolar Disorder (I & II)</label>
                <label><input type="checkbox" value="Major Depressive Disorder" onchange="renderClinicalStates()"> Major Depressive Disorder</label>
                <label><input type="checkbox" value="Schizophrenia Spectrum" onchange="renderClinicalStates()"> Schizophrenia Spectrum</label>
                <label><input type="checkbox" value="Obsessive Compulsive Disorder" onchange="renderClinicalStates()"> Obsessive Compulsive Disorder</label>
                <label><input type="checkbox" value="Anxiety Disorders" onchange="renderClinicalStates()"> Anxiety Disorders</label>
            </div>
        </div>
        <div style="overflow-y: auto; flex-grow: 1; padding-right: 10px;">
            <strong style="font-size: 13px; color: #555; display:block; margin-bottom: 5px;">States:</strong>
            <div class="checklist-group" id="dynamic-states-container"></div>
            <div style="margin-top: 10px; display:flex; gap:5px;">
                <input type="text" id="customStateInput" placeholder="Custom state..." style="flex:1; padding: 6px; font-size: 12px; border: 1px solid #ccc; border-radius:4px;">
                <button type="button" class="btn" style="padding:6px 15px; font-size:12px; margin:0;" onclick="addCustomState()">[+] Add State</button>
            </div>
            <div id="clinical-state-ranges-container" style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;"></div>
        </div>
        <div style="margin-top:15px; padding-top:15px; border-top: 1px solid #eee;">
            <button type="button" class="btn" style="margin-top:0; background:#888; color:#fff;" onclick="closeClinicalStateRangesModal()">Done</button>
        </div>
    </div>
</div>
</body>
</html>