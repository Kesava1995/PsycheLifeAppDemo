<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

  <style>
    html, body {
	  margin: 0;
	  padding: 0;
	  width: 100%;
	  height: 100%;
	}
	#chart-container {
	  width: 100%;
	  height: 100%;
	}
	canvas {
	  background: transparent;
	}
  </style>
</head>

<body>
<div id="chart-container">
  <canvas id="lifeChart"></canvas>
</div>

<script>
const symptomDatasets = {{ symptom_datasets | tojson }};
const unified = {{ symptom_unified | tojson }};

let datasets = [];

// Prefer unified if available
// Always include unified if available
if (unified) {
  unified.isUnified = true;
  datasets.push(unified);
}

// Also include up to 3 individual symptom lines
symptomDatasets.slice(0, 3).forEach(ds => {
  ds.hidden = false;
  datasets.push(ds);
});

// Styling
datasets.forEach((ds, index) => {
  if (ds.isUnified) {
    ds.borderColor = '#000';
    ds.borderWidth = 4;
    ds.pointRadius = 0;
    ds.tension = 0.4;
  } else {
    const colors = ['#5A67D8', '#38B2AC', '#ED8936', '#E53E3E'];
    ds.borderColor = colors[index % colors.length];
    ds.borderWidth = 2;
    ds.pointRadius = 3;
    ds.tension = 0.3;
    ds.fill = false;
  }
});


if (!datasets.length) {
  console.warn("No symptom data available for preview");

  // Fallback demo line (prevents blank chart)
  datasets.push({
    label: "No symptom data",
    data: [
      { x: new Date(Date.now() - 86400000 * 3), y: 3 },
      { x: new Date(Date.now() - 86400000 * 2), y: 4 },
      { x: new Date(Date.now() - 86400000), y: 2 }
    ],
    borderColor: "#ccc",
    borderWidth: 2,
    pointRadius: 3,
    tension: 0.3
  });
}

let chart = null;

function renderChart() {
  const ctx = document.getElementById('lifeChart');

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'line',
    data: { datasets },
	options: {
	  responsive: true,
	  maintainAspectRatio: false,

	  layout: {
		padding: 8   // ðŸ”‘ THIS IS CRITICAL
	  },

	  interaction: {
		mode: 'nearest',
		intersect: false
	  },

	  scales: {
		x: {
		  type: 'time',
		  time: {
			unit: 'day',
			tooltipFormat: 'dd MMM yyyy'
		  },
		  ticks: {
			autoSkip: true,
			maxTicksLimit: 6,
			color: '#6B7280'
		  },
		  grid: {
			color: '#E5E7EB'
		  }
		},
		y: {
		  min: 0,
		  max: 10,
		  ticks: {
			stepSize: 2,
			color: '#6B7280'
		  },
		  grid: {
			color: '#E5E7EB'
		  }
		}
	  },

	  plugins: {
		legend: { display: false },
		tooltip: { enabled: true },
		zoom: {
		  pan: { enabled: true, mode: 'x' },
		  zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
		}
	  }
	}
  });

  // ðŸ”‘ ABSOLUTE KEY
  chart.resetZoom();
}


window.addEventListener('load', () => {
  setTimeout(renderChart, 80);
});
</script>
</body>
</html>