<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Add Follow-up - {{ patient.name }}</title>
    <style>
        :root { --primary-blue: #A5DCFE; --primary-dark: #7ab8e0; --bg-color: #f4f8fb; --sidebar-width: 280px; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-color); height: 100vh; overflow: hidden; display: flex; }
        .app-container { display: flex; width: 100%; height: 100%; } 
        .sidebar { width: var(--sidebar-width); background: #fff; border-right: 1px solid #eaecf0; padding: 32px 24px; display: flex; flex-direction: column; flex-shrink: 0; }
        .main-content { flex: 1; overflow-y: auto; padding: 30px; background: var(--primary-blue); }
        .visit-card { background: white; border-radius: 12px; padding: 25px; width: 95%; max-width: 1400px; margin: 0 auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .section-header { display: flex; align-items: center; gap: 15px; margin-top: 25px; margin-bottom: 15px; border-bottom: 2px solid var(--bg-color); padding-bottom: 8px; }
        .section-title { font-size: 1.1rem; font-weight: 600; color: #555; }
        .add-btn { background: var(--primary-dark); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .subsection-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; margin-top: 15px; }
        .subsection-title { font-size: 0.9rem; font-weight: 700; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        .entry-wrapper { border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 8px; background: #fafafa; position: relative; }
        .row-flex { display: flex; gap: 15px; align-items: flex-start; }
        .sliders-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; flex: 2.5; }
        .slider-group { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .slider-group label { font-size: 10px; color: #666; margin-bottom: 4px; text-transform: uppercase; white-space: nowrap; }
        .slider-wrapper { display: flex; align-items: center; gap: 8px; width: 100%; padding: 0 5px; }
        input[type=range] { -webkit-appearance: none; width: 100%; height: 5px; cursor: pointer; margin: 0; padding: 0; background: #ddd; border-radius: 3px; flex: 1; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--primary-dark); cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .slider-val { font-size: 11px; font-weight: bold; color: #555; width: 20px; text-align: right; }
        .duration-group { display: flex; gap: 0; min-width: 130px; }
        .duration-group input { width: 50px; border-radius: 4px 0 0 4px; border-right: none; padding: 5px; text-align: center; }
        .duration-group select { width: 80px; border-radius: 0 4px 4px 0; background-color: #f8f9fa; padding: 5px; font-size: 12px; }
        .note-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #999; }
        .note-input { display: none; width: 100%; margin-top: 8px; padding: 8px; border: 1px dashed #ccc; background-color: #fffdf0; }
        .remove-btn { color: #ff6b6b; background: none; border: none; font-weight: bold; cursor: pointer; font-size: 14px; margin-left: 5px; }
        .btn { padding: 15px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; font-size: 16px; margin-top: 10px; }
        .patient-grid { display: grid; gap: 15px; background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px solid #eee; }
        .row-3-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; }

        /* PHASE 2 STYLES */
        .click-trigger-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .click-trigger { flex: 1; padding: 12px; border: 1px dashed #7ab8e0; border-radius: 6px; color: #555; cursor: pointer; background: #fdfdfd; display: flex; justify-content: space-between; align-items: center; }
        .click-trigger:hover { background: #f0f8ff; border-color: #4facfe; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 10% auto; padding: 20px; width: 400px; border-radius: 8px; }
        .checklist-group label { display: block; margin-bottom: 8px; cursor: pointer; }
    </style>
</head>
<body>
    
    {% macro row_template_med(entry) %}
    {% set dose_str = entry.dose_mg|string if entry.dose_mg else '' %}
    {% set d_val = dose_str.split(' ')[0] if ' ' in dose_str else dose_str %}
    {% set d_unit = dose_str.split(' ')[1] if ' ' in dose_str else 'mg' %}
    <div class="entry-wrapper">
        <div class="row-flex" style="align-items:center;">
            <select name="drug_type[]" style="width:60px; flex:none;"><option {% if entry.drug_type=='Gen'%}selected{%endif%}>Gen</option><option {% if entry.drug_type=='Brand'%}selected{%endif%}>Brand</option></select>
            <input type="text" name="drug_name[]" value="{{ entry.drug_name }}" style="width:25%; flex:0 0 25%;">
            <div style="display:flex; gap:0; flex:1; min-width:120px;">
                <input type="text" name="dose_val[]" value="{{ d_val }}" style="flex:1;">
                <select name="dose_unit[]" style="width:55px;"><option {% if d_unit=='mg'%}selected{%endif%}>mg</option><option {% if d_unit=='mcg'%}selected{%endif%}>mcg</option></select>
            </div>
            <input type="text" list="freq-options-list" name="frequency[]" value="{{ entry.frequency }}" style="flex:1; min-width:80px;" oninput="updateFreqOptions(this)">
            <input type="text" list="duration-options-list" name="med_duration[]" value="{{ entry.duration_text or '' }}" style="flex:1; min-width:80px;" oninput="updateDurationOptions(this)">
            <button type="button" class="note-btn" onclick="toggleNote(this)">üìù</button>
            <button type="button" class="remove-btn" onclick="this.closest('.entry-wrapper').remove()">‚úï</button>
        </div>
        <input type="text" class="note-input" name="med_note[]" value="{{ entry.note or '' }}">
    </div>
    {% endmacro %}

    <div class="app-container">
        <aside class="sidebar">
            <div style="font-weight:bold; margin-bottom:20px;">Dr. {{ doctor.full_name if doctor and doctor.full_name else 'Doctor' }}</div>
            <a href="{{ url_for('dashboard') }}" style="text-decoration:none; color:#333;">üè† Dashboard</a>
            <a href="{{ url_for('patient_detail', patient_id=patient.id) }}" style="display:block; margin-top:10px; text-decoration:none; color:#333;">‚¨ÖÔ∏è Back</a>
        </aside>

        <main class="main-content">
            <div class="visit-card">
                <form method="POST">
                    <h3>Follow-up Visit - {{ patient.name }}</h3>
                    <div style="margin-bottom:20px;">
                        <label>Visit Date</label>
                        <input type="date" name="date" required value="{{ today.strftime('%Y-%m-%d') }}">
                    </div>

                    <div class="patient-grid" style="margin-bottom:20px;">
                        <h4 style="margin-top:0; color:#555;">Update Patient Particulars</h4>
                        <div class="row-3-col">
                            <div><label>Attender Name</label><input type="text" name="attender_name" value="{{ patient.attender_name or '' }}"></div>
                            <div><label>Relation</label><input type="text" name="attender_relation" value="{{ patient.attender_relation or '' }}"></div>
                            <div><label>Reliability</label><select name="attender_reliability"><option value="Yes" {% if patient.attender_reliability=='Yes' %}selected{%endif%}>Yes</option><option value="No" {% if patient.attender_reliability=='No' %}selected{%endif%}>No</option></select></div>
                        </div>
                    </div>

                    {% set last_stressors = [] %}
                    {% set last_stressor_note = '' %}
                    {% if last_visit and last_visit.stressor_entries %}
                        {% set last_stressor_note = last_visit.stressor_entries[0].note %}
                        {% for s in last_visit.stressor_entries %}
                            {% set _ = last_stressors.append(s.stressor_type) %}
                        {% endfor %}
                    {% endif %}

                    {% set last_traits = [] %}
                    {% set last_pers_note = '' %}
                    {% if last_visit and last_visit.personality_entries %}
                        {% set last_pers_note = last_visit.personality_entries[0].note %}
                        {% for p in last_visit.personality_entries %}
                            {% set _ = last_traits.append(p.trait) %}
                        {% endfor %}
                    {% endif %}

                    <div class="section-header"><span class="section-title">Background Factors</span></div>
                    <div class="click-trigger-row">
                        <div class="click-trigger" onclick="document.getElementById('modalStress').style.display='block'">
                            <span>‚ö†Ô∏è Stressors ({{ last_stressors|length }})</span><span>‚ñº</span>
                        </div>
                        <div class="click-trigger" onclick="document.getElementById('modalPers').style.display='block'">
                            <span>üß† Personality ({{ last_traits|length }})</span><span>‚ñº</span>
                        </div>
                    </div>

                    <div class="section-header"><span class="section-title">Chief Complaints</span><button type="button" class="add-btn" onclick="addSymptom()">+</button></div>
                    <div id="symptoms-container">
                        {% if last_visit %}
                            {% for entry in last_visit.symptom_entries %}
                            <div class="entry-wrapper">
                                <div class="row-flex" style="align-items:center;">
                                    <input type="text" name="symptom_name[]" value="{{ entry.symptom_name }}" style="flex:1.5;">
                                    <input type="hidden" name="symptom_onset[]" value="{{ entry.score_onset }}"><input type="hidden" name="symptom_progression[]" value="{{ entry.score_progression }}">
                                    <div class="sliders-container">
                                        <div class="slider-group" style="grid-column: span 3;"><label>Current Severity</label><div class="slider-wrapper"><input type="range" name="symptom_current[]" min="0" max="10" value="{{ entry.score_current|int }}" oninput="updVal(this)"><span class="slider-val">{{ entry.score_current|int }}</span></div></div>
                                    </div>
                                    <input type="text" list="duration-options-list" name="symptom_duration[]" placeholder="Duration" style="flex:0.5; min-width:100px;" oninput="updateDurationOptions(this)">
                                    <button type="button" class="note-btn" onclick="toggleNote(this)">üìù</button>
                                    <button type="button" class="remove-btn" onclick="this.closest('.entry-wrapper').remove()">‚úï</button>
                                </div>
                                <input type="text" class="note-input" name="symptom_note[]" value="{{ entry.note or '' }}" placeholder="Notes...">
                            </div>
                            {% endfor %}
                        {% else %}
                            <script>window.addEventListener('load', () => addSymptom());</script>
                        {% endif %}
                    </div>

                    <div class="section-header"><span class="section-title">MSE Findings</span></div>
                    
                    {% for cat in ['Thought', 'Perception', 'Affect'] %}
                        <div class="subsection-header">
                            <span class="subsection-title">{{ cat }}</span>
                            <button type="button" class="add-btn" onclick="addMSE('{{ cat }}')">+</button>
                        </div>
                        <div id="mse-{{ cat|lower }}-container">
                            {% if last_visit %}
                                {% for entry in last_visit.mse_entries if entry.category == cat %}
                                    <div class="entry-wrapper">
                                        <div class="row-flex" style="align-items:center;">
                                            <input type="hidden" name="mse_category[]" value="{{ cat }}">
                                            <input type="text" name="mse_finding_name[]" value="{{ entry.finding_name }}" style="flex:1.5;">
                                            
                                            <input type="hidden" name="mse_onset[]" value="{{ entry.score_onset }}">
                                            <input type="hidden" name="mse_progression[]" value="{{ entry.score_progression }}">
                                            
                                            <div class="sliders-container">
                                                <div class="slider-group" style="grid-column: span 3;">
                                                    <label>Current Severity</label>
                                                    <div class="slider-wrapper">
                                                        <input type="range" name="mse_current[]" min="0" max="10" value="{{ entry.score_current|int }}" oninput="updVal(this)">
                                                        <span class="slider-val">{{ entry.score_current|int }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <input type="text" list="duration-options-list" name="mse_duration[]" placeholder="Duration" style="flex:0.5; min-width:100px;" oninput="updateDurationOptions(this)">
                                            <button type="button" class="note-btn" onclick="toggleNote(this)">üìù</button>
                                            <button type="button" class="remove-btn" onclick="this.closest('.entry-wrapper').remove()">‚úï</button>
                                        </div>
                                        <input type="text" class="note-input" name="mse_note[]" value="{{ entry.note or '' }}">
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    {% endfor %}

                    <div class="section-header"><span class="section-title">Side Effects</span><button type="button" class="add-btn" onclick="addSideEffect()">+</button></div>
                    <div id="side-effects-container">
                        {% if last_visit %}
                            {% for entry in last_visit.side_effect_entries %}
                            <div class="entry-wrapper">
                                <div class="row-flex" style="align-items:center;">
                                    <input type="text" name="side_effect_name[]" value="{{ entry.side_effect_name }}" style="flex:1.5;">
                                    <input type="hidden" name="side_effect_onset[]" value="{{ entry.score_onset }}"><input type="hidden" name="side_effect_progression[]" value="{{ entry.score_progression }}">
                                    <div class="sliders-container"><div class="slider-group" style="grid-column: span 3;"><label>Current Severity</label><div class="slider-wrapper"><input type="range" name="side_effect_current[]" min="0" max="10" value="{{ entry.score_current|int }}" oninput="updVal(this)"><span class="slider-val">{{ entry.score_current|int }}</span></div></div></div>
                                    <input type="text" list="duration-options-list" name="side_effect_duration[]" placeholder="Duration" style="flex:0.5; min-width:100px;" oninput="updateDurationOptions(this)">
                                    <button type="button" class="note-btn" onclick="toggleNote(this)">üìù</button>
                                    <button type="button" class="remove-btn" onclick="this.closest('.entry-wrapper').remove()">‚úï</button>
                                </div>
                                <input type="text" class="note-input" name="side_effect_note[]" value="{{ entry.note or '' }}">
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div style="text-align:center; margin: 30px 0;">
                        <button type="submit" name="submit_action" value="lifechart" class="btn" style="background:var(--primary-dark); width:auto; padding:10px 40px;">üîÑ Update Life Chart</button>
                    </div>

                    <div class="section-header">
                        <span class="section-title">Diagnosis</span>
                        <button type="button" class="btn" onclick="document.getElementById('diagnosis-section').style.display='grid'; this.style.display='none';" style="width:auto; padding:5px 15px; font-size:12px; margin-left:15px; background:#666;">Revise Diagnosis</button>
                    </div>
                    
                    <div id="diagnosis-section" class="patient-grid" style="display:none; margin-bottom:20px; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <label>Provisional Diagnosis</label>
                            <textarea name="provisional_diagnosis" rows="3">{{ last_visit.provisional_diagnosis if last_visit else '' }}</textarea>
                            <div style="margin-top: 5px; display: flex; gap: 10px;">
                                <button type="button" class="btn" onclick="showCriteria('ICD')" style="background: #e0e0e0; color: #333; font-size: 11px; padding: 4px 10px; width: auto; border: 1px solid #ccc;">
                                    Show ICD-10
                                </button>
                                <button type="button" class="btn" onclick="showCriteria('DSM')" style="background: #e0e0e0; color: #333; font-size: 11px; padding: 4px 10px; width: auto; border: 1px solid #ccc;">
                                    Show DSM-5
                                </button>
                            </div>
                        </div>
                        <div>
                            <label>Differential Diagnosis</label>
                            <textarea name="differential_diagnosis" rows="3">{{ last_visit.differential_diagnosis if last_visit else '' }}</textarea>
                        </div>
                    </div>
					
					<div class="section-header"><span class="section-title">Medications</span><button type="button" class="add-btn" onclick="addMedication()">+</button></div>
                    <div id="meds-container">
                        {% if last_visit %}
                            {% for entry in last_visit.medication_entries %}
                            {{ row_template_med(entry) }}
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div style="margin-top: 20px; background:#f9fafb; padding:15px; border-radius:8px;">
                        <label>Next Follow-up Date</label>
                        <input type="date" name="next_visit_date" id="nextVisitDate">
                        <label style="margin-top:15px;">Visit Note</label>
                        <textarea name="visit_note" rows="2"></textarea>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="submit" name="submit_action" value="prescription" class="btn" style="flex:1; background:#7BC4F0;">üíä Prescription</button>
                        <!--<button type="submit" name="submit_action" value="lifechart" class="btn" style="flex:1; background:#f5576c;">üìà LifeChart</button>-->
                        <button type="submit" name="submit_action" value="both" class="btn" style="flex:1; background:#4facfe;">Generate Both</button>
                    </div>

                    <div id="modalStress" class="modal">
                        <div class="modal-content">
                            <h3>Select Stressors</h3>
                            <div class="checklist-group">
                                <label><input type="checkbox" name="stressors[]" value="Inter-personal/Familial" {% if 'Inter-personal/Familial' in last_stressors %}checked{% endif %}> Inter-personal / Familial</label>
                                <label><input type="checkbox" name="stressors[]" value="Loss/Bereavement" {% if 'Loss/Bereavement' in last_stressors %}checked{% endif %}> Loss / Bereavement</label>
                                <label><input type="checkbox" name="stressors[]" value="Financial/Occupational" {% if 'Financial/Occupational' in last_stressors %}checked{% endif %}> Financial / Occupational</label>
                                <label><input type="checkbox" name="stressors[]" value="Health/Medical" {% if 'Health/Medical' in last_stressors %}checked{% endif %}> Health / Medical</label>
                                <label><input type="checkbox" name="stressors[]" value="Violence" {% if 'Violence' in last_stressors %}checked{% endif %}> Physical / Sexual Violence</label>
                                <label><input type="checkbox" name="stressors[]" value="Other" {% if 'Other' in last_stressors %}checked{% endif %}> Other</label>
                            </div>
                            <textarea name="stressor_note" placeholder="Notes on stressors..." rows="2" style="margin-top:10px;">{{ last_stressor_note }}</textarea>
                            <button type="button" class="btn" style="margin-top:15px;" onclick="document.getElementById('modalStress').style.display='none'">Done</button>
                        </div>
                    </div>

                    <div id="modalPers" class="modal">
                        <div class="modal-content">
                            <h3>Premorbid Personality</h3>
                            <div class="checklist-group" style="height:200px; overflow-y:auto;">
                                <label><input type="checkbox" name="personality[]" value="Paranoid" {% if 'Paranoid' in last_traits %}checked{% endif %}> Paranoid</label>
                                <label><input type="checkbox" name="personality[]" value="Schizoid" {% if 'Schizoid' in last_traits %}checked{% endif %}> Schizoid</label>
                                <label><input type="checkbox" name="personality[]" value="Schizotypal" {% if 'Schizotypal' in last_traits %}checked{% endif %}> Schizotypal</label>
                                <label><input type="checkbox" name="personality[]" value="Antisocial" {% if 'Antisocial' in last_traits %}checked{% endif %}> Antisocial</label>
                                <label><input type="checkbox" name="personality[]" value="Borderline" {% if 'Borderline' in last_traits %}checked{% endif %}> Borderline</label>
                                <label><input type="checkbox" name="personality[]" value="Histrionic" {% if 'Histrionic' in last_traits %}checked{% endif %}> Histrionic</label>
                                <label><input type="checkbox" name="personality[]" value="Narcissistic" {% if 'Narcissistic' in last_traits %}checked{% endif %}> Narcissistic</label>
                                <label><input type="checkbox" name="personality[]" value="Avoidant" {% if 'Avoidant' in last_traits %}checked{% endif %}> Avoidant</label>
                                <label><input type="checkbox" name="personality[]" value="Dependent" {% if 'Dependent' in last_traits %}checked{% endif %}> Dependent</label>
                                <label><input type="checkbox" name="personality[]" value="Anankastic" {% if 'Anankastic' in last_traits %}checked{% endif %}> Anankastic</label>
								<label><input type="checkbox" name="personality[]" value="Neuroticism" {% if 'Neuroticism' in last_traits %}checked{% endif %}> Neuroticism</label>
								<label><input type="checkbox" name="personality[]" value="Low Conscientiousness" {% if 'Low Conscientiousness' in last_traits %}checked{% endif %}> Low Conscientiousness</label>
								<label><input type="checkbox" name="personality[]" value="Low Agreeableness" {% if 'Low Agreeableness' in last_traits %}checked{% endif %}> Low Agreeableness</label>
								<label><input type="checkbox" name="personality[]" value="High Extraversion" {% if 'High Extraversion' in last_traits %}checked{% endif %}> High Extraversion</label>
								<label><input type="checkbox" name="personality[]" value="Low Openness" {% if 'Low Openness' in last_traits %}checked{% endif %}> Low Openness</label>
								<label><input type="checkbox" name="personality[]" value="High Introversion" {% if 'High Introversion' in last_traits %}checked{% endif %}> High Introversion</label>
								<label><input type="checkbox" name="personality[]" value="Others" {% if 'Others' in last_traits %}checked{% endif %}> Others</label>
                            </div>
                            <textarea name="personality_note" placeholder="Notes on personality..." rows="2" style="margin-top:10px;">{{ last_pers_note }}</textarea>
                            <button type="button" class="btn" style="margin-top:15px;" onclick="document.getElementById('modalPers').style.display='none'">Done</button>
                        </div>
                    </div>

                </form>
            </div>
        </main>
    </div>

    <datalist id="duration-options-list"></datalist>
    <datalist id="freq-options-list">
        <option value="1-0-0">Morning</option>
        <option value="1-0-1">Morning & Night</option>
        <option value="0-0-1">Night</option>
        <option value="1-1-1">Morning, Afternoon & Night</option>
        <option value="SOS">As Needed</option>
    </datalist>

    <script>
        function toggleNote(btn) { btn.closest('.entry-wrapper').querySelector('.note-input').style.display='block'; }
        function updVal(slider) { slider.nextElementSibling.innerText = slider.value; }
        
        window.addEventListener('load', () => {
            const d = new Date(); d.setDate(d.getDate() + 30);
            document.getElementById('nextVisitDate').value = d.toISOString().split('T')[0];
        });

        // Smart Dropdown Logic
        function updateDurationOptions(input) {
            const val = input.value.trim();
            const list = document.getElementById('duration-options-list');
            const num = parseFloat(val);
            if (!isNaN(num) && num > 0) {
                list.innerHTML = ''; 
                ['Days', 'Weeks', 'Months', 'Years'].forEach(unit => {
                    const opt = document.createElement('option');
                    opt.value = `${num} ${unit}`;
                    list.appendChild(opt);
                });
            }
        }

        function updateFreqOptions(input) {
            const val = input.value.trim().replace(/-/g, '');
            const list = document.getElementById('freq-options-list');
            const map = { '1':'1-0-0', '10':'1-0-0', '100':'1-0-0', '01':'0-1-0', '010':'0-1-0', '001':'0-0-1', '101':'1-0-1', '111':'1-1-1', 'sos':'SOS' };
            if (map[val]) {
                let opt = document.createElement('option');
                opt.value = map[val];
                opt.label = `${val} -> ${map[val]}`;
                list.appendChild(opt);
            }
        }

        function createRowHTML(type, cat='') {
            const isMSE = type === 'mse';
            const prefix = isMSE ? 'mse' : type; 
            let contentHTML = '';
            
            // Meds Row (Optimized Layout)
            if (type === 'med') {
                contentHTML = `
                <div class="row-flex" style="align-items:center;">
                    <select name="drug_type[]" style="width:60px; flex:none;"><option>Gen</option><option>Brand</option></select>
                    <input type="text" name="drug_name[]" placeholder="Drug Name" style="width:25%; flex:0 0 25%;">
                    <div style="display:flex; gap:0; flex:1; min-width:120px;">
                        <input type="text" name="dose_val[]" placeholder="Dose" style="flex:1; border-radius:4px 0 0 4px; border-right:none;">
                        <select name="dose_unit[]" style="width:55px; border-radius:0 4px 4px 0; background:#f0f0f0;"><option>mg</option><option>mcg</option></select>
                    </div>
                    <input type="text" list="freq-options-list" name="frequency[]" placeholder="Freq" style="flex:1; min-width:80px;" oninput="updateFreqOptions(this)">
                    <input type="text" list="duration-options-list" name="${prefix}_duration[]" placeholder="Duration" style="flex:1; min-width:80px;" oninput="updateDurationOptions(this)">
                    <button type="button" class="note-btn" onclick="toggleNote(this)">üìù</button>
                    <button type="button" class="remove-btn" onclick="this.closest('.entry-wrapper').remove()">‚úï</button>
                </div>`;
            } else {
                let slidersHTML = `
                <div class="sliders-container">
                    <div class="slider-group"><label>Severity at Onset</label><div class="slider-wrapper"><input type="range" name="${prefix}_onset[]" min="0" max="10" value="5" oninput="updVal(this)"><span class="slider-val">5</span></div></div>
                    <div class="slider-group"><label>Severity during Course</label><div class="slider-wrapper"><input type="range" name="${prefix}_progression[]" min="0" max="10" value="5" oninput="updVal(this)"><span class="slider-val">5</span></div></div>
                    <div class="slider-group"><label>Current Severity</label><div class="slider-wrapper"><input type="range" name="${prefix}_current[]" min="0" max="10" value="5" oninput="updVal(this)"><span class="slider-val">5</span></div></div>
                </div>`;
                let inputName = isMSE ? `<input type="hidden" name="mse_category[]" value="${cat}"><input type="text" name="mse_finding_name[]" placeholder="Finding..." style="flex:1.5;">` : `<input type="text" name="${prefix}_name[]" placeholder="Name" style="flex:1.5;">`;
                let durationHTML = `<input type="text" list="duration-options-list" name="${prefix}_duration[]" placeholder="Duration" style="flex:0.5; min-width:100px;" oninput="updateDurationOptions(this)">`;
                contentHTML = `<div class="row-flex" style="align-items:center;">${inputName}${slidersHTML}${durationHTML}<button type="button" class="note-btn" onclick="toggleNote(this)">üìù</button><button type="button" class="remove-btn" onclick="this.closest('.entry-wrapper').remove()">‚úï</button></div>`;
            }
            return `<div class="entry-wrapper">${contentHTML}<input type="text" class="note-input" name="${prefix}_note[]" placeholder="Notes..."></div>`;
        }

        function addSymptom() { document.getElementById('symptoms-container').insertAdjacentHTML('beforeend', createRowHTML('symptom')); }
        function addMedication() { document.getElementById('meds-container').insertAdjacentHTML('beforeend', createRowHTML('med')); }
        function addSideEffect() { document.getElementById('side-effects-container').insertAdjacentHTML('beforeend', createRowHTML('side_effect')); }
        function addMSE(cat) { document.getElementById('mse-' + cat.toLowerCase() + '-container').insertAdjacentHTML('beforeend', createRowHTML('mse', cat)); }
    </script>

<div id="criteriaModal" class="modal" style="z-index: 9999;">
    <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
        <span class="close-btn" onclick="document.getElementById('criteriaModal').style.display='none'">&times;</span>
        <h3 id="criteriaTitle" style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">Diagnostic Criteria</h3>
        <div id="criteriaBody" style="font-family: 'Segoe UI', sans-serif; font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap;"></div>
    </div>
</div>

<script>
    // --- TEXTBOOK DATA DICTIONARY ---
    // Sources: Kaplan & Sadock (DSM-5), Neeraj Ahuja (ICD-10)
    const diagnosisDB = {
        "depression": {
            "DSM": "DSM-5 Criteria for Major Depressive Disorder:\n\nA. Five (or more) of the following during the same 2-week period; at least one is (1) depressed mood or (2) loss of interest/pleasure:\n1. Depressed mood most of the day, nearly every day.\n2. Markedly diminished interest or pleasure in all, or almost all, activities.\n3. Significant weight loss/gain or decrease/increase in appetite.\n4. Insomnia or hypersomnia nearly every day.\n5. Psychomotor agitation or retardation.\n6. Fatigue or loss of energy.\n7. Feelings of worthlessness or excessive/inappropriate guilt.\n8. Diminished ability to think/concentrate, or indecisiveness.\n9. Recurrent thoughts of death, suicidal ideation.\n\nB. Symptoms cause clinically significant distress or impairment.",
            "ICD": "ICD-10 Criteria for Depressive Episode (F32):\n\nKey Symptoms (At least 2 required):\n1. Depressed mood.\n2. Loss of interest and enjoyment.\n3. Reduced energy leading to increased fatiguability and diminished activity.\n\nAssociated Symptoms (At least 2 others):\n- Reduced concentration and attention\n- Reduced self-esteem and self-confidence\n- Ideas of guilt and unworthiness\n- Bleak and pessimistic views of the future\n- Ideas or acts of self-harm or suicide\n- Disturbed sleep\n- Diminished appetite"
        },
        "schizophrenia": {
            "DSM": "DSM-5 Criteria for Schizophrenia:\n\nA. Two (or more) of the following for 1 month (at least one must be 1, 2, or 3):\n1. Delusions\n2. Hallucinations\n3. Disorganized speech (e.g., frequent derailment or incoherence)\n4. Grossly disorganized or catatonic behavior\n5. Negative symptoms (i.e., diminished emotional expression or avolition)\n\nB. Level of functioning is markedly below the level achieved prior to onset.\nC. Continuous signs of disturbance persist for at least 6 months.",
            "ICD": "ICD-10 Criteria for Schizophrenia (F20):\n\nAt least one very clear symptom from group (a) to (d), OR two from group (e) to (h):\n\n(a) Thought echo, thought insertion or withdrawal, thought broadcasting.\n(b) Delusions of control, influence, or passivity; delusional perception.\n(c) Hallucinatory voices giving a running commentary or discussing the patient.\n(d) Persistent delusions of other kinds that are culturally inappropriate.\n(e) Persistent hallucinations in any modality + fleeting delusions/overvalued ideas.\n(f) Breaks in the train of thought (incoherence/neologisms).\n(g) Catatonic behaviour.\n(h) 'Negative' symptoms (apathy, paucity of speech, blunting of affect)."
        },
        "bipolar": {
            "DSM": "DSM-5 Criteria for Manic Episode (Bipolar I):\n\nA. A distinct period of abnormally and persistently elevated, expansive, or irritable mood and increased activity/energy (lasting at least 1 week).\n\nB. Three (or more) of the following (4 if mood is only irritable):\n1. Inflated self-esteem or grandiosity.\n2. Decreased need for sleep (e.g., feels rested after 3 hours).\n3. More talkative than usual or pressure to keep talking.\n4. Flight of ideas or subjective experience that thoughts are racing.\n5. Distractibility.\n6. Increase in goal-directed activity or psychomotor agitation.\n7. Excessive involvement in activities with painful consequences (e.g., buying sprees).",
            "ICD": "ICD-10 Criteria for Manic Episode (F30):\n\n1. Mood must be predominantly elevated, expansive, or irritable.\n2. At least three symptoms must be present (four if mood is irritable):\n- Increased activity or physical restlessness\n- Increased talkativeness ('pressure of speech')\n- Flight of ideas or subjective experience that thoughts are racing\n- Loss of normal social inhibitions\n- Decreased need for sleep\n- Inflated self-esteem or grandiosity\n- Distractibility or constant changes in activity\n- Foolish or reckless behaviour"
        },
        "anxiety": {
            "DSM": "DSM-5 Criteria for Generalized Anxiety Disorder (GAD):\n\nA. Excessive anxiety and worry occurring more days than not for at least 6 months.\nB. The individual finds it difficult to control the worry.\nC. Associated with three (or more) of the following:\n1. Restlessness or feeling keyed up or on edge.\n2. Being easily fatigued.\n3. Difficulty concentrating or mind going blank.\n4. Irritability.\n5. Muscle tension.\n6. Sleep disturbance.",
            "ICD": "ICD-10 Criteria for Generalized Anxiety Disorder (F41.1):\n\nPrimary symptoms of anxiety most days for at least several weeks/months:\n1. Apprehension (worries about future misfortune, feeling 'on edge', difficulty concentrating).\n2. Motor tension (restless fidgeting, tension headaches, trembling, inability to relax).\n3. Autonomic overactivity (lightheadedness, sweating, tachycardia, tachypnea, epigastric discomfort)."
        }
    };

    function showCriteria(type) {
        // 1. Get the Diagnosis Text
        const textInputs = document.getElementsByName('provisional_diagnosis');
        if (!textInputs.length) return;
        
        // Use the first found input's value
        const rawText = textInputs[0].value.toLowerCase();
        
        if (!rawText.trim()) {
            alert("Please type a diagnosis first (e.g., 'Schizophrenia', 'Depression').");
            return;
        }

        // 2. Simple Keyword Matching
        let matchKey = null;
        if (rawText.includes("depress") || rawText.includes("mdd")) matchKey = "depression";
        else if (rawText.includes("schizo") || rawText.includes("f20")) matchKey = "schizophrenia";
        else if (rawText.includes("bipolar") || rawText.includes("mania") || rawText.includes("manic")) matchKey = "bipolar";
        else if (rawText.includes("anxiet") || rawText.includes("gad") || rawText.includes("panic")) matchKey = "anxiety";
        
        // 3. Populate Modal
        const modal = document.getElementById('criteriaModal');
        const title = document.getElementById('criteriaTitle');
        const body = document.getElementById('criteriaBody');
        
        if (matchKey && diagnosisDB[matchKey]) {
            title.innerText = `${type} Verification: ${matchKey.charAt(0).toUpperCase() + matchKey.slice(1)}`;
            body.innerText = diagnosisDB[matchKey][type];
        } else {
            title.innerText = `${type} Criteria Not Found`;
            body.innerText = "Automatic criteria lookup failed for: '" + rawText + "'.\n\n(This demo supports: Depression, Schizophrenia, Bipolar, Anxiety)";
        }
        
        modal.style.display = 'block';
    }
</script>
</body>
</html>
