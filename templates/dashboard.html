<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ElevenEleven Health</title>
    <style>
        :root { --primary-blue: #A5DCFE; --primary-dark: #7ab8e0; --bg-color: #f4f8fb; --sidebar-width: 280px; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg-color); height: 100vh; overflow: hidden; display: flex; }
        
        .sidebar { width: var(--sidebar-width); background: #fff; border-right: 1px solid #eaecf0; padding: 32px 24px; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { display: flex; align-items: center; gap: 12px; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid #f2f4f7; }
        .user-avatar { width: 48px; height: 48px; border-radius: 50%; background-color: #f2f4f7; background-image: url('https://ui-avatars.com/api/?name={{ session.get("username", "Dr") }}&background=random&color=fff'); background-size: cover; }
        .user-info { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; font-size: 16px; color: #101828; line-height: 24px; }
        .user-role { font-size: 14px; color: #667085; line-height: 20px; }
        .nav-links { display: flex; flex-direction: column; gap: 4px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 6px; text-decoration: none; color: #344054; font-weight: 500; font-size: 15px; transition: all 0.2s; }
        .nav-item:hover { background-color: #f9fafb; color: #101828; }
        .section-label { font-size: 12px; font-weight: 600; color: #98a2b3; margin-top: 32px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
        .patient-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 2px; }
        .patient-item { padding: 8px 12px; border-radius: 6px; font-size: 14px; color: #667085; cursor: pointer; text-decoration: none; display: block; }
        .patient-item:hover { background-color: #f2f4f7; color: #101828; }
        .nav-item.logout { margin-top: auto; color: #b42318; }
        .nav-item.logout:hover { background-color: #fef3f2; }

        .app-container { display: flex; width: 100%; height: 100%; }
        .main-content { flex: 1; overflow-y: auto; padding: 30px; background: var(--primary-blue); }
        .visit-card { background: white; border-radius: 12px; padding: 25px; width: 95%; max-width: 1400px; margin: 0 auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .section-header { display: flex; align-items: center; gap: 15px; margin-top: 25px; margin-bottom: 15px; border-bottom: 2px solid var(--bg-color); padding-bottom: 8px; }
        .section-title { font-size: 1.1rem; font-weight: 600; color: #555; }
        input[type="text"], input[type="number"], input[type="date"], textarea, select { width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; }
        .add-btn { background: var(--primary-dark); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; }
        .patient-grid { display: grid; gap: 15px; }
        .row-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .note-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; margin-left: 5px; color: #888; padding: 0; vertical-align: middle; }
        .note-btn:hover { color: var(--primary-dark); }
        .note-input { display: none; width: 100%; margin-top: 8px; padding: 8px; border: 1px dashed #ccc; border-radius: 4px; background-color: #fffdf0; font-size: 0.9rem; }
        .entry-wrapper { margin-bottom: 15px; }
        .symptom-entry { background: #fafafa; padding: 15px; border-radius: 8px; }
        .symptom-top-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; }
        .symptom-slider-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .med-row { display: grid; grid-template-columns: 100px 2fr 1fr 1fr auto auto; gap: 15px; align-items: center; }
        .side-effect-row { display: flex; gap: 15px; align-items: center; }
        .mse-row { display: flex; align-items: center; gap: 15px; padding: 10px; background: #fff; }
        .mse-wrapper { border-bottom: 1px solid #f0f0f0; margin-bottom: 5px; }
        .mse-label { width: 100px; font-weight: 600; }
        .btn { padding: 15px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; font-size: 16px; }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="user-avatar"></div>
                <div class="user-info">
                    <span class="user-name">Dr. {{ session.get('username', 'User')|title }}</span>
                    <span class="user-role">ElevenEleven Health</span>
                </div>
            </div>
            <div class="nav-links">
                <a href="{{ url_for('profile') }}" class="nav-item"><span class="nav-icon">üë§</span> Profile</a>
            </div>
            <div class="section-label">My Patients</div>
            <div class="patient-list">
                {% for patient in patients %}
                <a href="{{ url_for('patient_detail', patient_id=patient.id) }}" class="patient-item">{{ patient.name }}</a>
                {% endfor %}
            </div>
            <a href="{{ url_for('logout') }}" class="nav-item logout"><span class="nav-icon">üö™</span> Log Out</a>
        </aside>
        <main class="main-content">
            <div class="visit-card">
                <form method="POST" action="{{ url_for('dashboard') }}" enctype="multipart/form-data">
                    <h2 style="margin-bottom: 20px;">New Patient & First Visit</h2>
                    <div class="patient-grid">
                        <div class="row-2-col">
                            <input type="text" name="patient_name" placeholder="Patient Name" required>
                            <input type="number" name="age" placeholder="Age" required>
                        </div>
                        <div class="row-2-col">
                            <select name="sex" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                            <input type="date" name="visit_date" value="{{ today.strftime('%Y-%m-%d') }}" required>
                        </div>
                        <input type="text" name="address" placeholder="Address (Optional)">
                    </div>
                    
                    <div class="section-header">
                        <span class="section-title">Symptoms</span>
                        <button type="button" class="add-btn" onclick="addSymptom()">+</button>
                    </div>
                    <div id="symptoms-container">
                        <div class="entry-wrapper symptom-wrapper">
                            <div class="symptom-entry">
                                <div class="symptom-top-row" style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" name="symptom_name[]" placeholder="Symptom Name" style="flex: 3;">
                                    <input type="text" name="duration_text[]" placeholder="Duration" style="flex: 1; min-width: 100px;">
                                    <div style="display: flex; align-items: center; flex: 2; gap: 5px;">
                                        <span style="font-size: 0.8rem; color: #666; white-space: nowrap;">Current:</span>
                                        <input type="range" name="symptom_current[]" min="0" max="10" value="5" style="width: 100%;" oninput="this.nextElementSibling.innerText = this.value">
                                        <span style="min-width: 20px; text-align: right; font-weight: bold;">5</span>
                                    </div>
                                    <button type="button" class="note-btn" onclick="toggleNote(this)" title="Add Note">üìù</button>
                                </div>
                                <div class="symptom-slider-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee;">
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span style="font-size: 0.9rem; color: #666; width: 50px;">Onset</span>
                                        <input type="range" name="symptom_onset[]" min="0" max="10" value="5" style="flex: 1;" oninput="this.nextElementSibling.innerText = this.value">
                                        <span style="font-weight: bold; width: 20px; text-align: right;">5</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span style="font-size: 0.9rem; color: #666; width: 80px;">Progression</span>
                                        <input type="range" name="symptom_progression[]" min="0" max="10" value="5" style="flex: 1;" oninput="this.nextElementSibling.innerText = this.value">
                                        <span style="font-weight: bold; width: 20px; text-align: right;">5</span>
                                    </div>
                                </div>
                                <input type="text" class="note-input" name="symptom_note[]" placeholder="Add symptom notes here...">
                            </div>
                        </div>
                    </div>

                    <div class="section-header">
                        <span class="section-title">Medications</span>
                        <button type="button" class="add-btn" onclick="addMedication()">+</button>
                    </div>
                    <div id="meds-container">
                        <div class="entry-wrapper med-wrapper">
                            <div class="med-row">
                                <select name="drug_type[]">
                                    <option value="Generic">Generic</option>
                                    <option value="Brand">Brand</option>
                                </select>
                                <input type="text" name="drug_name[]" placeholder="Drug Name">
                                <input type="text" name="dose_mg[]" placeholder="Dose">
                                <input type="text" name="med_duration_text[]" placeholder="Duration">
                                <button type="button" class="note-btn" onclick="toggleNote(this)" title="Add Note">üìù</button>
                            </div>
                            <input type="text" class="note-input" name="med_note[]" placeholder="Add medication notes here...">
                        </div>
                    </div>

                    <div class="section-header">
                        <span class="section-title">Side Effects</span>
                        <button type="button" class="add-btn" onclick="addSideEffect()">+</button>
                    </div>
                    <div id="side-effects-container">
                        <div class="entry-wrapper side-effect-wrapper">
                            <div class="side-effect-row" style="display: flex; gap: 15px; align-items: center;">
                                <input type="text" name="side_effect_name[]" placeholder="Side Effect Name" style="flex: 2;">
                                <div style="display: flex; align-items: center; flex: 1; gap: 5px;">
                                    <span style="font-size: 0.8rem; color: #666;">Severity:</span>
                                    <input type="range" name="side_effect_score[]" min="0" max="10" value="3" style="width: 100%;" oninput="this.nextElementSibling.innerText = this.value">
                                    <span style="font-weight: bold; width: 20px; text-align: right;">3</span>
                                </div>
                                <button type="button" class="note-btn" onclick="toggleNote(this)" title="Add Note">üìù</button>
                            </div>
                            <input type="text" class="note-input" name="side_effect_note[]" placeholder="Add side effect notes here...">
                        </div>
                    </div>
                    
                    <div class="section-header">
                        <span class="section-title">MSE Findings</span>
                    </div>
                    <div class="entry-wrapper mse-wrapper">
                        <div class="mse-row">
                            <div class="mse-label">Thought</div>
                            <input type="hidden" name="mse_category[]" value="Thought">
                            <input type="text" name="mse_finding_name[]" placeholder="Finding" style="flex: 2;">
                            <input type="text" name="mse_duration[]" placeholder="Duration" style="width: 150px;">
                            <input type="range" name="mse_score[]" min="0" max="10" value="5" style="flex: 1;" oninput="this.nextElementSibling.innerText = this.value">
							<span style="min-width:30px; text-align:right;font-weight: bold;">5</span>
                            <button type="button" class="note-btn" onclick="toggleNote(this)" title="Add Note">üìù</button>
                        </div>
                        <input type="text" class="note-input" name="mse_note[]" placeholder="Add note for thought...">
                    </div>
                    <div class="entry-wrapper mse-wrapper">
                        <div class="mse-row">
                            <div class="mse-label">Perception</div>
                            <input type="hidden" name="mse_category[]" value="Perception">
                            <input type="text" name="mse_finding_name[]" placeholder="Finding" style="flex: 2;">
                            <input type="text" name="mse_duration[]" placeholder="Duration" style="width: 150px;">
                            <input type="range" name="mse_score[]" min="0" max="10" value="5" style="flex: 1;" oninput="this.nextElementSibling.innerText = this.value">
							<span style="min-width:30px; text-align:right;font-weight: bold;">5</span>
                            <button type="button" class="note-btn" onclick="toggleNote(this)" title="Add Note">üìù</button>
                        </div>
                        <input type="text" class="note-input" name="mse_note[]" placeholder="Add note for perception...">
                    </div>
                    <div class="entry-wrapper mse-wrapper">
                        <div class="mse-row">
                            <div class="mse-label">Affect</div>
                            <input type="hidden" name="mse_category[]" value="Affect">
                            <input type="text" name="mse_finding_name[]" placeholder="Finding" style="flex: 2;">
                            <input type="text" name="mse_duration[]" placeholder="Duration" style="width: 150px;">
                            <input type="range" name="mse_score[]" min="0" max="10" value="5" style="flex: 1;" oninput="this.nextElementSibling.innerText = this.value">
							<span style="min-width:30px; text-align:right;font-weight: bold;">5</span>
                            <button type="button" class="note-btn" onclick="toggleNote(this)" title="Add Note">üìù</button>
                        </div>
                        <input type="text" class="note-input" name="mse_note[]" placeholder="Add note for affect...">
                    </div>

                    <div style="margin-top: 30px;" class="entry-wrapper diagnosis-section">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <h3 style="font-size: 1rem; margin: 0;">Diagnosis</h3>
                            <button type="button" class="note-btn" onclick="toggleNote(this)" title="Add General Visit Note">üìù</button>
                        </div>
                        <textarea class="note-input" name="notes" placeholder="General visit notes..." style="margin-bottom: 15px;"></textarea>
                        
                        <textarea name="provisional_diagnosis" rows="3" placeholder="Provisional Diagnosis"></textarea>
                        <textarea name="differential_diagnosis" rows="3" placeholder="Differential Diagnosis" style="margin-top: 10px;"></textarea>
                    </div>

                    <input type="hidden" name="workflow" id="workflow_input">

                    <div style="display: flex; gap: 15px; margin-top: 30px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
						<button type="button" onclick="openDoctorModal('prescription')" class="btn" style="flex: 1; background: linear-gradient(135deg, #A5DCFE 0%, #7BC4F0 100%); color: #000;">üíä Generate Prescription</button>
						<button type="button" onclick="submitLifeChart()" class="btn" style="flex: 1; background: linear-gradient(135deg, #A5DCFE 0%, #7BC4F0 100%); color: #000;">üìà Generate Life Chart</button>
						<button type="button" onclick="openDoctorModal('both')" class="btn" style="flex: 1; background: linear-gradient(135deg, #A5DCFE 0%, #7BC4F0 100%); color: #000;">üíäüìà Generate Both</button>
					</div>

                    <div id="doctorModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000;">
                        <div style="background:#fff; max-width:450px; margin:5% auto; padding:25px; border-radius:8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            <h3 style="margin-top:0; color:#333;">Doctor Profile (Guest)</h3>
                            <p style="font-size:13px; color:#666; margin-bottom:15px;">Enter details for this session's prescription.</p>
                            
                            <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Full Name</label>
                            <input type="text" name="doctor_name" placeholder="Dr. Name" style="width:100%; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:4px;">
                            
                            <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Clinic Name</label>
                            <input type="text" name="clinic_name" placeholder="PsycheLife" style="width:100%; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:4px;">
                            
							<label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Qualification (e.g. MBBS, MD)</label>
							<input type="text" name="doctor_qualification" placeholder="MBBS, DPM" style="width:100%; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:4px;">

							<label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Registration Code</label>
							<input type="text" name="doctor_registration" placeholder="KMC-12345" style="width:100%; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:4px;">
                    
                            <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Clinic Address</label>
                            <textarea name="clinic_address" placeholder="Full Address..." rows="3" style="width:100%; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:4px; font-family:sans-serif;"></textarea>
                            
                            <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Signature Image (Optional)</label>
                            <input type="file" name="signature_upload" accept="image/*" style="width:100%; margin-bottom:20px; font-size:12px;">
                    
                            <div style="display:flex; justify-content:flex-end; gap:10px;">
                                <button type="button" onclick="document.getElementById('doctorModal').style.display='none'" class="btn" style="background:#ccc; padding:10px 20px;">Cancel</button>
                                <button type="button" onclick="confirmDoctor()" class="btn" style="background:#7ab8e0; padding:10px 20px;">Save & Generate</button>
                            </div>
                        </div>
                    </div>
                    </form>
            </div>
        </main>
    </div>
    <script>
        function toggleNote(btn) {
            const wrapper = btn.closest('.entry-wrapper');
            const input = wrapper.querySelector('.note-input');
            input.style.display = (input.style.display === 'none' || input.style.display === '') ? 'block' : 'none';
        }

        function addSymptom() {
            const container = document.getElementById('symptoms-container');
            const template = container.querySelector('.symptom-wrapper');
            const newRow = template.cloneNode(true);
            newRow.querySelectorAll('input[type="text"]').forEach(i => i.value = '');
            newRow.querySelectorAll('input[type="range"]').forEach(i => i.value = 5);
            const currentSpan = newRow.querySelector('.symptom-top-row span:last-of-type');
            if(currentSpan) currentSpan.innerText = '5';
            newRow.querySelectorAll('.symptom-slider-row span').forEach(s => { if(!isNaN(s.innerText)) s.innerText = '5'; });
            newRow.querySelector('.note-input').style.display = 'none';
            container.appendChild(newRow);
        }

        function addMedication() {
            const container = document.getElementById('meds-container');
            const template = container.querySelector('.med-wrapper');
            const newRow = template.cloneNode(true);
            newRow.querySelectorAll('input[type="text"]').forEach(i => i.value = '');
            newRow.querySelector('.note-input').style.display = 'none';
            container.appendChild(newRow);
        }

        function addSideEffect() {
            const container = document.getElementById('side-effects-container');
            const template = container.querySelector('.side-effect-wrapper');
            const newRow = template.cloneNode(true);
            newRow.querySelectorAll('input[type="text"]').forEach(i => i.value = '');
            newRow.querySelector('input[type="range"]').value = 3;
            const scoreSpan = newRow.querySelector('.side-effect-row span:last-of-type');
            if(scoreSpan) scoreSpan.innerText = '3';
            newRow.querySelector('.note-input').style.display = 'none';
            container.appendChild(newRow);
        }

        // --- DOCTOR MODAL & SUBMISSION LOGIC ---
        let pendingWorkflow = null;

        function openDoctorModal(workflow) {
            pendingWorkflow = workflow;
            document.getElementById('doctorModal').style.display = 'block';
        }

        function confirmDoctor() {
            const form = document.querySelector('form');
            document.getElementById('workflow_input').value = pendingWorkflow;
            
            // ROUTING LOGIC: Change action based on button clicked
            if (pendingWorkflow === 'prescription') {
                form.action = "{{ url_for('guest_prescription') }}";
            } else if (pendingWorkflow === 'both') {
                form.action = "{{ url_for('guest_both') }}";
            } else {
                // Default for 'Generate Life Chart' (handled by dashboard logic)
                form.action = "{{ url_for('dashboard') }}";
            }
            
            form.submit();
        }
		
		function submitLifeChart() {
			const form = document.querySelector('form');
			const hiddenInput = document.getElementById('workflow_input');
			hiddenInput.value = 'lifechart';

			// LOGIC: If Guest, go directly to lifechart to preserve data. 
			// If Logged In, go to dashboard to save to DB first.
			
			{% if session.get('guest') %}
				form.action = "{{ url_for('guest_lifechart') }}";
			{% else %}
				form.action = "{{ url_for('dashboard') }}";
			{% endif %}

			form.submit();
		}
    </script>
</body>
</html>